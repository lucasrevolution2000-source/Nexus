<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Cursos e Treinamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #f5f5f5;
        }
        .nexus-gradient-text {
            background: linear-gradient(90deg, #4f46e5, #c026d3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .glassmorphism {
            background: rgba(23, 23, 23, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 10px;
            border: 2px solid #1a1a1a;
        }
        input, select, textarea {
            background-color: #171717;
            border-color: #404040;
            color-scheme: dark;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
        .btn-primary {
            background-color: #4f46e5;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: transparent;
            border: 1px solid #4f46e5;
            color: #4f46e5;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #4f46e5;
            color: white;
        }
        .btn-danger {
            background-color: #dc2626;
             transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-danger:hover {
             background-color: #b91c1c;
             transform: translateY(-2px);
        }
        .btn-success {
            background-color: #16a34a;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-success:hover {
            background-color: #15803d;
            transform: translateY(-2px);
        }
        .hidden {
            display: none;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 50; /* Aumentado para 50 */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-y: auto; 
            padding: 1rem;
        }
        .modal-content {
            z-index: 51; /* Z-index do conteúdo */
            width: 95%;
            max-width: 600px;
        }
        #modalConfirmacao {
            z-index: 60; /* Garantir que a confirmação fique na frente de todos os outros modais */
        }
        input[type="file"] {
             color: #9ca3af;
        }
        input[type="file"]::file-selector-button {
            margin-right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border-width: 0px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            font-weight: 600;
            background-color: #eef2ff;
            color: #4338ca;
            cursor: pointer;
        }
         input[type="file"]::file-selector-button:hover {
            background-color: #e0e7ff;
         }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .aula-item.active {
            background-color: rgba(79, 70, 229, 0.3);
            border-color: #4f46e5;
        }
        .page-break {
            page-break-after: always;
        }
        .password-container {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9ca3af;
        }
        .toggle-password:hover {
            color: #e5e7eb;
        }
        .image-soft-edges {
            -webkit-mask-image: radial-gradient(ellipse, black 70%, transparent 100%);
            mask-image: radial-gradient(ellipse, black 70%, transparent 100%);
        }
        .logo-parceiro {
            transition: transform 0.3s ease;
        }
        .logo-parceiro:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="antialiased min-h-screen">

    <main class="py-10">
        <!-- Container Principal que troca as telas -->
        <div id="app" class="container mx-auto px-4">

            <!-- TELA INICIAL -->
            <section id="telaInicial" class="">
                <!-- Header -->
                <div class="mb-10 flex flex-col items-center gap-6">
                    <!-- Logo Centralizada -->
                    <div>
                        <img src="https://gcyxfecmaqnbhdnxaajs.supabase.co/storage/v1/object/public/Logo/logo%20final.png" alt="Logo Nexus Cursos" class="h-44 md:h-56">
                    </div>
                     <!-- Botões de Login -->
                    <div class="flex items-center gap-4">
                        <button onclick="window.mostrarTela('telaLoginAluno')" class="btn-secondary text-lg px-5 py-3 rounded-lg"><i class="fas fa-user-graduate mr-2"></i>Aluno</button>
                        <button onclick="window.mostrarTela('telaLoginMinistrante')" class="btn-secondary text-lg px-5 py-3 rounded-lg"><i class="fas fa-chalkboard-teacher mr-2"></i>Ministrante</button>
                        <button onclick="window.mostrarTela('telaLoginAdmin')" class="btn-secondary text-lg px-5 py-3 rounded-lg"><i class="fas fa-user-shield mr-2"></i>Admin</button>
                    </div>
                </div>

                <!-- Cursos Disponíveis -->
                <h2 class="text-2xl font-semibold mb-6 border-l-4 border-indigo-500 pl-4">Cursos Disponíveis</h2>
                <div class="mb-6 flex flex-col sm:flex-row gap-4">
                    <input type="text" id="buscaCursoInicial" onkeyup="renderizarCursos('listaCursosInicial', this.value)" placeholder="Buscar curso pelo nome..." class="w-full p-3 rounded-lg border-2">
                    <button onclick="renderizarCursos('listaCursosInicial', document.getElementById('buscaCursoInicial').value)" class="btn-primary p-3 rounded-lg"><i class="fas fa-search"></i></button>
                </div>
                <div id="listaCursosInicial" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards de curso serão inseridos aqui pelo JS -->
                </div>

                <!-- Validação de Certificado -->
                <div class="mt-16 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-6 text-center border-b-2 border-indigo-500 pb-2">Validação de Certificado</h2>
                    <div class="glassmorphism p-8 rounded-xl shadow-lg">
                        <p class="text-center text-neutral-300 mb-4">Insira o código de validação para verificar e reimprimir um certificado.</p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="codigoValidacao" placeholder="Código de Validação" class="w-full px-4 py-2 rounded-lg border-2 focus:ring-0">
                            <button onclick="validarCertificadoPeloCodigo()" class="btn-primary px-6 py-2 rounded-lg font-semibold whitespace-nowrap">Validar</button>
                        </div>
                    </div>
                </div>

                <!-- Princípios da Empresa -->
                <div class="mt-16">
                    <h2 class="text-2xl font-semibold mb-6 text-center border-b-2 border-indigo-500 pb-2">Nosso diferencial</h2>
                    <div class="glassmorphism rounded-xl p-6 lg:p-8 flex flex-col lg:flex-row items-center gap-8">
                        <div class="lg:w-1/2 order-2 lg:order-2">
                            <div class="container mx-auto flex flex-col items-center justify-center gap-4 text-center">
                                <!-- Princípios Acima -->
                                <div class="flex flex-wrap items-center justify-center gap-4 text-sm">
                                    <span><i class="fas fa-video mr-2 text-indigo-400"></i>Aulas ao vivo</span>
                                    <span><i class="fas fa-comments mr-2 text-indigo-400"></i>Interação entre professores e estudantes</span>
                                    <span><i class="fas fa-user-tie mr-2 text-indigo-400"></i>Professores e profissionais especialistas, mestres ou doutores</span>
                                    <span><i class="fas fa-book-open mr-2 text-indigo-400"></i>Materiais de Qualidade</span>
                                    <span><i class="fas fa-cogs mr-2 text-indigo-400"></i>Aplicação da teoria na prática</span>
                                </div>
                
                                <!-- Título Central -->
                                <span class="w-full text-3xl font-bold my-4 nexus-gradient-text"><i class="fas fa-check-double mr-2"></i>Treinamento de Elite</span>
                
                                <!-- Princípios Abaixo -->
                                <div class="flex flex-wrap items-center justify-center gap-4 text-sm">
                                    <span><i class="fas fa-rocket mr-2 text-indigo-400"></i>Sem Enrolação</span>
                                    <span><i class="fas fa-clipboard-check mr-2 text-indigo-400"></i>Controle rigoroso de frequência</span>
                                    <span><i class="fas fa-certificate mr-2 text-indigo-400"></i>Validação de Certificado</span>
                                    <span><i class="fas fa-save mr-2 text-indigo-400"></i>Espaço para salvar seus resumos</span>
                                    <span><i class="fas fa-building mr-2 text-indigo-400"></i>Vinculação de alunos a uma Empresa</span>
                                </div>
                            </div>
                        </div>
                        <div class="lg:w-1/2 order-1 lg:order-1 text-center">
                            <img src="https://gcyxfecmaqnbhdnxaajs.supabase.co/storage/v1/object/public/Foto%20te%20tela%20inicial/teste%201.jpg" alt="Diretora Executiva da Nexus" class="image-soft-edges w-full h-auto object-contain max-h-80">
                             <p class="mt-2 text-lg text-white font-bold">Jaqueline</p>
                             <p class="text-sm text-neutral-300 font-semibold">Diretora Executiva da Nexus</p>
                        </div>
                    </div>
                </div>

                <!-- Parceiros -->
                <div class="mt-16">
                    <h2 class="text-2xl font-semibold mb-8 text-center border-b-2 border-indigo-500 pb-2">Nossos Parceiros</h2>
                    <div id="parceirosContainer" class="flex flex-wrap justify-center items-center gap-x-12 gap-y-8">
                        <!-- Logos dos parceiros serão inseridos aqui -->
                    </div>
                </div>
            </section>

            <!-- TELA LOGIN ALUNO -->
            <section id="telaLoginAluno" class="hidden max-w-md mx-auto">
                <div class="glassmorphism p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 nexus-gradient-text">Área do Aluno</h2>
                    <div class="space-y-4">
                        <input type="email" id="loginEmailAluno" placeholder="Email" class="w-full p-3 rounded-lg border-2">
                        <div class="password-container">
                            <input type="password" id="loginSenhaAluno" placeholder="Senha" class="w-full p-3 rounded-lg border-2">
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility(this)"></i>
                        </div>
                        <button onclick="loginAluno()" class="w-full btn-primary font-bold p-3 rounded-lg">Entrar</button>
                        <p class="text-center text-neutral-300">Não tem uma conta? <a href="#" onclick="window.mostrarTela('telaCadastroAluno')" class="font-semibold text-indigo-400 hover:underline">Cadastre-se</a></p>
                    </div>
                    <button onclick="window.mostrarTela('telaInicial')" class="mt-6 text-sm text-indigo-400 hover:underline w-full text-center">Voltar para o início</button>
                </div>
            </section>

            <!-- TELA CADASTRO ALUNO -->
            <section id="telaCadastroAluno" class="hidden max-w-2xl mx-auto">
                 <div class="glassmorphism p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 nexus-gradient-text">Cadastro de Aluno</h2>
                    <form id="formCadastroAluno" onsubmit="cadastrarAluno(event)" class="space-y-4">
                        <input type="text" name="nomeCompleto" placeholder="Nome Completo" required class="w-full p-3 rounded-lg border-2">
                        <input type="text" name="cpf" placeholder="CPF" required class="w-full p-3 rounded-lg border-2">
                        <!-- REMOVIDO: input CEP -->
                        <input type="text" name="whatsapp" placeholder="WhatsApp" required class="w-full p-3 rounded-lg border-2">
                        <input type="text" name="instagram" placeholder="@ do Instagram" required class="w-full p-3 rounded-lg border-2">
                        <div class="flex items-center gap-2">
                             <input type="text" name="cnpjEmpresa" placeholder="Vincular-se ao CNPJ de uma empresa" class="w-full p-3 rounded-lg border-2">
                             <span class="text-sm text-neutral-400 whitespace-nowrap">(Opcional)</span>
                        </div>
                        <!-- REMOVIDO: input Data de Nascimento -->
                        <!-- REMOVIDO: Área de Chave PIX para Reembolso -->
                        <div class="border border-neutral-600 p-3 rounded-lg">
                             <label for="fotoPerfilAluno" class="block mb-2 text-sm font-medium text-neutral-300">Foto de Perfil</label>
                             <input type="file" name="fotoPerfil" id="fotoPerfilAluno" accept="image/*">
                        </div>
                        <img id="previewFotoAluno" class="hidden w-24 h-24 rounded-full mx-auto object-cover">
                        <input type="email" name="email" placeholder="Email" required class="w-full p-3 rounded-lg border-2">
                        <div class="password-container">
                            <input type="password" name="senha" placeholder="Senha" required class="w-full p-3 rounded-lg border-2">
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility(this)"></i>
                        </div>
                        <button type="submit" class="w-full btn-primary font-bold p-3 rounded-lg">Cadastrar</button>
                    </form>
                    <p class="text-xs text-neutral-400 mt-4 text-center">
                        Ao se cadastrar, você concorda com nossos Termos de Serviço e Política de Privacidade. Seus dados serão tratados com segurança e em conformidade com a Lei Geral de Proteção de Dados (Lei nº 13.709/2018).
                    </p>
                    <p class="text-center text-neutral-300 mt-4">Já tem uma conta? <a href="#" onclick="window.mostrarTela('telaLoginAluno')" class="font-semibold text-indigo-400 hover:underline">Faça Login</a></p>
                    <button onclick="window.mostrarTela('telaInicial')" class="mt-6 text-sm text-indigo-400 hover:underline w-full text-center">Voltar para o início</button>
                </div>
            </section>
            
            <!-- TELA LOGIN MINISTRANTE -->
            <section id="telaLoginMinistrante" class="hidden max-w-md mx-auto">
                 <div class="glassmorphism p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 nexus-gradient-text">Área do Ministrante</h2>
                    <div class="space-y-4">
                        <input type="email" id="loginEmailMinistrante" placeholder="Email" class="w-full p-3 rounded-lg border-2">
                        <div class="password-container">
                           <input type="password" id="loginSenhaMinistrante" placeholder="Senha" class="w-full p-3 rounded-lg border-2">
                           <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility(this)"></i>
                        </div>
                        <button onclick="loginMinistrante()" class="w-full btn-primary font-bold p-3 rounded-lg">Entrar</button>
                        <p class="text-center text-neutral-300">Não tem uma conta? <a href="#" onclick="window.mostrarTela('telaCadastroMinistrante')" class="font-semibold text-indigo-400 hover:underline">Cadastre-se</a></p>
                    </div>
                    <button onclick="window.mostrarTela('telaInicial')" class="mt-6 text-sm text-indigo-400 hover:underline w-full text-center">Voltar para o início</button>
                </div>
            </section>

             <!-- TELA CADASTRO MINISTRANTE -->
            <section id="telaCadastroMinistrante" class="hidden max-w-2xl mx-auto">
                 <div class="glassmorphism p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 nexus-gradient-text">Cadastro de Ministrante</h2>
                    <form id="formCadastroMinistrante" onsubmit="cadastrarMinistrante(event)" class="space-y-4">
                        <input type="text" name="nomeCompleto" placeholder="Nome completo ou Razão Social no caso de empresa" required class="w-full p-3 rounded-lg border-2">
                        <input type="text" name="cpfCnpj" placeholder="CPF ou CNPJ no caso de empresa" required class="w-full p-3 rounded-lg border-2">
                        <input type="text" name="rg" placeholder="RG (somente para pessoa física)" class="w-full p-3 rounded-lg border-2">
                        <div class="border border-neutral-600 p-3 rounded-lg space-y-3">
                            <label class="block -mb-2 text-sm font-medium text-neutral-300">Endereço</label>
                            <input type="text" name="cep" placeholder="CEP" required class="w-full p-3 rounded-lg border-2">
                            <input type="text" name="rua" placeholder="Rua" required class="w-full p-3 rounded-lg border-2">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="text" name="numero" placeholder="Número" required class="w-full p-3 rounded-lg border-2">
                                <input type="text" name="bairro" placeholder="Bairro" required class="w-full p-3 rounded-lg border-2">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="text" name="cidade" placeholder="Cidade" required class="w-full p-3 rounded-lg border-2">
                                <input type="text" name="estado" placeholder="Estado" required class="w-full p-3 rounded-lg border-2">
                            </div>
                        </div>
                        <div class="border border-neutral-600 p-3 rounded-lg space-y-3">
                            <label class="block -mb-2 text-sm font-medium text-neutral-300">Formação Acadêmica</label>
                            <input type="text" name="graduadoEm" placeholder="Graduado em:" class="w-full p-3 rounded-lg border-2">
                            <input type="text" name="especialistaEm" placeholder="Especialista em:" class="w-full p-3 rounded-lg border-2">
                            <input type="text" name="mestreEm" placeholder="Mestre em:" class="w-full p-3 rounded-lg border-2">
                            <input type="text" name="doutorEm" placeholder="Doutor em:" class="w-full p-3 rounded-lg border-2">
                            <input type="text" name="posDoutorEm" placeholder="Pós-doutor em:" class="w-full p-3 rounded-lg border-2">
                        </div>
                        <input type="text" name="whatsapp" placeholder="WhatsApp" required class="w-full p-3 rounded-lg border-2">
                        <input type="text" name="instagram" placeholder="@ do Instagram" required class="w-full p-3 rounded-lg border-2">
                         <div class="border border-neutral-600 p-3 rounded-lg">
                            <label class="block mb-2 text-sm font-medium text-neutral-300">Chave PIX para Pagamento</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                               <select name="tipoPix" required class="p-3 rounded-lg border-2">
                                    <option value="email">Email</option>
                                    <option value="cpf">CPF</option>
                                    <option value="cnpj">CNPJ</option>
                                    <option value="celular">Celular</option>
                                </select>
                                <input type="text" name="chavePix" placeholder="Chave PIX" required class="w-full p-3 rounded-lg border-2">
                            </div>
                        </div>
                        <div class="border border-neutral-600 p-3 rounded-lg">
                             <label for="fotoPerfilMinistrante" class="block mb-2 text-sm font-medium text-neutral-300">Sua Foto</label>
                             <input type="file" name="fotoPerfil" id="fotoPerfilMinistrante" accept="image/*" required>
                        </div>
                        <img id="previewFotoMinistrante" class="hidden w-24 h-24 rounded-full mx-auto object-cover">
                        <input type="email" name="email" placeholder="Email" required class="w-full p-3 rounded-lg border-2">
                        <div class="password-container">
                            <input type="password" name="senha" placeholder="Senha" required class="w-full p-3 rounded-lg border-2">
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility(this)"></i>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="aceiteDivulgacao" name="aceiteDivulgacao" required class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="aceiteDivulgacao" class="text-sm text-neutral-300">Aceito a divulgação da minha imagem.</label>
                        </div>
                        <button type="submit" class="w-full btn-primary font-bold p-3 rounded-lg">Cadastrar</button>
                    </form>
                    <p class="text-xs text-neutral-400 mt-4 text-center">
                        Ao se cadastrar, você concorda com nossos Termos de Serviço e Política de Privacidade. Seus dados serão tratados com segurança e em conformidade com a Lei Geral de Proteção de Dados (Lei nº 13.709/2018).
                    </p>
                    <p class="text-center text-neutral-300 mt-4">Já tem uma conta? <a href="#" onclick="window.mostrarTela('telaLoginMinistrante')" class="font-semibold text-indigo-400 hover:underline">Faça Login</a></p>
                    <button onclick="window.mostrarTela('telaInicial')" class="mt-6 text-sm text-indigo-400 hover:underline w-full text-center">Voltar para o início</button>
                </div>
            </section>
            
            <!-- TELA LOGIN ADMIN -->
            <section id="telaLoginAdmin" class="hidden max-w-md mx-auto">
                 <div class="glassmorphism p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 nexus-gradient-text">Área do Administrador</h2>
                    <div class="space-y-4">
                        <input type="email" id="loginEmailAdmin" placeholder="Email" class="w-full p-3 rounded-lg border-2">
                        <div class="password-container">
                            <input type="password" id="loginSenhaAdmin" placeholder="Senha" class="w-full p-3 rounded-lg border-2">
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility(this)"></i>
                        </div>
                        <button onclick="loginAdmin()" class="w-full btn-primary font-bold p-3 rounded-lg">Entrar</button>
                    </div>
                    <button onclick="window.mostrarTela('telaInicial')" class="mt-6 text-sm text-indigo-400 hover:underline w-full text-center">Voltar para o início</button>
                </div>
            </section>

            <!-- PAINEL DO ALUNO -->
            <section id="painelAluno" class="hidden">
                 <!-- Header do Painel -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
                    <div>
                        <h2 id="boasVindasAluno" class="text-2xl md:text-3xl font-bold text-white"></h2>
                        <p id="subtituloAluno" class="text-neutral-300"></p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="logout()" class="btn-secondary px-4 py-2 rounded-lg font-semibold"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
                    </div>
                </div>

                <!-- Abas de Navegação -->
                <div class="mb-6 border-b border-neutral-700">
                    <nav class="flex space-x-8" aria-label="Tabs">
                        <a href="#" onclick="mudarAbaPainelAluno('cursosDisponiveis')" id="aba-cursosDisponiveis" class="tab-aluno border-indigo-500 text-indigo-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Cursos Disponíveis</a>
                        <a href="#" onclick="mudarAbaPainelAluno('meusCursos')" id="aba-meusCursos" class="tab-aluno border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Meus Cursos</a>
                        <a href="#" onclick="mudarAbaPainelAluno('meuPerfil')" id="aba-meuPerfil" class="tab-aluno border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Meu Perfil</a>
                    </nav>
                </div>

                <!-- Conteúdo das Abas -->
                <div id="conteudoAbaAluno">
                    <div id="abaConteudo-cursosDisponiveis">
                        <div class="mb-6 flex flex-col sm:flex-row gap-4">
                             <input type="text" id="buscaCursoAluno" onkeyup="renderizarCursosPainelAluno()" placeholder="Buscar curso pelo nome..." class="w-full p-3 rounded-lg border-2">
                             <button class="btn-primary p-3 rounded-lg"><i class="fas fa-search"></i></button>
                        </div>
                        <div id="listaCursosPainelAluno" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                    <div id="abaConteudo-meusCursos" class="hidden">
                        <h3 class="text-xl font-semibold mb-4">Cursos Matriculados</h3>
                        <div id="listaMeusCursos" class="space-y-4"></div>
                    </div>
                    <div id="abaConteudo-meuPerfil" class="hidden max-w-2xl mx-auto"></div>
                </div>
            </section>
            
             <!-- PAINEL DO MINISTRANTE -->
            <section id="painelMinistrante" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
                    <div>
                        <h2 id="boasVindasMinistrante" class="text-2xl md:text-3xl font-bold text-white"></h2>
                        <p class="text-neutral-300">Gerencie seus cursos e interaja com seus alunos.</p>
                    </div>
                     <div class="flex items-center gap-4">
                        <button onclick="logout()" class="btn-secondary px-4 py-2 rounded-lg font-semibold"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
                    </div>
                </div>
                <div class="mb-6 border-b border-neutral-700">
                    <nav class="flex space-x-8" aria-label="Tabs">
                        <a href="#" onclick="mudarAbaPainelMinistrante('meusCursosMinistrante')" id="aba-meusCursosMinistrante" class="tab-ministrante border-indigo-500 text-indigo-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Meus Cursos</a>
                        <a href="#" onclick="mudarAbaPainelMinistrante('contratoMinistrante')" id="aba-contratoMinistrante" class="tab-ministrante border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Contrato</a>
                        <a href="#" onclick="mudarAbaPainelMinistrante('perfilMinistrante')" id="aba-perfilMinistrante" class="tab-ministrante border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Meu Perfil</a>
                    </nav>
                </div>
                <div id="conteudoAbaMinistrante">
                    <div id="abaConteudo-meusCursosMinistrante">
                        <div id="listaCursosMinistrante" class="space-y-6"></div>
                    </div>
                    <div id="abaConteudo-contratoMinistrante" class="hidden">
                        <div class="glassmorphism p-8 rounded-xl max-w-2xl mx-auto text-center">
                            <h3 class="text-xl font-bold mb-4">Gestão de Contrato</h3>
                            <p class="text-neutral-300 mb-2">Este espaço é reservado para o download do contrato de prestação de serviço enviado pelo administrador e para o upload do mesmo assinado via GOV.BR.</p>
                            <p class="text-sm text-yellow-400 mb-6">É importante ressaltar que a relação estabelecida é de prestação de serviço, não configurando vínculo empregatício.</p>
                            <div id="areaContratoMinistrante" class="space-y-4"></div>
                        </div>
                    </div>
                    <div id="abaConteudo-perfilMinistrante" class="hidden max-w-2xl mx-auto"></div>
                </div>
            </section>

            <!-- PAINEL DO ADMINISTRADOR -->
            <section id="painelAdmin" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold text-white">Painel Administrativo</h2>
                        <p class="text-neutral-300">Gerenciamento completo da plataforma Nexus.</p>
                    </div>
                    <button onclick="logout()" class="btn-secondary px-4 py-2 rounded-lg font-semibold"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
                </div>
                <div class="mb-6 border-b border-neutral-700">
                    <nav class="flex flex-wrap -mb-px space-x-8" aria-label="Tabs">
                        <a href="#" onclick="mudarAbaPainelAdmin('gerenciarCursos')" id="aba-gerenciarCursos" class="tab-admin border-indigo-500 text-indigo-400 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Cursos</a>
                        <a href="#" onclick="mudarAbaPainelAdmin('gerenciarAprovacoes')" id="aba-gerenciarAprovacoes" class="tab-admin border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Aprovações</a>
                        <!-- REMOVIDO: Aba Reembolsos -->
                        <a href="#" onclick="mudarAbaPainelAdmin('gerenciarCertificados')" id="aba-gerenciarCertificados" class="tab-admin border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Certificados</a>
                        <a href="#" onclick="mudarAbaPainelAdmin('gerenciarAlunos')" id="aba-gerenciarAlunos" class="tab-admin border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Alunos</a>
                        <a href="#" onclick="mudarAbaPainelAdmin('gerenciarMinistrantes')" id="aba-gerenciarMinistrantes" class="tab-admin border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Ministrantes</a>
                        <a href="#" onclick="mudarAbaPainelAdmin('gerenciarEmpresas')" id="aba-gerenciarEmpresas" class="tab-admin border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Empresas</a>
                        <a href="#" onclick="mudarAbaPainelAdmin('gerenciarParceiros')" id="aba-gerenciarParceiros" class="tab-admin border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Parceiros</a>
                    </nav>
                </div>
                <div id="conteudoAbaAdmin">
                    <div id="abaConteudo-gerenciarCursos" class="">
                        <div class="flex justify-end mb-4">
                            <button onclick="abrirModalCurso()" class="btn-primary font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Cadastrar Curso</button>
                        </div>
                        <div id="listaCursosAdmin" class="space-y-4"></div>
                    </div>
                    <div id="abaConteudo-gerenciarAprovacoes" class="hidden">
                         <div id="listaAprovacoesAdmin" class="space-y-4"></div>
                    </div>
                     <div id="abaConteudo-gerenciarReembolsos" class="hidden">
                         <div id="listaReembolsosAdmin" class="space-y-4"></div>
                    </div>
                    <div id="abaConteudo-gerenciarCertificados" class="hidden">
                         <div id="listaCursosCertificados" class="space-y-6"></div>
                    </div>
                    <div id="abaConteudo-gerenciarAlunos" class="hidden">
                        <div id="listaAlunosAdmin" class="space-y-4"></div>
                    </div>
                    <div id="abaConteudo-gerenciarMinistrantes" class="hidden">
                        <div class="mb-4">
                            <input type="text" id="buscaMinistrante" onkeyup="renderizarPainelAdminMinistrantes()" placeholder="Buscar por nome ou titulação..." class="w-full p-3 rounded-lg border-2">
                        </div>
                         <div id="listaMinistrantesAdmin" class="space-y-4"></div>
                    </div>
                    <div id="abaConteudo-gerenciarEmpresas" class="hidden">
                         <div id="listaEmpresasAdmin" class="space-y-4"></div>
                    </div>
                    <div id="abaConteudo-gerenciarParceiros" class="hidden">
                        <div class="glassmorphism p-6 rounded-xl">
                            <h3 class="text-xl font-bold mb-4">Adicionar Novo Parceiro</h3>
                            <form id="formParceiro" onsubmit="salvarParceiro(event)" class="flex flex-col sm:flex-row items-center gap-4">
                                <input type="text" name="nome" placeholder="Nome do Parceiro" required class="w-full p-3 rounded-lg border-2">
                                <input type="file" name="logo" required accept="image/*" class="w-full">
                                <button type="submit" class="btn-primary font-bold py-3 px-6 rounded-lg whitespace-nowrap">Adicionar</button>
                            </form>
                        </div>
                        <div class="mt-8">
                            <h3 class="text-xl font-bold mb-4">Parceiros Atuais</h3>
                            <div id="listaParceirosAdmin" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                <!-- Lista de parceiros -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

             <!-- TELA DE PAGAMENTO -->
            <section id="telaPagamento" class="hidden max-w-lg mx-auto">
                 <div class="glassmorphism p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-2">Pagamento do Curso</h2>
                    <p id="nomeCursoPagamento" class="text-center text-indigo-400 font-semibold mb-6"></p>
                    <p id="precoCursoPagamento" class="text-center text-white font-bold text-3xl mb-4"></p>
                    
                    <div class="text-center space-y-4">
                        
                        <!-- REMOVIDO TEXTO: Selecione o link de pagamento ou insira seu código de cupom para liberar a opção de pagamento. -->

                        <!-- Área de Cupom -->
                        <div id="cupomArea" class="bg-neutral-800 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-white mb-2"><i class="fas fa-tag mr-2 text-indigo-400"></i>Cupom de Desconto (Opcional)</h3>
                            <div class="flex gap-2">
                                <input type="text" id="inputCupom" oninput="window.verificarCupomEExibirPagamento(estado.cursoSelecionadoId)" placeholder="CÓDIGO DO CUPOM (se tiver)" class="w-full p-3 rounded-lg border-2 bg-neutral-700 uppercase">
                            </div>
                            <p id="statusCupom" class="text-sm mt-2 text-neutral-400">O preço normal está disponível abaixo. Insira um cupom para um desconto.</p>
                        </div>
                        <!-- Fim Área de Cupom -->

                        <!-- Opções de Pagamento - Inicialmente apenas o preço normal é exibido -->
                        <div id="opcoesPagamento" class="space-y-4">
                             <!-- Links de Pagamento Serão Injetados Aqui pela função verificarCupomEExibirPagamento -->
                             
                        </div>
                        
                        <!-- Opção Pague Aqui (Comprovante) - SEMPRE VISÍVEL -->
                        <div id="pagamentoComprovanteArea" class="bg-neutral-800 p-4 rounded-lg"> 
                            <h3 class="text-lg font-semibold text-white mb-2">Pague Aqui e Envie o Comprovante</h3>
                            
                            <div id="linkPagamentoContainer" class="my-4 space-y-3">
                                <!-- Botão "Pague Aqui" será injetado aqui pela função verificarCupomEExibirPagamento -->
                            </div>

                            <p class="text-sm text-neutral-300 mb-4">1. Clique no botão de pagamento liberado acima para realizar a transação.</p>

                            <div class="border-t border-neutral-700 pt-4 mt-4">
                                <label for="comprovantePagamento" class="block mb-2 text-sm font-medium text-neutral-300">2. Anexe o Comprovante de Pagamento (Obrigatório)</label>
                                <input type="file" id="comprovantePagamento" accept="image/*,application/pdf" required>
                                <img id="previewComprovante" class="hidden w-full max-w-xs rounded-lg mx-auto mt-4 object-cover">
                            </div>
                            
                            <!-- REMOVIDO: ANEXO DE COMPROVANTE DE CUPOM -->
                            
                            <p class="text-xs text-yellow-400 mt-4">Sua vaga será confirmada após a aprovação do comprovante pelo administrador.</p>
                            <button onclick="enviarComprovante('pagueaqui')" class="w-full btn-primary font-bold p-3 rounded-lg mt-2">Enviar Comprovantes</button>
                        </div>
                    </div>
                     <button onclick="window.mostrarTelaAnterior()" class="mt-6 text-sm text-indigo-400 hover:underline w-full text-center">Voltar</button>
                 </div>
            </section>

            <!-- TELA DE ACESSO AO CURSO -->
            <section id="telaCurso" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="tituloTelaCurso" class="text-2xl md:text-3xl font-bold text-white"></h2>
                    <div id="botoesVoltarCurso"></div>
                </div>
                <div class="w-full">
                    <div id="videoContainer" class="aspect-video bg-black rounded-lg overflow-hidden mb-6 shadow-lg"></div>
                    
                    <div id="infoContainer" class="glassmorphism rounded-lg p-4 md:p-6">
                         <div class="mb-4 border-b border-neutral-700">
                            <nav id="infoAbas" class="flex flex-wrap space-x-4 md:space-x-6" aria-label="Tabs"></nav>
                        </div>
                        <div id="infoConteudoAba">
                            <!-- Conteúdo das abas será injetado aqui -->
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <!-- MODAIS -->
    <div id="modalCarregamento" class="hidden modal-backdrop" style="background-color: rgba(0, 0, 0, 0.9); z-index: 100;">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-indigo-400"></i>
            <p class="mt-4 text-lg text-white">A carregar...</p>
        </div>
    </div>
    <div id="modalNotificacao" class="hidden modal-backdrop"><div class="modal-content max-w-lg glassmorphism p-6 rounded-xl shadow-lg text-center"><p id="mensagemModal" class="mb-4 text-lg whitespace-pre-wrap"></p><button onclick="window.fecharModal('modalNotificacao')" class="btn-primary px-6 py-2 rounded-lg">OK</button></div></div>
    <div id="modalConfirmacao" class="hidden modal-backdrop"><div class="modal-content max-w-sm glassmorphism p-6 rounded-xl shadow-lg text-center"><p id="mensagemConfirmacao" class="mb-6 text-lg">Você tem certeza?</p><div class="flex justify-center gap-4"><button id="btnCancelarConfirmacao" onclick="window.fecharModal('modalConfirmacao')" class="btn-secondary px-6 py-2 rounded-lg">Cancelar</button><button id="btnConfirmarAcao" class="btn-danger px-6 py-2 rounded-lg text-white font-semibold">Confirmar</button></div></div></div>
    <div id="modalDetalhes" class="hidden modal-backdrop"><div id="conteudoModalDetalhes" class="modal-content glassmorphism p-6 rounded-xl shadow-lg max-h-[80vh] overflow-y-auto custom-scrollbar"></div></div>
    <div id="modalImagem" class="hidden modal-backdrop">
        <div class="relative">
             <img id="imagemAmpliada" src="" class="max-w-[90vw] max-h-[85vh] object-contain rounded-lg">
             <button onclick="window.fecharModal('modalImagem')" class="absolute -top-2 -right-2 bg-black/70 text-white rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold z-10">&times;</button>
        </div>
    </div>
    <div id="modalCurso" class="hidden modal-backdrop">
        <div class="modal-content glassmorphism p-6 rounded-xl shadow-lg">
             <h2 id="tituloModalCurso" class="text-2xl font-bold mb-6 nexus-gradient-text">Cadastrar Novo Curso</h2>
             <form id="formCurso" onsubmit="salvarCurso(event)" class="space-y-4 max-h-[70vh] overflow-y-auto custom-scrollbar pr-4">
                <input type="hidden" name="id">
                <input type="text" name="nomeDoCurso" placeholder="Nome do Curso" required class="w-full p-3 rounded-lg border-2">
                
                <div id="aulasContainer" class="space-y-4">
                    <!-- Aulas serão inseridas aqui dinamicamente -->
                </div>
                <button type="button" onclick="adicionarAulaBlock()" class="btn-secondary text-sm px-3 py-2 rounded-lg"><i class="fas fa-plus mr-2"></i>Adicionar Aula</button>
                
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block mb-2 text-sm font-medium text-neutral-300">Preço (R$)</label>
                        <input type="text" name="preco" placeholder="Ex: 497,00" required class="w-full p-3 rounded-lg border-2">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-neutral-300">Cota Mínima de Alunos</label>
                        <input type="number" name="cotaMinima" placeholder="Ex: 20" required class="w-full p-3 rounded-lg border-2">
                    </div>
                </div>
                
                <!-- NOVO: Campos de Cupons Progressivos -->
                <h4 class="font-semibold text-lg border-b border-neutral-700 pt-2 pb-1">Links de Pagamento e Cupons (Administrador)</h4>
                <div id="cuponsContainer" class="space-y-3">
                    <!-- Campos de cupons/links serão injetados aqui -->
                </div>
                <!-- FIM NOVO -->

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block mb-2 text-sm font-medium text-neutral-300">Carga Horária (Aluno)</label>
                        <input type="text" name="cargaHorariaAluno" placeholder="Ex: 20h" required class="w-full p-3 rounded-lg border-2">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-neutral-300">Carga Horária (Ministrante)</label>
                        <input type="text" name="cargaHorariaMinistrante" placeholder="Ex: 25h" required class="w-full p-3 rounded-lg border-2">
                    </div>
                </div>

                <div>
                     <label for="imagemUploadCurso" class="block mb-2 text-sm font-medium text-neutral-300">Imagem do Curso</label>
                     <input type="file" name="imagemUpload" id="imagemUploadCurso" accept="image/*">
                     <img id="previewImagemCurso" class="hidden w-full rounded-lg mt-2 object-cover">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium text-neutral-300">Assinatura do Administrador (desenho)</label>
                    <div class="bg-neutral-900 rounded-lg border border-neutral-600">
                        <canvas id="assinaturaCanvas" class="w-full h-32"></canvas>
                    </div>
                    <button type="button" id="limparAssinaturaBtn" class="text-sm text-indigo-400 hover:underline mt-1">Limpar</button>
                    <input type="hidden" name="assinaturaAdmin">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                     <button type="button" onclick="window.fecharModal('modalCurso')" class="btn-secondary px-6 py-2 rounded-lg">Cancelar</button>
                     <button type="submit" class="btn-primary font-bold px-6 py-2 rounded-lg">Salvar</button>
                </div>
             </form>
        </div>
    </div>


    <script>
        // ===================================================
        // INITIALIZAÇÃO DO SUPABASE
        // ===================================================
        const SUPABASE_URL = 'https://gcyxfecmaqnbhdnxaajs.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeXhmZWNtYXFuYmhkbnhhYWpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MjUwMTcsImV4cCI6MjA3NTEwMTAxN30.EO92s08p7jzIWnonw3IyGMBK2HVkIrdwvrAGwiBgqLs';
        let supabaseClient;

        /*
            IMPORTANTE:
            1. Crie as seguintes tabelas no seu projeto Supabase:
               - alunos, ministrantes, admins, cursos, chats, parceiros
            2. As colunas devem corresponder às propriedades dos objetos.
               Para campos como 'cursosInscritos', 'aulas', 'formacao', use o tipo de coluna JSONB.
            3. Crie os seguintes Buckets no Supabase Storage (e os marque como públicos):
               - fotos-perfil, imagens-cursos, comprovantes, contratos, chats, anotacoes-alunos, logos-parceiros
        */

        // ===================================================
        // ESTADO DA APLICAÇÃO
        // ===================================================
        const estado = {
            usuarioLogado: null, telaAtual: 'telaInicial', telaAnterior: null, cursoSelecionadoId: null, confirmacaoCallback: null, signaturePad: null, chatInterval: null, aulaSelecionadaIndex: 0
        };

        // ===================================================
        // DADOS E REGRAS DE CUPOM (Configuração centralizada)
        // ===================================================
        const DESCONTOS_CONFIG = [
            { percentual: 0, nome: 'Preço Normal (0%)', key: 'desconto_0' },
            { percentual: 10, nome: '10% de Desconto', key: 'desconto_10' },
            { percentual: 20, nome: '20% de Desconto', key: 'desconto_20' },
            { percentual: 50, nome: '50% de Desconto', key: 'desconto_50' },
            { percentual: 100, nome: '100% de Desconto', key: 'desconto_100' },
        ];


        // ===================================================
        // FUNÇÕES UTILITÁRIAS E DE CARREGAMENTO
        // ===================================================
        window.showLoader = function() { document.getElementById('modalCarregamento').classList.remove('hidden'); }
        window.hideLoader = function() { document.getElementById('modalCarregamento').classList.add('hidden'); }

        function sanitizeFileName(fileName) {
            // Substitui caracteres inválidos para nomes de arquivo de armazenamento por _
            return fileName.replace(/[^a-zA-Z0-9.\-_]/g, '_');
        }

        function handleStorageError(error, bucketName) {
            console.error(`Storage error in bucket '${bucketName}':`, error);
            if (error.message && error.message.toLowerCase().includes('bucket not found')) {
                window.mostrarModal(`Erro de Configuração: O bucket '${bucketName}' não foi encontrado. Por favor, crie este bucket (público) no seu painel Supabase Storage.`);
            } else if (error.message && error.message.toLowerCase().includes('violates row-level security policy')) {
                window.mostrarModal(`Erro de Permissão (RLS):\nO Supabase está a bloquear o envio para o bucket '${bucketName}'.\n\nIsto tem de ser corrigido no seu painel do Supabase, não no código.\n\nCOMO RESOLVER:\n1. No seu projeto Supabase, vá a 'Storage'.\n2. Encontre o bucket '${bucketName}', clique nos três pontos (...) e selecione 'Policies'.\n3. Clique em 'New Policy' -> 'For INSERT operation'.\n4. Para um acesso público rápido, pode usar o template 'Enable insert for anyone'. Para mais segurança, consulte a documentação do Supabase sobre RLS para Storage.`);
            } else {
                window.mostrarModal("Erro ao enviar o ficheiro.");
            }
        }
        
        // ===================================================
        // CONTROLE DE TELAS E MODAIS
        // ===================================================
        window.mostrarTela = function(telaId) {
             if (estado.chatInterval) {
                clearInterval(estado.chatInterval);
                estado.chatInterval = null;
            }
            document.querySelectorAll('main section').forEach(tela => tela.classList.add('hidden'));
            const telaAlvo = document.getElementById(telaId);
            if (telaAlvo) { 
                telaAlvo.classList.remove('hidden');
                telaAlvo.classList.add('fade-in');
                setTimeout(() => telaAlvo.classList.remove('fade-in'), 500);
                
                // Adiciona foco automático ao primeiro campo de entrada para melhorar a usabilidade móvel
                const firstInput = telaAlvo.querySelector('input, textarea, select');
                if (firstInput && !firstInput.disabled) {
                    setTimeout(() => firstInput.focus(), 100); // Pequeno atraso para garantir que a transição não interfira
                }
                
                estado.telaAnterior = estado.telaAtual; 
                estado.telaAtual = telaId; 
            }
            window.scrollTo(0, 0);
        }
        window.mostrarTelaAnterior = function() { (estado.telaAnterior) ? window.mostrarTela(estado.telaAnterior) : window.mostrarTela('telaInicial'); }
        window.mostrarModal = function(mensagem, modalId = 'modalNotificacao') {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            if (modalId === 'modalNotificacao') {
                 const msgElement = document.getElementById('mensagemModal');
                 if (msgElement) msgElement.innerText = mensagem;
            }
            modal.classList.remove('hidden');
        }
        window.fecharModal = function(modalId) { document.getElementById(modalId).classList.add('hidden'); }
        window.mostrarConfirmacao = function(mensagem, callback) {
            document.getElementById('mensagemConfirmacao').innerText = mensagem;
            document.getElementById('modalConfirmacao').classList.remove('hidden');
            estado.confirmacaoCallback = callback;
        }
        document.getElementById('btnConfirmarAcao').addEventListener('click', () => {
            if(estado.confirmacaoCallback) { estado.confirmacaoCallback(); }
            window.fecharModal('modalConfirmacao'); estado.confirmacaoCallback = null;
        });
        
        window.verImagemAmpliada = function(src) {
            document.getElementById('imagemAmpliada').src = src;
            window.mostrarModal('', 'modalImagem');
        }

        window.togglePasswordVisibility = function(icon) {
            const input = icon.previousElementSibling;
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        }

        window.formatarData = function(event) {
            const input = event.target;
            let v = input.value.replace(/\D/g, '').slice(0, 8); // Manter apenas dígitos, máx 8
            if (v.length >= 5) {
                input.value = `${v.slice(0, 2)}/${v.slice(2, 4)}/${v.slice(4)}`;
            } else if (v.length >= 3) {
                input.value = `${v.slice(0, 2)}/${v.slice(2)}`;
            } else {
                input.value = v;
            }
        }

        window.formatarHorario = function(event) {
            const input = event.target;
            let v = input.value.replace(/\D/g, '').slice(0, 4); // Manter apenas dígitos, máx 4 (HHMM)
            if (v.length >= 3) {
                input.value = `${v.slice(0, 2)}:${v.slice(2)}`;
            } else {
                input.value = v;
            }
        }

        function converterDataParaISO(dataString) {
            if (!dataString || !/^\d{2}\/\d{2}\/\d{4}$/.test(dataString)) return dataString;
            const [dia, mes, ano] = dataString.split('/');
            // Supabase/PostgreSQL prefere o formato ISO 8601 (YYYY-MM-DD)
            return `${ano}-${mes}-${dia}`;
        }

        function converterDataParaBR(dataString) {
            if (!dataString || !/^\d{4}-\d{2}-\d{2}$/.test(dataString)) return dataString;
            const [ano, mes, dia] = dataString.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        // ===================================================
        // AUTENTICAÇÃO E CADASTRO
        // ===================================================
        window.cadastrarAluno = async function(event) {
            event.preventDefault();
            window.showLoader();
            try {
                const formData = new FormData(event.target), dados = Object.fromEntries(formData.entries());
                
                // CORREÇÃO: Converter data de nascimento para o formato ISO antes de salvar no DB
                // REMOVIDO: dados.dataNascimento = converterDataParaISO(dados.dataNascimento);
                
                const { data: existingUser, error: checkError } = await supabaseClient.from('alunos').select('email').eq('email', dados.email).single();
                if (existingUser) {
                    window.mostrarModal("Este email já está cadastrado.");
                    return;
                }
                
                dados.cursosInscritos = [];
                // REMOVIDO: Chave PIX e CEP
                delete dados.cep;
                delete dados.tipoPix;
                delete dados.chavePix;
                delete dados.dataNascimento;
                
                const file = formData.get('fotoPerfil');
                if(file && file.size > 0) {
                    const filePath = `public/aluno-${Date.now()}-${sanitizeFileName(file.name)}`;
                    const { error: uploadError } = await supabaseClient.storage.from('fotos-perfil').upload(filePath, file);
                    if (uploadError) {
                        handleStorageError(uploadError, 'fotos-perfil');
                        return;
                    }
                    const { data: { publicUrl } } = supabaseClient.storage.from('fotos-perfil').getPublicUrl(filePath);
                    dados.fotoPerfil = publicUrl;
                } else {
                    dados.fotoPerfil = null;
                }
                
                const { error: insertError } = await supabaseClient.from('alunos').insert([dados]);
                if (insertError) {
                    window.mostrarModal("Erro ao realizar cadastro. Verifique os dados e tente novamente.");
                    console.error("Insert Error:", insertError);
                    return;
                }

                window.mostrarModal("Cadastro realizado com sucesso!");
                document.getElementById('formCadastroAluno').reset(); 
                document.getElementById('previewFotoAluno').classList.add('hidden');
                window.mostrarTela('telaLoginAluno');
            } finally {
                window.hideLoader();
            }
        }
        
        window.cadastrarMinistrante = async function(event) {
            event.preventDefault();
            window.showLoader();
            try {
                const formData = new FormData(event.target);
                const dados = Object.fromEntries(formData.entries());

                const { data: existingUser, error: checkError } = await supabaseClient.from('ministrantes').select('email').eq('email', dados.email).single();
                if (existingUser) {
                    window.mostrarModal("Este email já está cadastrado.");
                    return;
                }

                dados.cursosVinculados = [];
                dados.contrato = { status: 'pendente', enviadoPeloAdmin: null, assinadoPeloMinistrante: null };
                dados.formacao = {
                    graduadoEm: dados.graduadoEm || '', especialistaEm: dados.especialistaEm || '',
                    mestreEm: dados.mestreEm || '', doutorEm: dados.doutorEm || '', posDoutorEm: dados.posDoutorEm || ''
                };
                ['graduadoEm', 'especialistaEm', 'mestreEm', 'doutorEm', 'posDoutorEm'].forEach(k => delete dados[k]);
                
                // O campo 'aceiteDivulgacao' é apenas para validação no formulário
                // e não corresponde a uma coluna no banco de dados, então o removemos para evitar erros ao salvar.
                delete dados.aceiteDivulgacao;
                
                const file = formData.get('fotoPerfil');
                if (file && file.size > 0) {
                    const filePath = `public/ministrante-${Date.now()}-${sanitizeFileName(file.name)}`;
                    const { error: uploadError } = await supabaseClient.storage.from('fotos-perfil').upload(filePath, file);
                    if (uploadError) {
                        handleStorageError(uploadError, 'fotos-perfil');
                        return;
                    }
                    const { data: { publicUrl } } = supabaseClient.storage.from('fotos-perfil').getPublicUrl(filePath);
                    dados.fotoPerfil = publicUrl;
                } else {
                    dados.fotoPerfil = null;
                }

                const { error: insertError } = await supabaseClient.from('ministrantes').insert([dados]);
                if (insertError) {
                    window.mostrarModal("Erro ao realizar cadastro.");
                    console.error("Insert Error:", insertError);
                    return;
                }

                window.mostrarModal("Cadastro realizado com sucesso!");
                document.getElementById('formCadastroMinistrante').reset();
                document.getElementById('previewFotoMinistrante').classList.add('hidden');
                window.mostrarTela('telaLoginMinistrante');
            } finally {
                window.hideLoader();
            }
        }

        window.loginAluno = async function() {
            window.showLoader();
            try {
                const email = document.getElementById('loginEmailAluno').value, senha = document.getElementById('loginSenhaAluno').value;
                const { data: aluno, error } = await supabaseClient.from('alunos').select('*').eq('email', email).eq('senha', senha).single();
                
                if (aluno) { 
                    estado.usuarioLogado = { tipo: 'aluno', email: aluno.email, nome: aluno.nomeCompleto }; 
                    localStorage.setItem('sessaoUsuario', JSON.stringify(estado.usuarioLogado));
                    await loginComSessao(estado.usuarioLogado, 'aluno'); 
                } else { 
                    window.mostrarModal("Email ou senha inválidos."); 
                }
            } finally {
                window.hideLoader();
            }
        }
        window.loginMinistrante = async function() {
            window.showLoader();
            try {
                const email = document.getElementById('loginEmailMinistrante').value, senha = document.getElementById('loginSenhaMinistrante').value;
                const { data: ministrante, error } = await supabaseClient.from('ministrantes').select('*').eq('email', email).eq('senha', senha).single();

                if (ministrante) { 
                    estado.usuarioLogado = { tipo: 'ministrante', email: ministrante.email, nome: ministrante.nomeCompleto }; 
                    localStorage.setItem('sessaoUsuario', JSON.stringify(estado.usuarioLogado));
                    await loginComSessao(estado.usuarioLogado, 'ministrante'); 
                } else { 
                    window.mostrarModal("Email ou senha inválidos."); 
                }
            } finally {
                window.hideLoader();
            }
        }
        window.loginAdmin = async function() {
            window.showLoader();
            try {
                const email = document.getElementById('loginEmailAdmin').value, senha = document.getElementById('loginSenhaAdmin').value;
                const { data: admin, error } = await supabaseClient.from('admins').select('*').eq('email', email).eq('senha', senha).single();

                if(admin){ 
                    estado.usuarioLogado = { tipo: 'admin', email: admin.email, nome: admin.nome };
                    localStorage.setItem('sessaoUsuario', JSON.stringify(estado.usuarioLogado));
                    await loginComSessao(estado.usuarioLogado, 'admin');
                } else { 
                    window.mostrarModal("Email ou senha de administrador inválidos."); 
                }
            } finally {
                window.hideLoader();
            }
        }
        window.logout = function() { 
            if (estado.chatInterval) {
                clearInterval(estado.chatInterval);
                estado.chatInterval = null;
            }
            estado.usuarioLogado = null; 
            // FIREBASE/SUPABASE STORAGE: Substitua localStorage por Firestore se usar a função de Storage.
            localStorage.removeItem('sessaoUsuario');
            window.mostrarTela('telaInicial'); 
        }
        async function verificarSessao() {
            const sessao = JSON.parse(localStorage.getItem('sessaoUsuario'));
            if (sessao) { 
                window.showLoader();
                estado.usuarioLogado = sessao; 
                await loginComSessao(sessao, sessao.tipo, true); 
                window.hideLoader();
            }
        }
        async function loginComSessao(sessao, tipo, isReload = false) {
            const { data: usuario, error } = await supabaseClient.from(tipo + 's').select('*').eq('email', sessao.email).single();

            if(usuario) {
                try {
                    if(tipo === 'aluno') {
                        if (!isReload) window.mostrarModal(`Bem-vindo(a), ${usuario.nomeCompleto.split(' ')[0]}! Pronto para aprender mais e potencializar seu futuro?`);
                        document.getElementById('boasVindasAluno').innerText = `Bem-vindo(a), ${usuario.nomeCompleto.split(' ')[0]}!`;
                        document.getElementById('subtituloAluno').innerText = "Pronto para aprender mais e potencializar seu futuro?";
                        await renderizarPainelAluno(); 
                        window.mostrarTela('painelAluno');
                    } else if (tipo === 'ministrante') {
                         if (!isReload) window.mostrarModal(`Bem-vindo(a), ${usuario.nomeCompleto}!`);
                        document.getElementById('boasVindasMinistrante').innerText = `Bem-vindo(a), ${usuario.nomeCompleto}!`;
                        await renderizarPainelMinistrante(); 
                        window.mostrarTela('painelMinistrante');
                    } else if (tipo === 'admin') {
                         if (!isReload) window.mostrarModal(`Bem-vindo, ${usuario.nome}!`);
                        await renderizarPainelAdmin(); 
                        window.mostrarTela('painelAdmin');
                    }
                } catch (e) {
                    console.error("Erro ao renderizar painel do usuário:", e);
                    window.mostrarModal("Ocorreu um erro ao carregar seu painel. Por favor, tente fazer o login novamente.");
                    window.logout();
                }
            } else { 
                window.logout(); 
            }
        }
        
        // ===================================================
        // RENDERIZAÇÃO DE CONTEÚDO GERAL
        // ===================================================
        // Adiciona função para determinar o gênero (simples)
        function isNomeFeminino(nome) {
            if (!nome) return false;
            const nomeLower = nome.toLowerCase().trim();
            const primeiroNome = nomeLower.split(' ')[0];
            
            // Lista de nomes femininos comuns como primeiro nome
            const nomesFemininos = ['maria', 'ana', 'paula', 'carla', 'elena', 'joana', 'lúcia', 'clara', 'beatriz', 'isabela', 'laura', 'sophia', 'luiza', 'luísa', 'marina', 'patrícia', 'fernanda', 'silvana'];
            
            // Lista de nomes masculinos que podem terminar em 'a' para evitar falsos positivos
            const nomesMasculinosComA = ['lucas', 'matias', 'jona', 'isaías'];
            
            // 1. Verifica se o primeiro nome é um nome masculino que termina em 's' ou 'o' (forte indicativo masculino)
            if (primeiroNome.endsWith('s') || primeiroNome.endsWith('o') || nomesMasculinosComA.includes(primeiroNome)) {
                 return false;
            }
            
            // 2. Verifica se o primeiro nome está na lista de femininos ou se termina em 'a' (que é o padrão feminino em PT)
            if (nomesFemininos.includes(primeiroNome) || primeiroNome.endsWith('a')) {
                return true;
            }

            return false;
        }

        window.renderizarCursos = async function(containerId, filtro = '') {
            window.showLoader();
            try {
                const container = document.getElementById(containerId);
                
                let query = supabaseClient.from('cursos').select('*');
                
                // If on the main page and not searching, show only open courses.
                if (containerId === 'listaCursosInicial' && !filtro) {
                    query = query.eq('statusInscricao', 'recebendo').order('id', { ascending: false }).limit(6);
                } 
                // If there is a search filter, apply it to all courses.
                else if (filtro) {
                    query = query.ilike('nomeDoCurso', `%${filtro}%`);
                }

                // Fetch courses and all instructors in parallel
                const [{ data: cursos, error: cursosError }, { data: todosMinistrantes, error: ministrantesError }] = await Promise.all([
                    query,
                    supabaseClient.from('ministrantes').select('nomeCompleto, formacao')
                ]);
                
                if (cursosError || ministrantesError || !cursos) {
                    container.innerHTML = '<p class="col-span-full text-center text-neutral-400">Erro ao carregar cursos.</p>';
                    console.error("Error fetching data:", cursosError || ministrantesError);
                    return;
                }

                container.innerHTML = '';
                if (cursos.length === 0) { 
                    container.innerHTML = '<p class="col-span-full text-center text-neutral-400">Nenhum curso encontrado.</p>'; 
                    return; 
                }

                cursos.forEach(curso => {
                    if (curso.status === 'cancelado') return;
                    const isRecebendo = curso.statusInscricao === 'recebendo';
                    // ALTERAÇÃO AQUI: Botão com novo texto
                    const buttonHtml = `<button onclick="window.verDetalhesCurso(${curso.id})" class="w-full btn-primary font-bold py-2 px-4 rounded-lg mt-auto">Ver Detalhes e se Inscrever</button>`;
                    const allMinistrantesNomes = [...new Set(curso.aulas.flatMap(a => a.ministrantes))];
                    
                    const ministrantesComTitulacao = allMinistrantesNomes.map(nome => {
                        const ministranteInfo = todosMinistrantes.find(m => m.nomeCompleto === nome);
                        if (!ministranteInfo || !ministranteInfo.formacao) {
                            return nome; 
                        }
                        
                        const titulos = ministranteInfo.formacao;
                        let titulacao = '';
                        const isFeminino = isNomeFeminino(nome);

                        if(titulos.posDoutorEm) titulacao = isFeminino ? 'Pós-Doutora' : 'Pós-Doutor';
                        else if(titulos.doutorEm) titulacao = isFeminino ? 'Doutora' : 'Doutor';
                        else if(titulos.mestreEm) titulacao = isFeminino ? 'Mestra' : 'Mestre';
                        else if(titulos.especialistaEm) titulacao = 'Especialista';
                        
                        return titulacao ? `${nome} (${titulacao})` : nome;
                    }).join(', ');
                    
                    let dataHoraHtml = '<p class="text-neutral-300 text-sm mb-2"><i class="fas fa-calendar-alt w-5 mr-1 text-neutral-400"></i> Data a definir</p>';
                    if (curso.aulas && curso.aulas.length > 0 && curso.aulas[0].data && curso.aulas[0].horarioInicio) {
                        dataHoraHtml = `<p class="text-neutral-300 text-sm mb-2"><i class="fas fa-calendar-alt w-5 mr-1 text-neutral-400"></i> Início em ${new Date(curso.aulas[0].data).toLocaleDateString('pt-BR', {timeZone: 'UTC'})} às ${curso.aulas[0].horarioInicio}</p>`;
                    }

                    container.innerHTML += `<div class="glassmorphism rounded-xl overflow-hidden shadow-lg flex flex-col h-full"><div class="relative"><img class="w-full h-48 object-cover" src="${curso.imagem}" alt="Imagem do curso ${curso.nomeDoCurso}"><div class="absolute top-2 right-2 text-xs font-bold py-1 px-3 rounded-full ${isRecebendo ? 'bg-green-500' : 'bg-red-500'}">${isRecebendo ? 'Recebendo inscrições' : 'Inscrições encerradas'}</div></div><div class="p-6 flex flex-col flex-grow"><h3 class="text-xl font-bold mb-2">${curso.nomeDoCurso}</h3>${dataHoraHtml}<p class="text-neutral-300 text-sm mb-4"><i class="fas fa-chalkboard-teacher w-5 mr-1 text-neutral-400"></i> ${ministrantesComTitulacao || 'A definir'}</p><p class="text-2xl font-bold text-white mb-4">R$ ${parseFloat(curso.preco).toFixed(2).replace('.',',')}</p>${buttonHtml}</div></div>`;
                });
            } finally {
                window.hideLoader();
            }
        }

        async function renderizarParceiros() {
            const container = document.getElementById('parceirosContainer');
            if (!container) return;
            try {
                const { data: parceiros, error } = await supabaseClient.from('parceiros').select('*');
                if (error) { throw error; }

                if (!parceiros || parceiros.length === 0) {
                    container.innerHTML = '<p class="text-neutral-500">Nossos parceiros aparecerão aqui em breve.</p>';
                    return;
                }
                
                container.innerHTML = parceiros.map(p => `
                    <div class="flex justify-center">
                         <img src="${p.logoUrl}" alt="${p.nome}" class="h-32 object-contain logo-parceiro">
                    </div>
                `).join('');

            } catch(e) {
                console.error("Erro ao carregar parceiros:", e);
                container.innerHTML = '';
            }
        }

        window.verDetalhesCurso = async function(cursoId) {
            window.showLoader();
            try {
                const [{ data: curso, error: cursoError }, { data: todosMinistrantes, error: ministrantesError }] = await Promise.all([
                    supabaseClient.from('cursos').select('*').eq('id', cursoId).single(),
                    supabaseClient.from('ministrantes').select('nomeCompleto, formacao')
                ]);

                if (cursoError || !curso || curso.status === 'cancelado') {
                    window.mostrarModal("Curso não encontrado ou não está mais disponível.");
                    return;
                }

                const isRecebendo = curso.statusInscricao === 'recebendo';
                // ALTERAÇÃO AQUI: Botão de inscrição no modal
                const buttonHtml = isRecebendo ? `<button onclick="window.inscrever(${curso.id})" class="w-full btn-primary font-bold py-3 px-6 rounded-lg">Inscreva-se por R$ ${parseFloat(curso.preco).toFixed(2).replace('.',',')}</button>` : `<button class="w-full bg-neutral-600 text-neutral-400 font-bold py-3 px-6 rounded-lg cursor-not-allowed" disabled>Inscrições encerradas</button>`;

                let aulasHtml = '<p class="text-sm text-neutral-400">Nenhuma aula detalhada.</p>';
                if (curso.aulas && curso.aulas.length > 0) {
                    aulasHtml = curso.aulas.map((aula, index) => `
                        <div class="py-3">
                            <h5 class="font-semibold text-indigo-300">Aula ${index + 1}: ${aula.titulo}</h5>
                            <p class="text-sm text-neutral-400 mt-1"><i class="fas fa-calendar-alt fa-fw mr-2"></i> Início em ${new Date(aula.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'})} das ${aula.horarioInicio} às ${aula.horarioFim}</p>
                            <p class="text-sm text-neutral-300 mt-1"><strong>Tópicos:</strong> ${aula.topicos}</p>
                        </div>
                    `).join('<hr class="border-neutral-700">');
                }

                const nomesMinistrantes = [...new Set(curso.aulas.flatMap(a => a.ministrantes))];
                const ministrantesHtml = nomesMinistrantes.map(nome => {
                    const ministranteInfo = todosMinistrantes.find(m => m.nomeCompleto === nome);
                    if (!ministranteInfo) return `<p class="font-bold text-white">${nome}</p>`;
                    
                    const titulos = { graduadoEm: 'Graduado(a) em', especialistaEm: 'Especialista em', mestreEm: 'Mestra em', doutorEm: 'Doutor(a) em', posDoutorEm: 'Pós-Doutor(a) em' };
                    const qualificacoes = Object.entries(ministranteInfo.formacao)
                        .filter(([key, value]) => value)
                        .map(([key, value]) => {
                            let tituloDisplay = titulos[key] || key;
                            // Aplica lógica de gênero no modal de detalhes
                            if (key === 'mestreEm') {
                                const isFeminino = isNomeFeminino(nome);
                                tituloDisplay = isFeminino ? 'Mestra em' : 'Mestre em';
                            } else if (key === 'doutorEm') {
                                const isFeminino = isNomeFeminino(nome);
                                tituloDisplay = isFeminino ? 'Doutora em' : 'Doutor em';
                            }
                            return `<li>${tituloDisplay}: ${value}</li>`;
                        }).join('');

                    return `<div class="mb-4">
                                <p class="font-bold text-white">${ministranteInfo.nomeCompleto}</p>
                                <ul class="text-xs text-neutral-400 list-disc list-inside">${qualificacoes || '<li>Formação não informada</li>'}</ul>
                            </div>`;
                }).join('');
                
                const modalContent = `
                    <div class="w-full max-w-3xl">
                        <img src="${curso.imagem}" alt="Imagem do curso ${curso.nomeDoCurso}" class="w-full max-h-72 object-contain rounded-t-lg cursor-pointer" onclick="window.verImagemAmpliada('${curso.imagem}')">
                        <div class="p-6">
                            <h2 class="text-2xl font-bold mb-4 text-white">${curso.nomeDoCurso}</h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-sm mb-6">
                                <div>
                                    <h3 class="text-xl font-bold border-b border-neutral-700 pb-2 mb-3">Conteúdo do Curso</h3>
                                    <div class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-2">${aulasHtml}</div>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold border-b border-neutral-700 pb-2 mb-3">Ministrante(s)</h3>
                                    <div class="max-h-48 overflow-y-auto custom-scrollbar pr-2">${ministrantesHtml}</div>
                                </div>
                            </div>
                            
                            <div class="mt-6 text-center">
                                ${buttonHtml}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end mt-4"><button onclick="window.fecharModal('modalDetalhes')" class="btn-secondary px-4 py-2 rounded-lg">Fechar</button></div>
                `;
                document.getElementById('conteudoModalDetalhes').innerHTML = modalContent;
                document.querySelector('#modalDetalhes .modal-content').style.maxWidth = '800px';
                window.mostrarModal('', 'modalDetalhes');
            } finally {
                window.hideLoader();
            }
        }


        window.previewImagem = function(event, previewId) {
            const preview = document.getElementById(previewId);
            const file = event.target.files[0];
            if (file && preview) {
                const reader = new FileReader();
                reader.onloadend = function() {
                    preview.src = reader.result;
                    preview.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        window.salvarPerfil = async function(event, tipoUsuario) {
            event.preventDefault();
            window.showLoader();
            try {
                const formData = new FormData(event.target);
                const dados = Object.fromEntries(formData.entries());

                const { data: usuarioAtual, error: fetchError } = await supabaseClient.from(tipoUsuario + 's').select('*').eq('email', estado.usuarioLogado.email).single();
                if (fetchError) {
                    window.mostrarModal("Erro ao carregar perfil para salvar.");
                    return;
                }

                const file = formData.get('fotoPerfil');
                let fotoUrl = usuarioAtual.fotoPerfil;

                if (file && file.size > 0) {
                    const filePath = `public/${tipoUsuario}-${Date.now()}-${sanitizeFileName(file.name)}`;
                    const { error: uploadError } = await supabaseClient.storage.from('fotos-perfil').upload(filePath, file);
                    if (uploadError) {
                        handleStorageError(uploadError, 'fotos-perfil');
                        return;
                    }
                    const { data: { publicUrl } } = supabaseClient.storage.from('fotos-perfil').getPublicUrl(filePath);
                    fotoUrl = publicUrl;
                }
                
                const novosDados = { ...dados, fotoPerfil: fotoUrl };
                delete novosDados.fotoPerfilInput; // Campo do form, não da tabela

                if (novosDados.novaSenha) {
                    novosDados.senha = novosDados.novaSenha;
                }
                delete novosDados.novaSenha;

                if (tipoUsuario === 'ministrante') {
                    novosDados.formacao = {
                        graduadoEm: dados.graduadoEm || '', especialistaEm: dados.especialistaEm || '',
                        mestreEm: dados.mestreEm || '', doutorEm: dados.doutorEm || '', posDoutorEm: dados.doutorEm || '', posDoutorEm: dados.posDoutorEm || ''
                    };
                    ['graduadoEm', 'especialistaEm', 'mestreEm', 'doutorEm', 'posDoutorEm'].forEach(k => delete dados[k]);
                } else if (tipoUsuario === 'aluno') {
                    // REMOVIDO: CAMPOS EXCLUÍDOS DO FORMULÁRIO
                    delete novosDados.cep;
                    delete novosDados.dataNascimento;
                    delete novosDados.tipoPix;
                    delete novosDados.chavePix;
                }
                
                const { error: updateError } = await supabaseClient.from(tipoUsuario + 's').update(novosDados).eq('id', usuarioAtual.id);
                if (updateError) {
                    window.mostrarModal("Erro ao atualizar o perfil.");
                    console.error(updateError);
                    return;
                }

                if (novosDados.nomeCompleto !== estado.usuarioLogado.nome) {
                    estado.usuarioLogado.nome = novosDados.nomeCompleto;
                    localStorage.setItem('sessaoUsuario', JSON.stringify(estado.usuarioLogado));
                    if (tipoUsuario === 'aluno') {
                        document.getElementById('boasVindasAluno').innerText = `Bem-vindo(a), ${novosDados.nomeCompleto.split(' ')[0]}!`;
                    } else if (tipoUsuario === 'ministrante') {
                        document.getElementById('boasVindasMinistrante').innerText = `Bem-vindo(a), ${novosDados.nomeCompleto}!`;
                    }
                }
                
                window.mostrarModal("Perfil atualizado com sucesso!");
            } finally {
                window.hideLoader();
            }
        }

        async function renderizarPerfil(containerId, tipoUsuario) {
            window.showLoader();
            try {
                const container = document.getElementById(containerId);
                if (!container) return;

                const { data: usuario, error } = await supabaseClient.from(tipoUsuario + 's').select('*').eq('email', estado.usuarioLogado.email).single();
                if (error || !usuario) {
                    container.innerHTML = '<p>Erro: Usuário não encontrado.</p>';
                    return;
                }

                let camposEspecificos = '';
                if (tipoUsuario === 'aluno') {
                    // REMOVIDO: CEP E DATA DE NASCIMENTO
                    camposEspecificos = `
                        <input type="text" name="cpf" placeholder="CPF" value="${usuario.cpf || ''}" required class="w-full p-3 rounded-lg border-2">
                        <input type="text" name="cnpjEmpresa" placeholder="CNPJ da Empresa" value="${usuario.cnpjEmpresa || ''}" class="w-full p-3 rounded-lg border-2">
                    `;
                } else if (tipoUsuario === 'ministrante') {
                    camposEspecificos = `
                        <input type="text" name="cpfCnpj" placeholder="CPF ou CNPJ no caso de empresa" value="${usuario.cpfCnpj || ''}" required class="w-full p-3 rounded-lg border-2">
                        <input type="text" name="rg" placeholder="RG (somente para pessoa física)" value="${usuario.rg || ''}" class="w-full p-3 rounded-lg border-2">
                        <div class="border border-neutral-600 p-3 rounded-lg space-y-3">
                            <label class="block -mb-2 text-sm font-medium text-neutral-300">Formação Acadêmica</label>
                            <input type="text" name="graduadoEm" placeholder="Graduado em:" value="${(usuario.formacao && usuario.formacao.graduadoEm) || ''}" class="w-full p-3 rounded-lg border-2">
                            <input type="text" name="especialistaEm" placeholder="Especialista em:" value="${(usuario.formacao && usuario.formacao.especialistaEm) || ''}" class="w-full p-3 rounded-lg border-2">
                            <input type="text" name="mestreEm" placeholder="Mestre em:" value="${(usuario.formacao && usuario.formacao.mestreEm) || ''}" class="w-full p-3 rounded-lg border-2">
                            <input type="text" name="doutorEm" placeholder="Doutor em:" value="${(usuario.formacao && usuario.formacao.doutorEm) || ''}" class="w-full p-3 rounded-lg border-2">
                            <input type="text" name="posDoutorEm" placeholder="Pós-doutor em:" value="${(usuario.formacao && usuario.formacao.posDoutorEm) || ''}" class="w-full p-3 rounded-lg border-2">
                        </div>
                    `;
                }

                // Lógica para mostrar endereço completo do aluno ou apenas os campos do ministrante
                let enderecoHtml = '';
                if (tipoUsuario === 'aluno') {
                     enderecoHtml = `
                        <div class="border border-neutral-600 p-3 rounded-lg space-y-3">
                            <label class="block -mb-2 text-sm font-medium text-neutral-300">Endereço</label>
                            <!-- REMOVIDO: Input CEP -->
                            <input type="text" name="rua" placeholder="Rua" value="${usuario.rua || ''}" required class="w-full p-3 rounded-lg border-2">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="text" name="numero" placeholder="Número" value="${usuario.numero || ''}" required class="w-full p-3 rounded-lg border-2">
                                <input type="text" name="bairro" placeholder="Bairro" value="${usuario.bairro || ''}" required class="w-full p-3 rounded-lg border-2">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="text" name="cidade" placeholder="Cidade" value="${usuario.cidade || ''}" required class="w-full p-3 rounded-lg border-2">
                                <input type="text" name="estado" placeholder="Estado" value="${usuario.estado || ''}" required class="w-full p-3 rounded-lg border-2">
                            </div>
                        </div>
                    `;
                } else if (tipoUsuario === 'ministrante') {
                     enderecoHtml = `
                        <div class="border border-neutral-600 p-3 rounded-lg space-y-3">
                            <label class="block -mb-2 text-sm font-medium text-neutral-300">Endereço</label>
                            <input type="text" name="cep" placeholder="CEP" value="${usuario.cep || ''}" required class="w-full p-3 rounded-lg border-2">
                            <input type="text" name="rua" placeholder="Rua" value="${usuario.rua || ''}" required class="w-full p-3 rounded-lg border-2">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="text" name="numero" placeholder="Número" value="${usuario.numero || ''}" required class="w-full p-3 rounded-lg border-2">
                                <input type="text" name="bairro" placeholder="Bairro" value="${usuario.bairro || ''}" required class="w-full p-3 rounded-lg border-2">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="text" name="cidade" placeholder="Cidade" value="${usuario.cidade || ''}" required class="w-full p-3 rounded-lg border-2">
                                <input type="text" name="estado" placeholder="Estado" value="${usuario.estado || ''}" required class="w-full p-3 rounded-lg border-2">
                            </div>
                        </div>
                    `;
                }

                let pixHtml = '';
                if (tipoUsuario === 'ministrante') {
                    pixHtml = `
                        <div class="border border-neutral-600 p-3 rounded-lg">
                            <label class="block mb-2 text-sm font-medium text-neutral-300">Chave PIX</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <select name="tipoPix" required class="p-3 rounded-lg border-2">
                                        <option value="email" ${usuario.tipoPix === 'email' ? 'selected' : ''}>Email</option>
                                        <option value="cpf" ${usuario.tipoPix === 'cpf' ? 'selected' : ''}>CPF</option>
                                        <option value="cnpj" ${usuario.tipoPix === 'cnpj' ? 'selected' : ''}>CNPJ</option>
                                        <option value="celular" ${usuario.tipoPix === 'celular' ? 'selected' : ''}>Celular</option>
                                    </select>
                                    <input type="text" name="chavePix" placeholder="Chave PIX" value="${usuario.chavePix || ''}" required class="w-full p-3 rounded-lg border-2">
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = `
                    <div class="glassmorphism p-8 rounded-xl">
                        <h3 class="text-xl font-bold mb-6 text-center">Editar Perfil</h3>
                        <form id="formPerfil-${tipoUsuario}" onsubmit="salvarPerfil(event, '${tipoUsuario}')" class="space-y-4">
                            <div class="text-center mb-4">
                                <img id="previewFotoPerfil-${tipoUsuario}" src="${usuario.fotoPerfil || `https://placehold.co/128x128/171717/FFFFFF?text=?`}" class="w-32 h-32 rounded-full mx-auto mb-4 border-2 border-indigo-500 object-cover">
                                <label for="fotoPerfilInput-${tipoUsuario}" class="cursor-pointer text-indigo-400 hover:underline text-sm mt-2 block">Trocar foto</label>
                                <input type="file" name="fotoPerfil" id="fotoPerfilInput-${tipoUsuario}" class="hidden" accept="image/*" onchange="previewImagem(event, 'previewFotoPerfil-${tipoUsuario}')">
                            </div>
                            <input type="text" name="nomeCompleto" placeholder="Nome Completo" value="${usuario.nomeCompleto || ''}" required class="w-full p-3 rounded-lg border-2">
                            ${camposEspecificos}
                            ${enderecoHtml}
                            <input type="text" name="whatsapp" placeholder="WhatsApp" value="${usuario.whatsapp || ''}" required class="w-full p-3 rounded-lg border-2">
                            <input type="text" name="instagram" placeholder="@ do Instagram" value="${usuario.instagram || ''}" required class="w-full p-3 rounded-lg border-2">
                            
                            ${pixHtml}

                            <div class="pt-4">
                                <h4 class="font-semibold mb-2">Alterar Senha</h4>
                                <div class="password-container">
                                    <input type="password" name="novaSenha" placeholder="Nova Senha (deixe em branco para não alterar)" class="w-full p-3 rounded-lg border-2">
                                    <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility(this)"></i>
                                </div>
                            </div>

                            <button type="submit" class="w-full btn-primary font-bold p-3 rounded-lg mt-4">Salvar Alterações</button>
                        </form>
                    </div>
                `;
            } finally {
                window.hideLoader();
            }
        }
        
        // ===================================================
        // LÓGICA DO ALUNO
        // ===================================================
        async function renderizarPainelAluno() {
            window.showLoader();
            try {
                // Executar todas as renderizações de aba em paralelo
                await Promise.all([
                    window.renderizarCursosPainelAluno(),
                    window.renderizarMeusCursos(),
                    renderizarPerfil('abaConteudo-meuPerfil', 'aluno')
                ]);
            } catch (e) {
                console.error("Error rendering student panel:", e);
                window.mostrarModal("Error loading your panel.");
            } finally {
                window.hideLoader();
            }
        }
        window.renderizarCursosPainelAluno = async function() { await window.renderizarCursos('listaCursosPainelAluno', document.getElementById('buscaCursoAluno').value); }
        window.renderizarMeusCursos = async function() {
            const container = document.getElementById('listaMeusCursos');
            const { data: aluno, error: alunoError } = await supabaseClient.from('alunos').select('*').eq('email', estado.usuarioLogado.email).single();
            const { data: todosCursos, error: cursosError } = await supabaseClient.from('cursos').select('*');
            
            if (alunoError || cursosError) {
                container.innerHTML = '<p>Erro ao carregar seus cursos.</p>';
                return;
            }

            if (!aluno || !Array.isArray(aluno.cursosInscritos) || aluno.cursosInscritos.length === 0) { 
                container.innerHTML = '<p class="text-center text-neutral-400 bg-neutral-800 p-6 rounded-lg">Você ainda não se inscreveu em nenhum curso.</p>'; 
                return; 
            }

            container.innerHTML = '';
            aluno.cursosInscritos.forEach(inscricao => {
                const cursoInfo = todosCursos.find(c => c.id == inscricao.cursoId);
                if (cursoInfo && cursoInfo.status !== 'cancelado') {
                    let statusInfo, acaoBotao = '';
                    switch(inscricao.status) {
                        case 'pendente': statusInfo = '<span class="text-yellow-400 font-semibold">Pagamento em análise</span>'; acaoBotao = '<button class="btn-secondary px-4 py-2 rounded-lg text-sm" disabled>Aguardando</button>'; break;
                        case 'aprovado': statusInfo = '<span class="text-green-400 font-semibold">Acesso Liberado</span>'; acaoBotao = `<button onclick="window.acessarCurso(${cursoInfo.id})" class="btn-primary px-4 py-2 rounded-lg text-sm">Acessar Curso</button>`; break;
                        case 'reprovado': statusInfo = '<span class="text-red-400 font-semibold">Pagamento Reprovado</span>'; acaoBotao = '<button class="btn-danger text-white px-4 py-2 rounded-lg text-sm" disabled>Reprovado</button>'; break;
                        case 'reembolso_pendente': statusInfo = '<span class="text-blue-400 font-semibold">Curso Cancelado - Reembolso Pendente</span>'; break;
                        case 'reembolsado': statusInfo = '<span class="text-gray-400 font-semibold">Curso Cancelado - Reembolsado</span>'; break;
                    }
                    container.innerHTML += `<div class="glassmorphism p-4 rounded-lg flex flex-col md:flex-row items-center justify-between gap-4"><div class="flex items-center gap-4"><img src="${cursoInfo.imagem}" class="w-24 h-16 object-cover rounded-md"><div><h4 class="font-bold text-lg">${cursoInfo.nomeDoCurso}</h4><p class="text-sm text-neutral-300">${statusInfo}</p></div></div><div class="flex items-center gap-4">${acaoBotao}</div></div>`;
                }
            });
        }
        window.mudarAbaPainelAluno = function(abaId) {
            document.querySelectorAll('#conteudoAbaAluno > div').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-aluno').forEach(tab => { tab.classList.remove('border-indigo-500', 'text-indigo-400'); tab.classList.add('border-transparent', 'text-gray-400'); });
            document.getElementById(`abaConteudo-${abaId}`).classList.remove('hidden');
            document.getElementById(`aba-${abaId}`).classList.add('border-indigo-500', 'text-indigo-400');
        }
        window.inscrever = async function(cursoId) {
            window.fecharModal('modalDetalhes');
            if (!estado.usuarioLogado || estado.usuarioLogado.tipo !== 'aluno') { window.mostrarModal("Faça login como aluno para se inscrever."); if(!estado.usuarioLogado) window.mostrarTela('telaLoginAluno'); return; }
            
            const { data: aluno, error } = await supabaseClient.from('alunos').select('cursosInscritos').eq('email', estado.usuarioLogado.email).single();
            if (error || !aluno) {
                window.mostrarModal("Erro ao verificar sua inscrição.");
                return;
            }

            if (Array.isArray(aluno.cursosInscritos) && aluno.cursosInscritos.find(i => i.cursoId == cursoId)) { 
                window.mostrarModal("Você já está neste curso."); 
                window.mudarAbaPainelAluno('meusCursos'); 
                window.mostrarTela('painelAluno'); 
                return; 
            }
            
            estado.cursoSelecionadoId = cursoId;
            const { data: curso } = await supabaseClient.from('cursos').select('preco, nomeDoCurso').eq('id', cursoId).single();
            document.getElementById('nomeCursoPagamento').innerText = curso.nomeDoCurso;
            
            const precoOriginal = parseFloat(curso.preco);
            document.getElementById('precoCursoPagamento').innerText = `Valor: R$ ${precoOriginal.toFixed(2).replace('.',',')}`; 
            
            // Limpa inputs, previews e área de opções de pagamento
            document.getElementById('inputCupom').value = '';
            document.getElementById('statusCupom').innerHTML = 'O preço normal está disponível abaixo. Insira um cupom para um desconto.';
            document.getElementById('statusCupom').className = 'text-sm mt-2 text-neutral-400';
            document.getElementById('comprovantePagamento').value = '';
            document.getElementById('previewComprovante').classList.add('hidden');
            
            // Inicializa a exibição (mostra o link de 0% por defeito)
            window.verificarCupomEExibirPagamento(cursoId, true);
            
            window.mostrarTela('telaPagamento');
        }
        
        window.verificarCupomEExibirPagamento = async function(cursoId, isInitialLoad = false) {
            const inputCupom = document.getElementById('inputCupom');
            const statusCupom = document.getElementById('statusCupom');
            const linkPagamentoContainer = document.getElementById('linkPagamentoContainer');
            const precoDisplay = document.getElementById('precoCursoPagamento');
            
            const cupom = inputCupom.value.trim().toUpperCase();
            linkPagamentoContainer.innerHTML = ''; // Limpa a área dos botões
            
            const { data: curso } = await supabaseClient.from('cursos').select('preco, linksDePagamento').eq('id', cursoId).single();
            if (!curso) return;

            const precoOriginal = parseFloat(curso.preco);
            const linksDePagamento = curso.linksDePagamento || {};

            let cupomEncontrado = null;
            let linkDePagamento = null;
            let precoAExibir = precoOriginal;
            
            const configNormal = DESCONTOS_CONFIG.find(c => c.percentual === 0);
            const linkNormalInfo = linksDePagamento[configNormal.key];
            
            // Variáveis para o botão de preço normal
            const precoNormalFormatado = precoOriginal.toFixed(2).replace('.', ',');
            let buttonNormalHtml = '';

            if (linkNormalInfo && linkNormalInfo.link) {
                 buttonNormalHtml = `
                    <a href="${linkNormalInfo.link}" target="_blank" onclick="window.exibirComprovanteArea('NENHUM')" class="w-full btn-success text-white font-bold p-3 rounded-lg mb-4 flex items-center justify-center">
                        <i class="fas fa-credit-card mr-2"></i> Pague Aqui R$ ${precoNormalFormatado}
                    </a>
                `;
            } else {
                 buttonNormalHtml = `<p class="text-red-400">Erro: Link de pagamento de preço normal não configurado pelo administrador.</p>`;
            }


            // 1. Tenta encontrar um cupom de desconto (se o campo não estiver vazio)
            if (cupom.length > 0) {
                for (const config of DESCONTOS_CONFIG.filter(c => c.percentual > 0)) {
                    const linkInfo = linksDePagamento[config.key];
                    if (linkInfo && linkInfo.cupom.toUpperCase() === cupom && linkInfo.link) {
                        cupomEncontrado = config;
                        linkDePagamento = linkInfo.link;
                        
                        const descontoAplicado = config.percentual / 100;
                        precoAExibir = precoOriginal * (1 - descontoAplicado);
                        precoAExibir = Math.max(0, precoAExibir);
                        break;
                    }
                }
            }
            
            // 2. Determina qual link e status exibir
            
            // Se um cupom de desconto for encontrado
            if (cupomEncontrado && linkDePagamento) {
                const precoFormatado = precoAExibir.toFixed(2).replace('.', ',');
                
                statusCupom.innerHTML = `<i class="fas fa-check-circle mr-1"></i>Cupom **${cupom}** aplicado! ${cupomEncontrado.nome}.`;
                statusCupom.className = 'text-sm mt-2 text-green-400';
                precoDisplay.innerHTML = `
                    <span class="text-sm font-normal text-neutral-400 line-through mr-3">R$ ${precoNormalFormatado}</span>
                    R$ ${precoFormatado}
                `;
                
                // Exibir APENAS o link de desconto
                const buttonHtml = `
                    <a href="${linkDePagamento}" target="_blank" onclick="window.exibirComprovanteArea('${cupom}')" class="w-full btn-success text-white font-bold p-3 rounded-lg mb-4 flex items-center justify-center">
                        <i class="fas fa-credit-card mr-2"></i> Pague Agora (Cupom) R$ ${precoFormatado}
                    </a>
                `;
                linkPagamentoContainer.innerHTML = buttonHtml;
            
            } else {
                // Se não houver cupom válido OU se o campo estiver vazio (fallback para preço normal)
                
                precoAExibir = precoOriginal;
                precoDisplay.innerText = `Valor: R$ ${precoNormalFormatado}`;

                // Atualiza status se um cupom foi digitado mas não é válido
                if (cupom.length > 0) {
                    statusCupom.innerHTML = 'Cupom inválido ou expirado. Use o link de preço normal abaixo.';
                    statusCupom.className = 'text-sm mt-2 text-red-400';
                } else {
                    statusCupom.innerHTML = 'O preço normal está disponível abaixo. Insira um cupom para um desconto.';
                    statusCupom.className = 'text-sm mt-2 text-neutral-400';
                }
                
                // Exibir SEMPRE o link de Preço Normal (0%)
                linkPagamentoContainer.innerHTML = buttonNormalHtml;
            }
        }
        
        window.exibirComprovanteArea = function(cupom) {
            // Salva o cupom (ou "NENHUM") para persistência na inscrição
            localStorage.setItem('cupomUsado', cupom);
            
            // Esconde o teclado no mobile
            document.getElementById('inputCupom').blur(); 
            
            // Rolagem suave para a área do comprovante (melhor usabilidade)
            document.getElementById('pagamentoComprovanteArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }


        window.copiarChavePix = function() { navigator.clipboard.writeText('62.323.279/0001-00').then(() => window.mostrarModal("Chave PIX copiada!"), () => window.mostrarModal("Falha ao copiar.")); }

        window.abrirLinkPagamentoCartao = async function() {
            // Esta função foi descontinuada
        }

        window.enviarComprovante = async function(metodo = 'pagueaqui') {
            window.showLoader();
            try {
                const fileInput = document.getElementById('comprovantePagamento');

                // Validação de Comprovante de Pagamento (Obrigatório)
                if (fileInput.files.length === 0) { 
                    window.mostrarModal("Por favor, anexe o Comprovante de Pagamento."); 
                    return; 
                }
                const file = fileInput.files[0];
                
                // 1. Upload do Comprovante de Pagamento
                const filePath = `public/comprovante-${Date.now()}-${sanitizeFileName(file.name)}`;
                const { error: uploadError } = await supabaseClient.storage.from('comprovantes').upload(filePath, file);

                if (uploadError) {
                    handleStorageError(uploadError, 'comprovantes');
                    return;
                }
                const { data: { publicUrl: comprovanteUrl } } = supabaseClient.storage.from('comprovantes').getPublicUrl(filePath);

                // 2. Atualizar a inscrição do Aluno
                const { data: aluno, error: fetchError } = await supabaseClient.from('alunos').select('*').eq('email', estado.usuarioLogado.email).single();
                if (fetchError) {
                    window.mostrarModal("Erro ao encontrar seu usuário.");
                    return;
                }

                const cupomUsado = localStorage.getItem('cupomUsado') || null;

                const novaInscricao = { 
                    cursoId: estado.cursoSelecionadoId, 
                    status: 'pendente', 
                    comprovante: comprovanteUrl, 
                    comprovanteCupom: null, // Removido campo comprovante de cupom
                    cupomAplicado: (cupomUsado === 'NENHUM' || !cupomUsado ? null : cupomUsado), // Salva null se for preço normal ou se não houver
                    frequencia: {}
                };
                const novasInscricoes = [...(aluno.cursosInscritos || []), novaInscricao];

                const { error: updateError } = await supabaseClient.from('alunos').update({ cursosInscritos: novasInscricoes }).eq('id', aluno.id);
                if (updateError) {
                    window.mostrarModal("Erro ao registrar sua inscrição.");
                    console.error(updateError);
                    return;
                }
                
                window.mostrarModal("Comprovante enviado! Aguarde a aprovação do administrador.");
                
                // Limpa inputs e estados
                localStorage.removeItem('cupomUsado');
                document.getElementById('inputCupom').value = '';
                
                await window.renderizarMeusCursos(); 
                window.mudarAbaPainelAluno('meusCursos'); 
                window.mostrarTela('painelAluno');
            } finally {
                window.hideLoader();
            }
        }
        
        // ===================================================
        // TELA DO CURSO (AULA, CHAT, CERTIFICADO)
        // ===================================================
        window.acessarCurso = async function(cursoId) {
            window.showLoader();
            try {
                estado.cursoSelecionadoId = cursoId;
                estado.aulaSelecionadaIndex = 0;
                const { data: curso, error } = await supabaseClient.from('cursos').select('*').eq('id', cursoId).single();
                if(error || !curso || curso.status === 'cancelado') {
                    window.mostrarModal("Este curso não está mais disponível.");
                    return;
                }

                const usuarioTipo = estado.usuarioLogado.tipo;
                document.getElementById('tituloTelaCurso').innerText = curso.nomeDoCurso;

                const btnVoltarContainer = document.getElementById('botoesVoltarCurso');
                if (usuarioTipo === 'aluno') btnVoltarContainer.innerHTML = `<button onclick="window.mostrarTela('painelAluno'); window.mudarAbaPainelAluno('meusCursos');" class="btn-secondary px-4 py-2 rounded-lg">Voltar</button>`;
                else if (usuarioTipo === 'ministrante') btnVoltarContainer.innerHTML = `<button onclick="window.mostrarTela('painelMinistrante')" class="btn-secondary px-4 py-2 rounded-lg">Voltar</button>`;
                else if (usuarioTipo === 'admin') btnVoltarContainer.innerHTML = `<button onclick="window.mostrarTela('painelAdmin')" class="btn-secondary px-4 py-2 rounded-lg">Voltar</button>`;
                
                const abasContainer = document.getElementById('infoAbas');
                abasContainer.innerHTML = `
                    <a href="#" onclick="window.mudarAbaInfoCurso('chat', ${cursoId})" id="aba-info-chat" class="tab-info-curso border-indigo-500 text-indigo-400 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Chat</a>
                    <a href="#" onclick="window.mudarAbaInfoCurso('aulas', ${cursoId})" id="aba-info-aulas" class="tab-info-curso border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Aulas</a>
                `;
                if (usuarioTipo === 'aluno') {
                    abasContainer.innerHTML += `<a href="#" onclick="window.mudarAbaInfoCurso('frequencia', ${cursoId})" id="aba-info-frequencia" class="tab-info-curso border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Frequência</a>`;
                    abasContainer.innerHTML += `<a href="#" onclick="window.mudarAbaInfoCurso('certificado', ${cursoId})" id="aba-info-certificado" class="tab-info-curso border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Certificado</a>`;
                    abasContainer.innerHTML += `<a href="#" onclick="window.mudarAbaInfoCurso('anotacoes', ${cursoId})" id="aba-info-anotacoes" class="tab-info-curso border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Anotações</a>`;
                }
                
                let chatExtraControls = '';
                if (usuarioTipo === 'ministrante' || usuarioTipo === 'admin') {
                    chatExtraControls = `<label class="text-neutral-400 hover:text-indigo-400 p-2 text-lg cursor-pointer"><i class="fas fa-paperclip"></i><input type="file" class="hidden" onchange="window.enviarAnexo(event, ${cursoId})" accept="image/*,application/pdf"></label>`;
                    chatExtraControls += `<button type="button" onclick="window.acessarLinkMinistrante(${cursoId})" class="text-neutral-400 hover:text-indigo-400 p-2 text-lg" title="Acessar link de preparação"><i class="fas fa-external-link-alt"></i></button>`;
                }

                const conteudoContainer = document.getElementById('infoConteudoAba');
                
                const chatHtml = `
                <div id="abaConteudo-info-chat" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <div class="bg-neutral-900/50 rounded-lg flex flex-col h-[60vh]">
                            <div class="p-3 border-b border-neutral-700">
                                <h3 class="font-bold text-lg text-white">Conversa</h3>
                            </div>
                            <div id="chat-messages-${cursoId}" class="flex-grow p-4 overflow-y-auto custom-scrollbar space-y-4"></div>
                            <div class="p-4 border-t border-neutral-700">
                                <form onsubmit="window.enviarMensagem(event, ${cursoId})" class="flex gap-3 items-center">
                                    <input type="text" placeholder="Digite sua mensagem..." class="w-full p-3 rounded-full border-2 bg-neutral-800 border-neutral-700 focus:border-indigo-500 focus:ring-0">
                                    ${chatExtraControls}
                                    <button type="submit" class="btn-primary flex-shrink-0 w-12 h-12 rounded-full font-bold text-xl"><i class="fas fa-paper-plane"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="bg-neutral-900/50 rounded-lg flex flex-col h-[60vh]">
                            <div class="p-3 border-b border-neutral-700">
                                <h3 class="font-bold text-lg text-white">Materiais</h3>
                            </div>
                            <div id="listaMateriaisAgrupados" class="flex-grow p-4 overflow-y-auto custom-scrollbar"></div>
                        </div>
                    </div>
                </div>`;

                const aulasHtml = `<div id="abaConteudo-info-aulas" class="hidden h-[60vh] overflow-y-auto custom-scrollbar"><div id="listaAulasCurso" class="space-y-2"></div></div>`;
                const frequenciaHtml = (usuarioTipo === 'aluno') ? `<div id="abaConteudo-info-frequencia" class="hidden h-[60vh] overflow-y-auto custom-scrollbar"><div id="areaFrequencia" class="p-6"></div></div>` : '';
                const certificadoHtml = (usuarioTipo === 'aluno') ? `<div id="abaConteudo-info-certificado" class="hidden h-[60vh] overflow-y-auto custom-scrollbar"><div id="areaCertificado" class="text-center p-6"></div></div>` : '';
                const anotacoesHtml = (usuarioTipo === 'aluno') ? `<div id="abaConteudo-info-anotacoes" class="hidden h-[60vh] overflow-y-auto custom-scrollbar p-4"></div>` : '';
                
                conteudoContainer.innerHTML = chatHtml + aulasHtml + frequenciaHtml + certificadoHtml + anotacoesHtml;
                
                // Render content in parallel
                const renderPromises = [
                    window.renderizarListaAulas(cursoId),
                    window.renderizarChat(cursoId),
                    window.renderizarMateriaisAgrupados(cursoId),
                    window.mudarAula(cursoId, 0)
                ];

                if(usuarioTipo === 'aluno') {
                    renderPromises.push(
                        window.renderizarAreaCertificado(cursoId),
                        window.renderizarAreaFrequencia(cursoId),
                        window.renderizarAnotacoes(cursoId)
                    );
                }
                
                await Promise.all(renderPromises);

                window.mudarAbaInfoCurso('chat', cursoId);
                window.mostrarTela('telaCurso');

                if (estado.chatInterval) clearInterval(estado.chatInterval);
                estado.chatInterval = setInterval(async () => {
                    if (document.getElementById(`chat-messages-${cursoId}`)) {
                        const container = document.getElementById(`chat-messages-${cursoId}`);
                        const shouldScroll = container.scrollTop + container.clientHeight >= container.scrollHeight - 20;
                        await Promise.all([
                            window.renderizarChat(cursoId, shouldScroll),
                            window.renderizarMateriaisAgrupados(cursoId)
                        ]);
                    } else {
                        clearInterval(estado.chatInterval);
                    }
                }, 5000); 
            } finally {
                window.hideLoader();
            }
        }

        function extractUrlFromIframe(input) {
            if (!input) return null;
            if (input.trim().startsWith('<iframe')) {
                const match = input.match(/src="([^"]+)"/);
                return match ? match[1] : null;
            }
            return input; // It's already a URL
        }

        window.acessarLinkMinistrante = async function(cursoId) {
            const { data: curso, error } = await supabaseClient.from('cursos').select('aulas').eq('id', cursoId).single();
            if (error || !curso) return;

            const aulaIndex = estado.aulaSelecionadaIndex;
            const aula = curso.aulas[aulaIndex];
            if (aula && aula.linkMinistrante) {
                const url = extractUrlFromIframe(aula.linkMinistrante);
                if (url) {
                    window.open(url, '_blank');
                } else {
                    window.mostrarModal("O link de acesso do ministrante é inválido.");
                }
            } else {
                window.mostrarModal("Nenhum link de acesso definido para esta aula.");
            }
        }

        window.mudarAula = async function(cursoId, aulaIndex) {
            estado.aulaSelecionadaIndex = aulaIndex;
            const { data: curso, error } = await supabaseClient.from('cursos').select('aulas').eq('id', cursoId).single();
            if (error || !curso || !curso.aulas[aulaIndex]) {
                 document.getElementById('videoContainer').innerHTML = `<div class="w-full h-full flex items-center justify-center bg-black text-white"><p>Nenhuma aula encontrada.</p></div>`;
                return;
            }

            const aula = curso.aulas[aulaIndex];
            const videoContainer = document.getElementById('videoContainer');
            const link = aula.linkDaAula;

            if (link && link.trim().startsWith('<iframe')) {
                const iframeContainer = document.createElement('div');
                iframeContainer.innerHTML = link;
                const iframeEl = iframeContainer.querySelector('iframe');
                if(iframeEl){
                    iframeEl.className = 'w-full h-full';
                    videoContainer.innerHTML = iframeEl.outerHTML;
                } else {
                     videoContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-black text-white"><p>Link de incorporação inválido.</p></div>`;
                }
            } else if (link) {
                 videoContainer.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center bg-black text-white p-4"><a href="${link}" target="_blank" class="btn-primary py-3 px-6 rounded-lg text-lg">Acessar Transmissão</a><p class="mt-4 text-sm text-neutral-400">A transmissão será aberta em uma nova aba.</p></div>`;
            } else {
                 videoContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-black text-white"><p>Link da transmissão indisponível.</p></div>`;
            }

            document.querySelectorAll(`#listaAulasCurso .aula-item`).forEach(item => item.classList.remove('active'));
            const activeItem = document.getElementById(`aula-item-${aulaIndex}`);
            if (activeItem) activeItem.classList.add('active');
            
            if(estado.usuarioLogado.tipo === 'aluno') {
                await window.renderizarAreaFrequencia(cursoId);
            }
        }

        window.renderizarListaAulas = async function(cursoId) {
            const { data: curso, error } = await supabaseClient.from('cursos').select('aulas').eq('id', cursoId).single();
            const container = document.getElementById('listaAulasCurso');
            if (!container) return;

            container.innerHTML = '';
            if (error || !curso || !curso.aulas || curso.aulas.length === 0) {
                container.innerHTML = '<p class="text-center text-neutral-400 p-4">Nenhuma aula cadastrada para este curso.</p>';
                return;
            }

            curso.aulas.forEach((aula, index) => {
                container.innerHTML += `
                    <div id="aula-item-${index}" class="aula-item p-4 rounded-lg border-2 border-neutral-700 cursor-pointer hover:bg-neutral-800/50 transition-colors" onclick="window.mudarAula(${cursoId}, ${index})">
                        <p class="font-bold text-white">Aula ${index + 1}: ${aula.titulo}</p>
                        <p class="text-sm text-neutral-400 mt-1"><i class="fas fa-calendar-alt fa-fw mr-2"></i>${new Date(aula.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'})} | ${aula.horarioInicio} - ${aula.horarioFim}</p>
                    </div>
                `;
            });
        }

        window.mudarAbaInfoCurso = function(abaId, cursoId) {
            document.querySelectorAll('#infoConteudoAba > div').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-info-curso').forEach(tab => { 
                tab.classList.remove('border-indigo-500', 'text-indigo-400');
                tab.classList.add('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');
            });
            
            const abaContent = document.getElementById(`abaConteudo-info-${abaId}`);
            if(abaContent) abaContent.classList.remove('hidden');

            const aba = document.getElementById(`aba-info-${abaId}`);
            if(aba) {
                aba.classList.add('border-indigo-500', 'text-indigo-400');
                aba.classList.remove('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');
            }
        }
        window.enviarMensagem = async function(event, cursoId) {
            event.preventDefault();
            const input = event.target.querySelector('input[type="text"]');
            if (!input || !input.value.trim()) return;
            
            const tipoUsuario = estado.usuarioLogado.tipo;
            let fotoPerfil = null;

            if (tipoUsuario !== 'admin') {
                const { data: usuarioAtual, error: fetchError } = await supabaseClient.from(tipoUsuario + 's').select('fotoPerfil').eq('email', estado.usuarioLogado.email).single();
                if (fetchError) {
                    window.mostrarModal("Erro ao obter dados do usuário. Tente novamente.");
                    console.error("Fetch user error:", fetchError);
                    return;
                }
                fotoPerfil = usuarioAtual ? usuarioAtual.fotoPerfil : null;
            }

            const novaMensagem = { 
                curso_id: cursoId,
                type: 'mensagem', 
                sender: estado.usuarioLogado.nome, 
                senderType: estado.usuarioLogado.tipo, 
                text: input.value.trim(), 
                timestamp: new Date().toISOString(),
                fotoPerfil: fotoPerfil
            };

            const { error } = await supabaseClient.from('chats').insert([novaMensagem]);
            if (error) {
                window.mostrarModal("Erro ao enviar mensagem. Verifique sua conexão ou as permissões do banco de dados.");
                console.error("Chat insert error:", error);
            } else {
                input.value = '';
                await window.renderizarChat(cursoId, true); 
            }
        }

        window.renderizarChat = async function(cursoId, forceScroll = false) {
            const container = document.getElementById(`chat-messages-${cursoId}`);
            if (!container) return;

            const { data: mensagens, error } = await supabaseClient.from('chats').select('*').eq('curso_id', cursoId).order('timestamp', { ascending: true });
            if (error) return;

            const getInitials = (name) => {
                if (!name) return '?';
                return name.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
            };
            
            container.innerHTML = mensagens.length === 0 ? '<p class="text-center text-sm text-neutral-400">Nenhuma mensagem ainda.</p>' : '';
            
            mensagens.forEach(msg => {
                const isMyMsg = msg.sender === estado.usuarioLogado.nome;
                let senderTag = '';
                let senderClass = 'font-semibold';
                if(msg.senderType === 'admin') { senderTag = '[Admin] '; senderClass += ' text-red-400'; }
                else if(msg.senderType === 'ministrante') { senderTag = '[Ministrante] '; senderClass += ' text-indigo-400'; }
                else { senderClass += ' text-green-400' }

                const initials = getInitials(msg.sender);
                const avatarSrc = msg.fotoPerfil || `https://placehold.co/40x40/71717a/f5f5f5?text=${initials}`;
                const timestamp = new Date(msg.timestamp).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

                let messageContentHtml = '';

                if (msg.type === 'anexo') {
                    let anexoPreview = '';
                    if (msg.fileType.startsWith('image/')) {
                        anexoPreview = `<img src="${msg.fileData}" class="max-w-xs max-h-48 rounded-md mt-2 object-cover cursor-pointer" onclick="window.verImagemAmpliada('${msg.fileData}')">`;
                    } else {
                        anexoPreview = `<div class="mt-2 p-3 bg-neutral-900/50 rounded-md flex items-center gap-3"><i class="fas fa-file-pdf text-red-400 text-2xl"></i> <span class="truncate">${msg.fileName}</span></div>`;
                    }

                    let deleteButton = '';
                    if (estado.usuarioLogado.tipo === 'admin') {
                        deleteButton = `<button onclick="window.confirmarExclusaoMensagem(${msg.id}, '${msg.fileData}')" class="text-red-400 hover:text-red-300 text-xs ml-auto flex-shrink-0 p-1"><i class="fas fa-trash"></i></button>`;
                    }

                    messageContentHtml = `
                        <div class="flex justify-between items-start">
                            <p class="text-white text-sm">Enviou um anexo:</p>
                            ${deleteButton}
                        </div>
                        <a href="${msg.fileData}" download="${msg.fileName}" target="_blank" rel="noopener noreferrer" class="block text-left mt-1">${anexoPreview}</a>
                    `;

                } else { 
                    let deleteButtonHtml = '';
                    if (estado.usuarioLogado.tipo === 'admin') {
                         deleteButtonHtml = `<button onclick="window.confirmarExclusaoMensagem(${msg.id}, null)" class="text-red-400 hover:text-red-300 text-xs ml-2 opacity-50 hover:opacity-100 flex-shrink-0"><i class="fas fa-trash"></i></button>`;
                    }
                    messageContentHtml = `
                        <div class="flex items-start justify-between w-full">
                            <p class="text-white text-sm whitespace-pre-wrap flex-grow">${msg.text}</p>
                            ${deleteButtonHtml}
                        </div>`;
                }

                container.innerHTML += `
                    <div class="flex items-end gap-3 ${isMyMsg ? 'justify-end' : ''}">
                        <img src="${avatarSrc}" class="w-8 h-8 rounded-full object-cover flex-shrink-0 ${isMyMsg ? 'order-2' : 'order-1'}">
                        <div class="max-w-xs md:max-w-md ${isMyMsg ? 'order-1' : 'order-2'}">
                            <div class="p-3 rounded-2xl ${isMyMsg ? 'bg-indigo-700 rounded-br-lg' : 'bg-neutral-700 rounded-bl-lg'}">
                                <p class="${senderClass} text-sm mb-1">${senderTag}${msg.sender}</p>
                                ${messageContentHtml}
                            </div>
                            <p class="text-xs text-neutral-500 mt-1 px-1 ${isMyMsg ? 'text-right' : 'text-left'}">${timestamp}</p>
                        </div>
                    </div>
                `;
            });

            if (forceScroll) {
                container.scrollTop = container.scrollHeight;
            }
        }

        window.renderizarMateriaisAgrupados = async function(cursoId) {
            const container = document.getElementById('listaMateriaisAgrupados');
            if (!container) return;

            const { data: mensagensAnexo, error } = await supabaseClient.from('chats').select('*').eq('curso_id', cursoId).eq('type', 'anexo');
            if (error) return;

            if (mensagensAnexo.length === 0) {
                container.innerHTML = '<p class="text-center text-sm text-neutral-400">Nenhum material compartilhado no chat.</p>';
                return;
            }

            container.innerHTML = '';
            mensagensAnexo.forEach(msg => {
                const icon = msg.fileType.startsWith('image/') ? 'fa-file-image' : 'fa-file-pdf';
                const color = msg.fileType.startsWith('image/') ? 'text-blue-400' : 'text-red-400';

                let deleteButton = '';
                if (estado.usuarioLogado.tipo === 'admin') {
                    deleteButton = `<button onclick="event.preventDefault(); event.stopPropagation(); window.confirmarExclusaoMensagem(${msg.id}, '${msg.fileData}')" class="text-red-400 hover:text-red-300 ml-auto p-2 flex-shrink-0"><i class="fas fa-trash"></i></button>`;
                }

                container.innerHTML += `
                    <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-neutral-800 transition-colors">
                        <a href="${msg.fileData}" download="${msg.fileName}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 flex-grow truncate">
                            <i class="fas ${icon} ${color} fa-lg w-6 text-center"></i>
                            <div class="flex-grow truncate">
                                <p class="text-sm font-semibold truncate">${msg.fileName}</p>
                                <p class="text-xs text-neutral-400">por ${msg.sender}</p>
                            </div>
                        </a>
                        ${deleteButton}
                    </div>
                `;
            });
        }

        window.enviarAnexo = async function(event, cursoId) {
            const file = event.target.files[0];
            if (!file) return;

            window.showLoader();
            try {
                const sanitizedFileName = sanitizeFileName(file.name);
                const filePath = `public/chat-${cursoId}-${Date.now()}-${sanitizedFileName}`;

                const { error: uploadError } = await supabaseClient.storage.from('chats').upload(filePath, file);

                if (uploadError) {
                    handleStorageError(uploadError, 'chats');
                    return;
                }

                const { data: { publicUrl } } = supabaseClient.storage.from('chats').getPublicUrl(filePath);

                const tipoUsuario = estado.usuarioLogado.tipo;
                let fotoPerfil = null;

                if (tipoUsuario !== 'admin') {
                    const { data: usuarioAtual, error: fetchError } = await supabaseClient.from(tipoUsuario + 's').select('fotoPerfil').eq('email', estado.usuarioLogado.email).single();
                    if (fetchError) {
                        window.mostrarModal("Erro ao obter dados do usuário. Tente novamente.");
                        console.error("Fetch user error:", fetchError);
                        return;
                    }
                    fotoPerfil = usuarioAtual ? usuarioAtual.fotoPerfil : null;
                }

                const novoAnexo = {
                    curso_id: cursoId,
                    type: 'anexo',
                    sender: estado.usuarioLogado.nome,
                    senderType: estado.usuarioLogado.tipo,
                    fileName: file.name,
                    fileType: file.type,
                    fileData: publicUrl,
                    timestamp: new Date().toISOString(),
                    fotoPerfil: fotoPerfil
                };

                const { error: insertError } = await supabaseClient.from('chats').insert([novoAnexo]);

                if(insertError) {
                    window.mostrarModal("Erro ao registrar anexo no chat. Verifique as permissões do banco de dados.");
                    console.error("Chat insert error (anexo):", insertError);
                } else {
                    await window.renderizarChat(cursoId, true);
                    await window.renderizarMateriaisAgrupados(cursoId);
                }
            } finally {
                window.hideLoader();
                event.target.value = ''; // Reset input
            }
        }

        window.confirmarExclusaoMensagem = function(mensagemId, fileUrl) {
            const mensagem = fileUrl ? 'Tem certeza que deseja excluir esta mensagem e seu anexo? Esta ação é irreversível.' : 'Tem certeza que deseja excluir esta mensagem?';
            window.mostrarConfirmacao(mensagem, () => excluirMensagem(mensagemId, fileUrl));
        }

        async function excluirMensagem(mensagemId, fileUrl) {
            window.showLoader();
            try {
                if (fileUrl && fileUrl !== 'null') { 
                    const urlParts = fileUrl.split('/chats/');
                    if (urlParts.length > 1) { 
                        const filePath = urlParts[1];
                        const { error: storageError } = await supabaseClient.storage.from('chats').remove([filePath]);
                        if (storageError && storageError.statusCode !== '404') {
                            console.error("Erro ao excluir anexo do Storage:", storageError);
                        }
                    }
                }

                const { error: dbError } = await supabaseClient.from('chats').delete().eq('id', mensagemId);
                if (dbError) throw dbError;
                
                window.mostrarModal("Mensagem excluída com sucesso!");
                await window.renderizarChat(estado.cursoSelecionadoId, false);
                await window.renderizarMateriaisAgrupados(estado.cursoSelecionadoId);
            } catch (error) {
                window.mostrarModal("Ocorreu um erro ao excluir a mensagem.");
                console.error("Erro ao excluir mensagem:", error);
            } finally {
                window.hideLoader();
            }
        }

        window.renderizarAnotacoes = async function(cursoId) {
            const container = document.getElementById('abaConteudo-info-anotacoes');
            if (!container) return;

            const { data: aluno, error } = await supabaseClient.from('alunos').select('*').eq('email', estado.usuarioLogado.email).single();
            if (error || !aluno) {
                container.innerHTML = '<p>Erro ao carregar anotações.</p>';
                return;
            }

            const inscricao = aluno.cursosInscritos.find(i => i.cursoId == cursoId);
            const texto = inscricao?.anotacoesTexto || '';
            const arquivos = inscricao?.anotacoesArquivos || [];

            let arquivosHtml = '<p class="text-sm text-neutral-500 mt-2">Nenhum anexo.</p>';
            if (arquivos.length > 0) {
                arquivosHtml = arquivos.map(file => `
                    <div class="flex items-center justify-between bg-neutral-800 p-2 rounded-md">
                        <a href="${file.url}" target="_blank" download="${file.name}" class="text-indigo-400 hover:underline truncate text-sm">
                            <i class="fas fa-file-alt mr-2"></i>${file.name}
                        </a>
                        <button onclick="window.confirmarExcluirAnexoAnotacao(${cursoId}, '${file.url}')" class="text-red-400 hover:text-red-300 text-xs p-1"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('');
            }

            container.innerHTML = `
                <div>
                    <h3 class="font-bold text-lg mb-2">Resumo e Pontos Importantes</h3>
                    <textarea id="anotacoesTexto-${cursoId}" class="w-full p-3 rounded-lg border-2 h-40 custom-scrollbar">${texto}</textarea>
                    <button onclick="window.salvarAnotacaoTexto(${cursoId})" class="btn-primary font-bold py-2 px-4 rounded-lg mt-2">Salvar Texto</button>
                </div>
                <div class="mt-6">
                    <h3 class="font-bold text-lg mb-2">Meus Anexos</h3>
                    <div class="mb-4">
                        <label class="btn-secondary text-sm px-3 py-2 rounded-lg cursor-pointer">
                            <i class="fas fa-upload mr-2"></i> Enviar Arquivo
                            <input type="file" class="hidden" onchange="window.enviarAnexoAnotacao(event, ${cursoId})">
                        </label>
                    </div>
                    <div id="lista-anexos-anotacoes" class="space-y-2">
                        ${arquivosHtml}
                    </div>
                </div>
            `;
        }

        window.salvarAnotacaoTexto = async function(cursoId) {
            window.showLoader();
            try {
                const texto = document.getElementById(`anotacoesTexto-${cursoId}`).value;
                const { data: aluno } = await supabaseClient.from('alunos').select('*').eq('email', estado.usuarioLogado.email).single();
                
                if (!aluno) { window.mostrarModal('Erro ao salvar anotação: aluno não encontrado.'); return; }


                const inscricaoIndex = aluno.cursosInscritos.findIndex(i => i.cursoId == cursoId);
                if (inscricaoIndex > -1) {
                    if(!aluno.cursosInscritos[inscricaoIndex].anotacoesTexto) aluno.cursosInscritos[inscricaoIndex].anotacoesTexto = '';
                    aluno.cursosInscritos[inscricaoIndex].anotacoesTexto = texto;
                    const { error: updateError } = await supabaseClient.from('alunos').update({ cursosInscritos: aluno.cursosInscritos }).eq('id', aluno.id);
                    if (updateError) {
                        window.mostrarModal('Erro ao salvar anotação.');
                    } else {
                        window.mostrarModal('Anotação salva com sucesso!');
                    }
                }
            } finally {
                window.hideLoader();
            }
        }

        window.enviarAnexoAnotacao = async function(event, cursoId) {
            const file = event.target.files[0];
            if (!file) return;
            
            window.showLoader();
            try {
                const { data: aluno, error: fetchError } = await supabaseClient.from('alunos').select('id, cursosInscritos').eq('email', estado.usuarioLogado.email).single();
                if (fetchError) { window.mostrarModal('Erro ao buscar dados do aluno.'); return; }

                const filePath = `public/aluno-${aluno.id}-curso-${cursoId}-${Date.now()}-${sanitizeFileName(file.name)}`;
                const { error: uploadError } = await supabaseClient.storage.from('anotacoes-alunos').upload(filePath, file);

                if (uploadError) {
                    handleStorageError(uploadError, 'anotacoes-alunos');
                    return;
                }

                const { data: { publicUrl } } = supabaseClient.storage.from('anotacoes-alunos').getPublicUrl(filePath);

                const inscricaoIndex = aluno.cursosInscritos.findIndex(i => i.cursoId == cursoId);
                if (inscricaoIndex > -1) {
                    if (!aluno.cursosInscritos[inscricaoIndex].anotacoesArquivos) {
                        aluno.cursosInscritos[inscricaoIndex].anotacoesArquivos = [];
                    }
                    aluno.cursosInscritos[inscricaoIndex].anotacoesArquivos.push({ name: file.name, url: publicUrl });

                    const { error: updateError } = await supabaseClient.from('alunos').update({ cursosInscritos: aluno.cursosInscritos }).eq('id', aluno.id);
                    if (updateError) {
                        window.mostrarModal('Erro ao salvar anexo.');
                    } else {
                        window.mostrarModal('Anexo salvo!');
                        await window.renderizarAnotacoes(cursoId);
                    }
                }
            } finally {
                window.hideLoader();
                event.target.value = ''; // Reset input
            }
        }

        window.confirmarExcluirAnexoAnotacao = function(cursoId, fileUrl) {
            window.mostrarConfirmacao('Tem certeza que deseja excluir este anexo?', () => excluirAnexoAnotacao(cursoId, fileUrl));
        }

        async function excluirAnexoAnotacao(cursoId, fileUrl) {
            window.showLoader();
            try {
                const urlParts = fileUrl.split('/anotacoes-alunos/');
                if (urlParts.length < 2) throw new Error("URL do arquivo inválida.");
                const filePath = urlParts[1];

                const { error: storageError } = await supabaseClient.storage.from('anotacoes-alunos').remove([filePath]);
                if (storageError) {
                     if (storageError.message && storageError.message.toLowerCase().includes('bucket not found')) {
                         window.mostrarModal("Erro de Configuração: O bucket 'anotacoes-alunos' não foi encontrado. Não é possível excluir o anexo.");
                         return;
                    }
                    if (storageError.statusCode !== '404') throw storageError;
                }

                const { data: aluno, error: fetchError } = await supabaseClient.from('alunos').select('*').eq('email', estado.usuarioLogado.email).single();
                if (fetchError) throw fetchError;
                
                const inscricaoIndex = aluno.cursosInscritos.findIndex(i => i.cursoId == cursoId);
                if (inscricaoIndex > -1 && aluno.cursosInscritos[inscricaoIndex].anotacoesArquivos) {
                    aluno.cursosInscritos[inscricaoIndex].anotacoesArquivos = aluno.cursosInscritos[inscricaoIndex].anotacoesArquivos.filter(f => f.url !== fileUrl);
                    
                    const { error: updateError } = await supabaseClient.from('alunos').update({ cursosInscritos: aluno.cursosInscritos }).eq('id', aluno.id);
                    if (updateError) throw updateError;
                }

                window.mostrarModal("Anexo excluído com sucesso!");
                await window.renderizarAnotacoes(cursoId);

            } catch (error) {
                window.mostrarModal("Ocorreu um erro ao excluir o anexo.");
                console.error("Erro ao excluir anexo de anotação:", error);
            } finally {
                window.hideLoader();
            }
        }

        async function renderizarAreaCertificado(cursoId) {
            const area = document.getElementById('areaCertificado');
            const { data: aluno } = await supabaseClient.from('alunos').select('*').eq('email', estado.usuarioLogado.email).single();
            if (error || !aluno) return;

            const inscricao = Array.isArray(aluno.cursosInscritos) ? aluno.cursosInscritos.find(i => i.cursoId == cursoId) : null;
            if(!inscricao) return; // Se não houver inscrição, não faz nada.

            const { status } = await calcularStatusFrequencia(aluno, cursoId);

            if (status !== 'Presente') {
                 area.innerHTML = `<i class="fas fa-times-circle text-yellow-400 text-4xl mb-3"></i><h4 class="font-bold">Certificado Indisponível</h4><p class="text-neutral-300 text-sm mb-4">Sua frequência no curso não foi suficiente para a emissão do certificado.</p>`;
                 return;
            }
            
            if (inscricao.certificadoCodigo) {
                area.innerHTML = `<i class="fas fa-check-circle text-green-400 text-4xl mb-3"></i><h4 class="font-bold">Certificado Liberado</h4><p class="text-neutral-300 text-sm mb-4">Seu código:</p><p class="font-mono bg-neutral-900 p-2 rounded-lg text-lg">${inscricao.certificadoCodigo}</p><button onclick="window.visualizarCertificado('aluno', '${inscricao.certificadoCodigo}')" class="btn-primary w-full mt-4 py-2 rounded-lg">Visualizar Certificado</button>`;
            } else {
                area.innerHTML = `<i class="fas fa-tasks text-indigo-400 text-4xl mb-3"></i><h4 class="font-bold">Certificado Pendente</h4><p class="text-neutral-300 text-sm mb-4">Você já cumpriu os requisitos. Aguardando liberação pelo administrador.</p>`;
            }
        }

        async function gerarHtmlCertificado(tipo, codigo) {
            let info = null;
            let dataEmissao = null;
            
            if (tipo === 'aluno') {
                const { data: alunos } = await supabaseClient.from('alunos').select('*');
                 for (const aluno of alunos) { 
                     const inscricao = Array.isArray(aluno.cursosInscritos) ? aluno.cursosInscritos.find(i => i.certificadoCodigo === codigo) : null; 
                     if (inscricao) { 
                         const { data: curso } = await supabaseClient.from('cursos').select('*').eq('id', inscricao.cursoId).single();
                         info = { usuario: aluno, curso }; 
                         dataEmissao = new Date(inscricao.certificadoEmitidoEm);
                         break; 
                    } 
                }
            } else { // ministrante
                 const { data: ministrantes } = await supabaseClient.from('ministrantes').select('*');
                 for (const ministrante of ministrantes) { 
                     const vinculo = Array.isArray(ministrante.cursosVinculados) ? ministrante.cursosVinculados.find(v => v.cursoId == codigo.split('-')[2]) : null; 
                     if(vinculo && vinculo.certificadoCodigo === codigo) { 
                         const { data: curso } = await supabaseClient.from('cursos').select('*').eq('id', vinculo.cursoId).single();
                         info = { usuario: ministrante, curso }; 
                         dataEmissao = new Date(vinculo.certificadoEmitidoEm);
                         break; 
                    } 
                }
            }

            if (!info) { return '<p>Certificado não encontrado.</p>'; }
            
            const { usuario, curso } = info;
            
            let dataCursoTexto = '';
            if (curso.aulas && curso.aulas.length > 0) {
                const aulasOrdenadas = [...curso.aulas].sort((a, b) => new Date(a.data) - new Date(b.data));
                const dataInicio = new Date(aulasOrdenadas[0].data).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                const dataFim = new Date(aulasOrdenadas[aulasOrdenadas.length - 1].data).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                dataCursoTexto = dataInicio === dataFim ? `realizado em ${dataInicio}` : `realizado no período de ${dataInicio} a ${dataFim}`;
            }

            const cargaHoraria = tipo === 'aluno' ? curso.cargaHorariaAluno : curso.cargaHorariaMinistrante;
            
            const textoPrincipal = tipo === 'aluno'
                ? `<p class="text-lg text-neutral-300 mb-2">Certificamos que</p>
                   <p class="text-3xl font-bold text-white mb-2">${usuario.nomeCompleto}</p>
                   <p class="text-lg text-neutral-300 mb-2">concluiu com aproveitamento o curso de</p>`
                : `<p class="text-lg text-neutral-300 mb-2">Certificamos para os devidos fins que</p>
                   <p class="text-3xl font-bold text-white mb-2">${usuario.nomeCompleto}</p>
                   <p class="text-lg text-neutral-300 mb-2">portador(a) do CPF nº ${usuario.cpfCnpj}, atuou como palestrante no minicurso</p>`;

            let aulasHtml = curso.aulas.map(aula => `<li><strong>${aula.titulo}:</strong> ${aula.topicos}</li>`).join('');
            if (tipo === 'ministrante') {
                const aulasDoMinistrante = curso.aulas.filter(aula => aula.ministrantes.includes(usuario.nomeCompleto));
                aulasHtml = aulasDoMinistrante.map(aula => `<li><strong>${aula.titulo}:</strong> ${aula.topicos}</li>`).join('');
            }

            let ministrantesHtml = '';
            if (tipo === 'aluno') {
                const nomesMinistrantes = [...new Set(curso.aulas.flatMap(a => a.ministrantes))];
                const { data: todosMinistrantes } = await supabaseClient.from('ministrantes').select('*');
                ministrantesHtml = nomesMinistrantes.map(nome => {
                    const ministranteInfo = todosMinistrantes.find(m => m.nomeCompleto === nome);
                    if (!ministranteInfo) return `<p>${nome}</p>`;
                    // Lógica de titulação atualizada
                    const qualificacoes = Object.entries(ministranteInfo.formacao)
                        .filter(([key, value]) => value)
                        .map(([key, value]) => {
                            let tituloDisplay = key;
                            const isFeminino = isNomeFeminino(nome);
                            if (key === 'mestreEm') tituloDisplay = isFeminino ? 'Mestra em' : 'Mestre em';
                            else if (key === 'doutorEm') tituloDisplay = isFeminino ? 'Doutora em' : 'Doutor em';
                            return `${tituloDisplay.replace('Em', '').replace(/([A-Z])/g, ' $1').trim()}: ${value}`;
                        }).join(', ');
                        
                    return `<div class="mb-2"><p class="font-bold">${ministranteInfo.nomeCompleto}</p><p class="text-xs text-neutral-400">${qualificacoes}</p></div>`;
                }).join('');
            }

            const assinaturaHtml = `<div class="w-64"><img src="${curso.assinaturaAdmin}" class="max-h-16 mx-auto" alt="Assinatura"></div><div class="border-t-2 border-neutral-400 w-64 mx-auto pt-2"><p class="text-xs text-neutral-500">(Assinatura da Empresa)</p></div>`;
            const dataEmissaoFormatada = `Juazeiro do Norte, ${dataEmissao.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' })}`;

            let contentGridHtml = '';
             if (tipo === 'aluno') {
                contentGridHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-8 my-8 text-sm relative z-10 text-left"><div><h3 class="font-bold text-lg text-indigo-300 mb-3 border-b border-indigo-500/50 pb-1">Conteúdo Programático</h3><ul class="list-disc list-inside space-y-1 text-neutral-300">${aulasHtml}</ul></div><div><h3 class="font-bold text-lg text-indigo-300 mb-3 border-b border-indigo-500/50 pb-1">Ministrante(s)</h3><div class="space-y-2 text-neutral-300">${ministrantesHtml}</div></div></div>`;
            } else {
                contentGridHtml = `<div class="my-8 text-sm relative z-10 text-left"><div><h3 class="font-bold text-lg text-indigo-300 mb-3 border-b border-indigo-500/50 pb-1">Conteúdo Programático</h3><ul class="list-disc list-inside space-y-1 text-neutral-300">${aulasHtml}</ul></div></div>`;
            }

            return `
                <div class="certificado-individual bg-neutral-800 text-white rounded-lg shadow-2xl border-4 border-indigo-500/50 p-8 relative overflow-hidden">
                    <div class="absolute -top-16 -left-16 w-48 h-48 border-8 border-indigo-500/20 rounded-full"></div>
                    <div class="absolute -bottom-20 -right-10 w-64 h-64 border-[12px] border-purple-500/20 rounded-full"></div>
                    <div class="text-center relative z-10"><h1 class="text-4xl font-bold nexus-gradient-text mb-2">CERTIFICADO</h1></div>
                    <div class="text-center my-8 relative z-10">${textoPrincipal}<p class="text-2xl font-semibold text-indigo-300">${curso.nomeDoCurso}</p><p class="text-neutral-400 mt-1 text-sm">com carga horária de ${cargaHoraria} horas, ${dataCursoTexto}.</p></div>
                    ${tipo === 'ministrante' ? `<p class="text-center my-8 text-lg">${dataEmissaoFormatada}.</p>` : ''}
                    ${contentGridHtml}
                    <div class="flex justify-center items-center mt-12 text-center relative z-10"><div>${assinaturaHtml}<div class="mt-4 text-xs text-neutral-300"><p class="font-bold">Maria Jaqueline da Silva Pereira</p><p>CNPJ: 62.323.279/0001-00</p>${tipo === 'aluno' ? `<p>Emitido em: ${dataEmissao.toLocaleDateString('pt-BR')}</p>` : ''}</div></div></div>
                    <div class="border-t border-neutral-600 mt-10 pt-4 text-xs text-neutral-400 relative z-10"><div class="flex justify-end"><div class="text-right"><p class="font-bold">Código de Validação:</p><p class="font-mono">${codigo}</p></div></div></div>
                </div>`;
        }
        
        window.visualizarCertificado = async function(tipo, codigo) {
            window.showLoader();
            try {
                const certificadoHtml = await gerarHtmlCertificado(tipo, codigo);
                if(certificadoHtml.includes("não encontrado")) { window.mostrarModal("Certificado não encontrado."); return; }
                const modalContent = `
                    <div id="certificado-para-imprimir">${certificadoHtml}</div>
                    <div class="flex justify-end mt-4 gap-2">
                        <button onclick="window.imprimirCertificado('certificado-para-imprimir')" class="btn-success text-white px-4 py-2 rounded-lg">Imprimir PDF</button>
                        <button onclick="window.fecharModal('modalDetalhes')" class="btn-secondary px-4 py-2 rounded-lg">Fechar</button>
                    </div>`;
                
                document.getElementById('conteudoModalDetalhes').innerHTML = modalContent;
                document.querySelector('#modalDetalhes .modal-content').style.maxWidth = '900px';
                window.mostrarModal('', 'modalDetalhes');
            } finally {
                window.hideLoader();
            }
        }

        window.validarCertificadoPeloCodigo = async function() { 
            const codigo = document.getElementById('codigoValidacao').value.trim(); 
            if (!codigo) { window.mostrarModal("Insira um código."); return; }
            const tipo = codigo.startsWith('NEXUS-AL') ? 'aluno' : 'ministrante';
            await window.visualizarCertificado(tipo, codigo); 
        }

        window.imprimirCertificado = function(elementId) {
            const elemento = document.getElementById(elementId);
            const opt = {
                margin:       0,
                filename:     `certificado_${elementId}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, backgroundColor: null },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'landscape' }
            };
            html2pdf().set(opt).from(elemento).save();
        }

        // ===================================================
        // PAINEL DO MINISTRANTE
        // ===================================================
        window.mudarAbaPainelMinistrante = function(abaId) {
            document.querySelectorAll('#conteudoAbaMinistrante > div').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-ministrante').forEach(tab => { 
                tab.classList.remove('border-indigo-500', 'text-indigo-400'); 
                tab.classList.add('border-transparent', 'text-gray-400'); 
            });
            
            document.getElementById(`abaConteudo-${abaId}`).classList.remove('hidden'); 
            document.getElementById(`aba-${abaId}`).classList.add('border-indigo-500', 'text-indigo-400');

            if (abaId === 'contratoMinistrante') {
                window.renderizarAreaContratoMinistrante(estado.usuarioLogado.email);
            }
        }

        async function renderizarPainelMinistrante() {
            window.showLoader();
            try {
                const [
                    { data: ministrante, error: ministranteError },
                    { data: todosCursos, error: cursosError },
                    { data: todosAlunos, error: alunosError }
                ] = await Promise.all([
                    supabaseClient.from('ministrantes').select('*').eq('email', estado.usuarioLogado.email).single(),
                    supabaseClient.from('cursos').select('*'),
                    supabaseClient.from('alunos').select('cursosInscritos')
                ]);

                if (ministranteError || cursosError || alunosError) {
                    console.error("Error fetching minister panel data:", ministranteError || cursosError || alunosError);
                    document.getElementById('listaCursosMinistrante').innerHTML = '<p>Error loading your courses.</p>';
                    return;
                }

                const container = document.getElementById('listaCursosMinistrante');
                const cursosVinculados = todosCursos.filter(c => c.status !== 'cancelado' && c.aulas.some(a => a.ministrantes.includes(ministrante.nomeCompleto)));
                
                container.innerHTML = '';
                if (cursosVinculados.length === 0) container.innerHTML = '<p class="text-center text-neutral-400 bg-neutral-800 p-6 rounded-lg">Você não foi vinculado a nenhum curso.</p>';
                else {
                    cursosVinculados.forEach(curso => {
                        const hoje = new Date().toISOString().split('T')[0];
                        let cursoConcluido = false;
                        if (curso.aulas && curso.aulas.length > 0) {
                            const aulasOrdenadas = [...curso.aulas].sort((a, b) => new Date(b.data) - new Date(a.data));
                            const dataUltimaAula = aulasOrdenadas[0].data;
                            cursoConcluido = dataUltimaAula < hoje;
                        }
                        const vinculo = Array.isArray(ministrante.cursosVinculados) ? ministrante.cursosVinculados.find(v => v.cursoId == curso.id) || {} : {};
                        let acoesMinistrante = `
                            <button onclick="window.acessarCurso(${curso.id})" class="btn-primary w-full py-2 rounded-lg">Acessar Sala</button>
                        `;

                        if(vinculo.certificadoCodigo) {
                            acoesMinistrante += `<button onclick="window.visualizarCertificado('ministrante', '${vinculo.certificadoCodigo}')" class="btn-success text-white w-full py-2 rounded-lg">Ver Certificado</button>`;
                        } else if (cursoConcluido) {
                            acoesMinistrante += `<button class="btn-secondary w-full py-2 rounded-lg" disabled>Certificado (Aguardando Liberação)</button>`;
                        }
                        if (vinculo.comprovantePagamento) acoesMinistrante += `<a href="${vinculo.comprovantePagamento}" download="comprovante-pagamento.pdf" class="btn-secondary text-center w-full py-2 rounded-lg">Ver Pagamento</a>`;
                        
                        const alunosInscritos = todosAlunos.filter(a => Array.isArray(a.cursosInscritos) && a.cursosInscritos.some(i => i.cursoId == curso.id && i.status === 'aprovado')).length;
                        const cotaAtingida = alunosInscritos >= curso.cotaMinima;
                        const cotaStatusHtml = cotaAtingida 
                            ? `<span class="text-xs font-semibold py-1 px-2 rounded-full bg-green-500/20 text-green-400"><i class="fas fa-check-circle mr-1"></i>Cota Atingida</span>`
                            : `<span class="text-xs font-semibold py-1 px-2 rounded-full bg-yellow-500/20 text-yellow-400"><i class="fas fa-exclamation-triangle mr-1"></i>Aguardando Cota (${alunosInscritos}/${curso.cotaMinima})</span>`;

                        const valorTotal = alunosInscritos * parseFloat(curso.preco); const ganhoMinistrante = valorTotal * 0.10;
                        container.innerHTML += `
                            <div class="glassmorphism p-6 rounded-lg">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-xl font-bold">${curso.nomeDoCurso}</h3>
                                    ${cotaStatusHtml}
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 text-center">
                                    <div class="bg-neutral-800 p-4 rounded-lg"><p class="text-sm text-neutral-400">Alunos</p><p class="text-2xl font-bold">${alunosInscritos}</p></div>
                                    <div class="bg-neutral-800 p-4 rounded-lg"><p class="text-sm text-neutral-400">Faturamento</p><p class="text-2xl font-bold">R$ ${valorTotal.toFixed(2).replace('.',',')}</p></div>
                                    <div class="bg-neutral-800 p-4 rounded-lg"><p class="text-sm text-neutral-400">Seu Ganho (10%)</p><p class="text-2xl font-bold text-green-400">R$ ${ganhoMinistrante.toFixed(2).replace('.',',')}</p></div>
                                </div>
                                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">${acoesMinistrante}</div>
                            </div>`;
                    });
                }
                await renderizarPerfil('abaConteudo-perfilMinistrante', 'ministrante');
            } catch (e) {
                console.error("Error rendering minister panel:", e);
                document.getElementById('listaCursosMinistrante').innerHTML = '<p>Error loading data.</p>';
            } finally {
                window.hideLoader();
            }
        }
        window.renderizarAreaContratoMinistrante = async function(ministranteEmail) {
            const areaContrato = document.getElementById('areaContratoMinistrante');
            const { data: ministrante, error } = await supabaseClient.from('ministrantes').select('contrato').eq('email', ministranteEmail).single();

            if (error || !ministrante) {
                areaContrato.innerHTML = '<p>Erro ao carregar dados do contrato.</p>';
                return;
            }

            if (ministrante.contrato.assinadoPeloMinistrante) {
                areaContrato.innerHTML = `<p class="text-green-400 mb-4 font-semibold">Contrato assinado e enviado!</p><a href="${ministrante.contrato.assinadoPeloMinistrante}" target="_blank" rel="noopener noreferrer" download="contrato-assinado.pdf" class="btn-primary py-2 px-4 rounded-lg">Baixar Cópia Assinada</a>`;
            } else if (ministrante.contrato.enviadoPeloAdmin) {
                areaContrato.innerHTML = `<p class="text-yellow-400 mb-4 font-semibold">Contrato disponível para assinatura.</p><a href="${ministrante.contrato.enviadoPeloAdmin}" target="_blank" rel="noopener noreferrer" download="contrato-nexus.pdf" class="btn-primary py-2 px-4 rounded-lg">Baixar Contrato</a><div class="mt-4 border-t border-neutral-600 pt-4"><label for="uploadContrato" class="block text-sm mb-2">Envie o contrato assinado (.pdf):</label><input type="file" id="uploadContrato" accept=".pdf" onchange="window.enviarContratoAssinado(event, '${ministranteEmail}')"></div>`;
            } else {
                areaContrato.innerHTML = `<p class="text-neutral-400 mb-4">Nenhum contrato enviado pelo administrador.</p>`;
            }
        }
        window.enviarContratoAssinado = async function(event, ministranteEmail) {
            const file = event.target.files[0]; if(!file) return;
            window.showLoader();
            try {
                const filePath = `public/contrato-assinado-${Date.now()}-${sanitizeFileName(file.name)}`;
                const { error: uploadError } = await supabaseClient.storage.from('contratos').upload(filePath, file);
                if (uploadError) {
                    handleStorageError(uploadError, 'contratos');
                    return;
                }

                const { data: { publicUrl } } = supabaseClient.storage.from('contratos').getPublicUrl(filePath);

                const { data: ministrante, error: fetchError } = await supabaseClient.from('ministrantes').select('contrato').eq('email', ministranteEmail).single();
                if (fetchError) return;

                const novoContrato = { ...ministrante.contrato, assinadoPeloMinistrante: publicUrl };
                const { error: updateError } = await supabaseClient.from('ministrantes').update({ contrato: novoContrato }).eq('email', ministranteEmail);
                
                if (!updateError) {
                    await window.renderizarAreaContratoMinistrante(ministranteEmail);
                    window.mostrarModal("Contrato assinado enviado com sucesso!");
                }
            } finally {
                window.hideLoader();
            }
        }

        // ===================================================
        // PAINEL DO ADMINISTRADOR
        // ===================================================
        window.mudarAbaPainelAdmin = async function(abaId) {
            // Esconde todas as divs de conteúdo primeiro
            document.querySelectorAll('#conteudoAbaAdmin > div').forEach(c => c.classList.add('hidden'));
            // Estiliza os separadores
            document.querySelectorAll('.tab-admin').forEach(tab => { 
                tab.classList.remove('border-indigo-500', 'text-indigo-400'); 
                tab.classList.add('border-transparent', 'text-gray-400'); 
            });
            
            // Mostra a div de conteúdo alvo e estiliza o separador ativo
            const contentDiv = document.getElementById(`abaConteudo-${abaId}`);
            if (contentDiv) contentDiv.classList.remove('hidden');
            
            const tabLink = document.getElementById(`aba-${abaId}`);
            if (tabLink) tabLink.classList.add('border-indigo-500', 'text-indigo-400');

            // Busca e renderiza novamente os dados para o separador selecionado
            switch (abaId) {
                case 'gerenciarCursos':
                    await window.renderizarPainelAdminCursos();
                    break;
                case 'gerenciarAprovacoes':
                    await window.renderizarPainelAdminAprovacoes();
                    break;
                case 'gerenciarReembolsos':
                    // Mantido, mas vazio, para não quebrar o switch, mas a aba foi removida do HTML
                    await window.renderizarPainelAdminReembolsos(); 
                    break;
                case 'gerenciarCertificados':
                    await window.renderizarPainelAdminCertificados();
                    break;
                case 'gerenciarAlunos':
                    await window.renderizarPainelAdminAlunos();
                    break;
                case 'gerenciarMinistrantes':
                    await window.renderizarPainelAdminMinistrantes();
                    break;
                case 'gerenciarEmpresas':
                    await window.renderizarPainelAdminEmpresas();
                    break;
                case 'gerenciarParceiros':
                    await window.renderizarPainelAdminParceiros();
                    break;
            }
        }
        async function renderizarPainelAdmin() { 
            // Apenas renderiza o separador padrão no carregamento inicial
            await window.renderizarPainelAdminCursos();
        }
        
        window.renderizarPainelAdminCursos = async function() {
            window.showLoader();
            try {
                const container = document.getElementById('listaCursosAdmin');
                const [{ data: cursos, error: cursosError }, { data: todosAlunos, error: alunosError }] = await Promise.all([
                    supabaseClient.from('cursos').select('*'),
                    supabaseClient.from('alunos').select('cursosInscritos')
                ]);

                if (cursosError || alunosError) {
                    container.innerHTML = '<p>Error loading data.</p>';
                    return;
                }

                container.innerHTML = '';
                if (cursos.length === 0) { container.innerHTML = '<p class="text-center text-neutral-400 bg-neutral-800 p-6 rounded-lg">Nenhum curso.</p>'; return; }
                
                cursos.forEach(c => {
                    if (c.status === 'cancelado') return;
                    const alunosAprovados = todosAlunos.filter(a => Array.isArray(a.cursosInscritos) && a.cursosInscritos.some(i => i.cursoId == c.id && i.status === 'aprovado')).length;
                    const faturamento = alunosAprovados * parseFloat(c.preco);
                    const totalInscritos = todosAlunos.filter(a => Array.isArray(a.cursosInscritos) && a.cursosInscritos.some(i => i.cursoId == c.id && (i.status === 'aprovado' || i.status === 'pendente'))).length;
                    const cotaAtingida = totalInscritos >= c.cotaMinima;
                    const cotaStatusHtml = cotaAtingida 
                            ? `<span class="text-green-400 font-semibold"><i class="fas fa-check-circle mr-2"></i>Cota Atingida</span>`
                            : `<span class="text-yellow-400 font-semibold"><i class="fas fa-exclamation-triangle mr-2"></i>Aguardando Cota</span>`;

                    const statusInscricaoClass = c.statusInscricao === 'recebendo' ? 'bg-green-500' : 'bg-red-500';
                    let acoesCurso = `<button onclick="window.verInscritos(${c.id})" class="btn-secondary text-xs px-3 py-2 rounded-lg">Inscritos</button><button onclick="window.mudarStatusInscricaoCurso(${c.id})" class="btn-secondary text-xs px-3 py-2 rounded-lg">Mudar Status</button><button onclick="window.abrirModalCurso(${c.id})" class="btn-secondary text-xs px-3 py-2 rounded-lg"><i class="fas fa-edit"></i></button>`;
                    
                    let dataUltimaAulaDoCurso = null;
                    if (c.aulas && c.aulas.length > 0) {
                        const aulasOrdenadas = [...c.aulas].sort((a, b) => new Date(b.data) - new Date(a.data));
                        const dataUltimaAula = aulasOrdenadas[0].data;
                        dataUltimaAulaDoCurso = aulasOrdenadas[0].data; // Keep only the date part
                    }

                    if (!cotaAtingida && dataUltimaAulaDoCurso && new Date(dataUltimaAulaDoCurso) < new Date()) {
                        // REMOVIDO: Opção de Cancelar Curso e Reembolsar Alunos
                        // acoesCurso += `<button onclick="window.confirmarCancelamentoCurso(${c.id})" class="btn-danger text-white text-xs px-3 py-2 rounded-lg">Excluir curso e reembolsar alunos</button>`;
                        // Mantido apenas o botão de exclusão
                        acoesCurso += `<button onclick="window.confirmarExclusaoCurso(${c.id})" class="btn-danger text-white text-xs px-3 py-2 rounded-lg"><i class="fas fa-trash"></i></button>`;
                    } else {
                        acoesCurso += `<button onclick="window.confirmarExclusaoCurso(${c.id})" class="btn-danger text-white text-xs px-3 py-2 rounded-lg"><i class="fas fa-trash"></i></button>`;
                    }

                    container.innerHTML += `
                        <div class="glassmorphism p-4 rounded-lg flex flex-col md:flex-row items-center justify-between gap-4">
                            <div class="flex items-center gap-4 cursor-pointer" onclick="window.acessarCurso(${c.id})">
                                <img src="${c.imagem}" class="w-24 h-16 object-cover rounded-md">
                                <div>
                                    <h4 class="font-bold text-lg">${c.nomeDoCurso}</h4>
                                    <div class="flex items-center gap-4 text-sm mt-1">
                                        <p class="font-semibold ${cotaAtingida ? 'text-green-400' : 'text-yellow-400'}">Inscritos: ${totalInscritos} / ${c.cotaMinima}</p>
                                        <p>${cotaStatusHtml}</p>
                                    </div>
                                    <p class="text-sm text-green-400 font-semibold">Faturamento: R$ ${faturamento.toFixed(2).replace('.',',')}</p>
                                    <p class="text-sm text-neutral-300 flex items-center gap-2 mt-1"><span class="h-2 w-2 rounded-full ${statusInscricaoClass}"></span>${c.statusInscricao === 'recebendo' ? 'Recebendo inscrições' : 'Inscrições encerradas'}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 flex-wrap justify-center md:justify-end">${acoesCurso}</div>
                        </div>`;
                });
            } finally {
                window.hideLoader();
            }
        }
        window.renderizarPainelAdminAprovacoes = async function() {
            window.showLoader();
            try {
                const container = document.getElementById('listaAprovacoesAdmin');
                const [{ data: alunos, error: alunosError }, { data: cursos, error: cursosError }] = await Promise.all([
                    supabaseClient.from('alunos').select('*'),
                    supabaseClient.from('cursos').select('id, nomeDoCurso')
                ]);


                if (alunosError || cursosError) {
                console.error("Erro ao carregar dados:", alunosError || cursosError);
                container.innerHTML = '<p class="text-center text-red-400">Erro ao carregar aprovações.</p>';
                return;
                }

                container.innerHTML = ''; 
                let temPendente = false;
                alunos.forEach(aluno => {
                    if (Array.isArray(aluno.cursosInscritos)) {
                        aluno.cursosInscritos.filter(i => i.status === 'pendente').forEach(inscricao => {
                            temPendente = true; 
                            const curso = cursos.find(c => c.id == inscricao.cursoId);
                            if(curso){
                            let cupomLink = '';
                            if (inscricao.cupomAplicado) {
                                cupomLink = `<span class="text-xs text-indigo-400 ml-2">Cupom: ${inscricao.cupomAplicado}</span>`;
                            }

                            container.innerHTML += `<div class="glassmorphism p-4 rounded-lg flex flex-col md:flex-row items-center justify-between gap-4"><div><p><span class="font-bold">${aluno.nomeCompleto}</span> em <span class="text-indigo-400">${curso.nomeDoCurso}</span>.</p></div><div class="flex items-center gap-2 flex-wrap justify-center"><a href="${inscricao.comprovante}" target="_blank" class="btn-secondary px-4 py-1 rounded-lg">Comprovante Pagamento</a>${cupomLink}<button onclick="window.reprovarPagamento('${aluno.email}', ${curso.id})" class="btn-danger text-white px-4 py-1 rounded-lg">Reprovar</button><button onclick="window.aprovarPagamento('${aluno.email}', ${curso.id})" class="btn-success text-white px-4 py-1 rounded-lg">Aprovar</button></div></div>`;
                            }
                        });
                    }
                });
                if (!temPendente) { container.innerHTML = '<p class="text-center text-neutral-400 bg-neutral-800 p-6 rounded-lg">Nenhuma aprovação pendente.</p>'; }
            } finally {
                window.hideLoader();
            }
        }
        window.renderizarPainelAdminAlunos = async function() {
            window.showLoader();
            try {
                const container = document.getElementById('listaAlunosAdmin');
                const { data: alunos, error } = await supabaseClient.from('alunos').select('nomeCompleto, email');
                if (error) return;

                container.innerHTML = '';
                if (alunos.length === 0) { container.innerHTML = '<p class="text-center text-neutral-400 bg-neutral-800 p-6 rounded-lg">Nenhum aluno.</p>'; return; }
                alunos.forEach(a => { container.innerHTML += `<div class="glassmorphism p-4 rounded-lg flex items-center justify-between"><div><p class="font-bold">${a.nomeCompleto}</p><p class="text-sm text-neutral-400">${a.email}</p></div><div class="flex items-center gap-2"><button onclick="window.verDetalhes('aluno', '${a.email}')" class="btn-secondary px-4 py-2 rounded-lg">Detalhes</button><button onclick="window.confirmarExclusaoUsuario('aluno', '${a.email}')" class="btn-danger text-white px-4 py-2 rounded-lg"><i class="fas fa-trash"></i></button></div></div>`; });
            } finally {
                window.hideLoader();
            }
        }
        window.renderizarPainelAdminMinistrantes = async function() {
            window.showLoader();
            try {
                const container = document.getElementById('listaMinistrantesAdmin');
                const filtro = document.getElementById('buscaMinistrante').value.toLowerCase();
                const { data: ministrantes, error } = await supabaseClient.from('ministrantes').select('*');
                if(error) return;

                const ministrantesFiltrados = ministrantes.filter(m => {
                    const nome = m.nomeCompleto.toLowerCase();
                    const formacaoString = Object.values(m.formacao || {}).join(' ').toLowerCase();
                    return nome.includes(filtro) || formacaoString.includes(filtro);
                });

                container.innerHTML = '';
                if (ministrantesFiltrados.length === 0) { container.innerHTML = '<p class="text-center text-neutral-400 bg-neutral-800 p-6 rounded-lg">Nenhum ministrante encontrado.</p>'; return; }
                
                ministrantesFiltrados.forEach(m => { 
                    const titulos = Object.entries(m.formacao || {})
                        .filter(([key, value]) => value)
                        .map(([key, value]) => {
                            let tituloDisplay = key;
                            const isFeminino = isNomeFeminino(m.nomeCompleto);
                            if (key === 'mestreEm') tituloDisplay = isFeminino ? 'Mestra' : 'Mestre';
                            else if (key === 'doutorEm') tituloDisplay = isFeminino ? 'Doutora' : 'Doutor';
                            else tituloDisplay = key.replace('Em', '').replace(/([A-Z])/g, ' $1').trim();
                            return tituloDisplay;
                        })
                        .join(', ') || 'Nenhuma titulação informada';

                    container.innerHTML += `
                        <div class="glassmorphism p-4 rounded-lg flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                            <div>
                                <p class="font-bold">${m.nomeCompleto}</p>
                                <p class="text-sm text-neutral-400">${m.email}</p>
                                <p class="text-sm text-indigo-300 mt-1"><i class="fab fa-whatsapp mr-2"></i>${m.whatsapp}</p>
                                <p class="text-xs text-neutral-300 mt-1 capitalize"><i class="fas fa-graduation-cap mr-2"></i>${titulos}</p>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <button onclick="window.verDetalhes('ministrante', '${m.email}')" class="btn-secondary px-3 py-2 rounded-lg">Detalhes</button>
                                <button onclick="window.confirmarExclusaoUsuario('ministrante', '${m.email}')" class="btn-danger text-white px-3 py-2 rounded-lg"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`; 
                });
            } finally {
                window.hideLoader();
            }
        }

        window.renderizarPainelAdminReembolsos = async function() {
            const container = document.getElementById('listaReembolsosAdmin');
            if (container) {
                // REMOVIDO: Funcionalidade de Reembolsos do Painel Admin
                container.innerHTML = '<p class="text-center text-neutral-400 bg-neutral-800 p-6 rounded-lg">A gestão de reembolsos não está mais disponível neste painel.</p>';
            }
        }

        window.renderizarPainelAdminCertificados = async function() {
            window.showLoader();
            try {
                const container = document.getElementById('listaCursosCertificados');
                if(!container) return;

                const [{ data: cursos, error: cursosError }, { data: ministrantes, error: ministrantesError }] = await Promise.all([
                    supabaseClient.from('cursos').select('*'),
                    supabaseClient.from('ministrantes').select('*')
                ]);

                if(cursosError || ministrantesError) {
                    container.innerHTML = '<p class="text-center text-red-400">Erro ao carregar dados.</p>';
                    return;
                }

                if (cursos.length === 0) {
                    container.innerHTML = '<p class="text-center text-neutral-400 bg-neutral-800 p-6 rounded-lg">Nenhum curso cadastrado para gerir certificados.</p>';
                    return;
                }
                
                container.innerHTML = cursos.map(curso => {
                    const nomesMinistrantes = [...new Set(curso.aulas.flatMap(a => a.ministrantes))];
                    if (nomesMinistrantes.length === 0) return '';

                    const ministrantesHtml = nomesMinistrantes.map(nome => {
                        const ministrante = ministrantes.find(m => m.nomeCompleto === nome);
                        if (!ministrante) return '';

                        const vinculo = Array.isArray(ministrante.cursosVinculados) ? ministrante.cursosVinculados.find(v => v.cursoId == curso.id) : null;
                        const certButton = vinculo && vinculo.certificadoCodigo
                            ? `<button onclick="window.visualizarCertificado('ministrante', '${vinculo.certificadoCodigo}')" class="btn-success text-white text-xs px-2 py-1 rounded-lg">Ver</button>`
                            : `<button onclick="window.adminEmitirCertificado('ministrante', '${ministrante.email}', ${curso.id}, false)" class="btn-primary text-xs px-2 py-1 rounded-lg">Emitir</button>`;

                        return `<div class="flex justify-between items-center p-2 hover:bg-neutral-700/50 rounded-md">
                                    <span>${ministrante.nomeCompleto}</span>
                                    ${certButton}
                                </div>`;
                    }).join('');

                    return `<div class="glassmorphism p-4 rounded-lg">
                                <h4 class="font-bold text-lg mb-2 text-indigo-400">${curso.nomeDoCurso}</h4>
                                <div class="space-y-1">${ministrantesHtml}</div>
                            </div>`;

                }).join('');
            } finally {
                window.hideLoader();
            }
        }

        window.renderizarPainelAdminEmpresas = async function() {
            window.showLoader();
            try {
                const container = document.getElementById('listaEmpresasAdmin');
                const { data: alunos, error } = await supabaseClient.from('alunos').select('cnpjEmpresa');

                if(error) {
                    container.innerHTML = '<p class="text-center text-red-400">Erro ao carregar empresas.</p>';
                    return;
                }

                const empresasCnpjs = [...new Set(alunos.map(a => a.cnpjEmpresa).filter(Boolean))];

                if(empresasCnpjs.length === 0) {
                    container.innerHTML = '<p class="text-center text-neutral-400 bg-neutral-800 p-6 rounded-lg">Nenhum aluno vinculado a uma empresa.</p>';
                    return;
                }

                container.innerHTML = empresasCnpjs.map(cnpj => `
                    <div class="glassmorphism p-4 rounded-lg flex items-center justify-between">
                        <div>
                            <p class="font-bold">CNPJ: ${cnpj}</p>
                        </div>
                        <button onclick="window.verAlunosEmpresa('${cnpj}')" class="btn-secondary px-4 py-2 rounded-lg">Ver Alunos</button>
                    </div>
                `).join('');
            } finally {
                window.hideLoader();
            }
        }

        window.renderizarPainelAdminParceiros = async function() {
            window.showLoader();
            try {
                const container = document.getElementById('listaParceirosAdmin');
                const { data: parceiros, error } = await supabaseClient.from('parceiros').select('*');
                if (error) { throw error; }

                if (!parceiros || parceiros.length === 0) {
                    container.innerHTML = '<p class="text-center text-neutral-500 col-span-full">Nenhum parceiro cadastrado.</p>';
                    return;
                }
                
                container.innerHTML = parceiros.map(p => `
                    <div class="relative group">
                        <img src="${p.logoUrl}" alt="${p.nome}" class="w-full h-24 object-contain bg-neutral-800 p-2 rounded-lg">
                        <div class="absolute inset-0 bg-black/70 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="window.confirmarExclusaoParceiro(${p.id}, '${p.logoUrl}')" class="text-red-400 hover:text-red-300 text-2xl">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <p class="text-center text-xs mt-1 truncate">${p.nome}</p>
                    </div>
                `).join('');
            } catch (e) {
                console.error("Erro ao renderizar parceiros no admin:", e);
                document.getElementById('listaParceirosAdmin').innerHTML = '<p class="col-span-full text-red-500">Erro ao carregar parceiros.</p>';
            } finally {
                window.hideLoader();
            }
        }
        
        window.salvarParceiro = async function(event) {
            event.preventDefault();
            const form = event.target;
            const fileInput = form.querySelector('input[type="file"]');
            const file = fileInput.files[0];
            const nome = form.querySelector('input[type="text"]').value;

            if (!file || !nome) {
                window.mostrarModal("Nome e logo do parceiro são obrigatórios.");
                return;
            }

            window.showLoader();
            try {
                const filePath = `public/parceiro-${Date.now()}-${sanitizeFileName(file.name)}`;
                const { error: uploadError } = await supabaseClient.storage.from('logos-parceiros').upload(filePath, file);
                if (uploadError) {
                    handleStorageError(uploadError, 'logos-parceiros');
                    return;
                }

                const { data: { publicUrl } } = supabaseClient.storage.from('logos-parceiros').getPublicUrl(filePath);

                const { error: insertError } = await supabaseClient.from('parceiros').insert([{ nome: nome, logoUrl: publicUrl }]);
                if (insertError) { throw insertError; }

                window.mostrarModal("Parceiro adicionado com sucesso!");
                form.reset();
                await window.renderizarPainelAdminParceiros();
                await window.renderizarParceiros(); // Atualiza a tela inicial
            } catch (e) {
                console.error("Erro ao salvar parceiro:", e);
                window.mostrarModal("Erro ao salvar parceiro.");
            } finally {
                window.hideLoader();
            }
        }
        
        window.confirmarExclusaoParceiro = function(id, logoUrl) {
            window.mostrarConfirmacao("Tem certeza que deseja excluir este parceiro? O logo será removido permanentemente.", () => excluirParceiro(id, logoUrl));
        }

        async function excluirParceiro(id, logoUrl) {
            window.showLoader();
            try {
                // Deletar da tabela
                const { error: dbError } = await supabaseClient.from('parceiros').delete().eq('id', id);
                if (dbError) { throw dbError; }

                // Deletar do storage
                const urlParts = logoUrl.split('/logos-parceiros/');
                if (urlParts.length > 1) {
                    const filePath = urlParts[1];
                    await supabaseClient.storage.from('logos-parceiros').remove([filePath]);
                }
                
                window.mostrarModal("Parceiro excluído com sucesso!");
                await window.renderizarPainelAdminParceiros();
                await window.renderizarParceiros(); // Atualiza a tela inicial
            } catch(e) {
                console.error("Erro ao excluir parceiro:", e);
                window.mostrarModal("Erro ao excluir parceiro.");
            } finally {
                window.hideLoader();
            }
        }

        const gerarCodigo = () => Math.random().toString(36).substring(2, 8).toUpperCase();

        window.adicionarAulaBlock = async function(aula = {}) {
            const container = document.getElementById('aulasContainer');
            const { data: todosMinistrantes, error } = await supabaseClient.from('ministrantes').select('*');
            const aulaIndex = container.children.length;

            const ministrantesHtml = todosMinistrantes && todosMinistrantes.length > 0 ? todosMinistrantes.map(m => {
                const isChecked = aula.ministrantes && aula.ministrantes.includes(m.nomeCompleto);
                return `
                    <div class="flex items-center">
                        <input type="checkbox" id="ministrante_${aulaIndex}_${m.id}" name="aula_ministrantes_${aulaIndex}" value="${m.nomeCompleto}" ${isChecked ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="ministrante_${aulaIndex}_${m.id}" class="ml-2 text-sm text-neutral-300">${m.nomeCompleto}</label>
                    </div>
                `;
            }).join('') : '<p class="text-xs text-neutral-500 col-span-full">Nenhum ministrante cadastrado.</p>';

            const aulaBlock = document.createElement('div');
            aulaBlock.className = 'aula-block border-2 border-neutral-700 p-4 rounded-lg space-y-3 relative';
            aulaBlock.innerHTML = `
                <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-400 hover:text-red-300 text-2xl font-bold leading-none p-0">&times;</button>
                <h4 class="font-semibold text-indigo-400">Aula ${aulaIndex + 1}</h4>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                    <input type="text" name="aula_data_${aulaIndex}" placeholder="Data" value="${converterDataParaBR(aula.data || '')}" required class="w-full p-2 rounded-lg border-2" oninput="formatarData(event)" maxlength="10">
                    <input type="text" name="aula_horarioInicio_${aulaIndex}" placeholder="Horário de início" value="${aula.horarioInicio || ''}" required class="w-full p-2 rounded-lg border-2" oninput="formatarHorario(event)" maxlength="5">
                    <input type="text" name="aula_horarioFim_${aulaIndex}" placeholder="Horário de término" value="${aula.horarioFim || ''}" required class="w-full p-2 rounded-lg border-2" oninput="formatarHorario(event)" maxlength="5">
                </div>
                <input type="text" name="aula_titulo_${aulaIndex}" placeholder="Título da Aula" value="${aula.titulo || ''}" required class="w-full p-2 rounded-lg border-2">
                <textarea name="aula_topicos_${aulaIndex}" placeholder="Tópicos da Aula (separados por vírgula)" required class="w-full p-2 rounded-lg border-2" rows="2">${aula.topicos || ''}</textarea>
                <textarea name="aula_link_aluno_${aulaIndex}" placeholder="Link da Transmissão ou Código de Incorporação (para Alunos)" required class="w-full p-2 rounded-lg border-2" rows="3">${aula.linkDaAula || ''}</textarea>
                <textarea name="aula_link_ministrante_${aulaIndex}" placeholder="Link de Acesso ou Código de Incorporação (Ministrante/Admin)" required class="w-full p-2 rounded-lg border-2" rows="3">${aula.linkMinistrante || ''}</textarea>
                <div>
                     <label class="block mb-2 text-sm font-medium text-neutral-300">Códigos de Frequência</label>
                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <input type="text" name="aula_codigo1_${aulaIndex}" placeholder="Código 1" value="${(aula.codigosFrequencia && aula.codigosFrequencia.codigo1) || gerarCodigo()}" required class="w-full p-2 rounded-lg border-2 text-center font-mono">
                        <input type="text" name="aula_codigo2_${aulaIndex}" placeholder="Código 2" value="${(aula.codigosFrequencia && aula.codigosFrequencia.codigo2) || gerarCodigo()}" required class="w-full p-2 rounded-lg border-2 text-center font-mono">
                        <input type="text" name="aula_codigo3_${aulaIndex}" placeholder="Código 3" value="${(aula.codigosFrequencia && aula.codigosFrequencia.codigo3) || gerarCodigo()}" required class="w-full p-2 rounded-lg border-2 text-center font-mono">
                     </div>
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium text-neutral-300">Vincular Ministrantes</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-28 overflow-y-auto custom-scrollbar pr-2">
                        ${ministrantesHtml}
                    </div>
                </div>
            `;

            container.appendChild(aulaBlock);
        }
        
        // NOVO: Renderiza os campos de cupom no modal do curso (Admin)
        function renderizarCamposCupons(linksDePagamento = {}) {
            const container = document.getElementById('cuponsContainer');
            if (!container) return;
            container.innerHTML = '';

            DESCONTOS_CONFIG.forEach(config => {
                const percentual = config.percentual;
                const key = config.key;
                const cupomValue = linksDePagamento[key]?.cupom || '';
                const linkValue = linksDePagamento[key]?.link || '';
                const nomeDesconto = config.nome;

                // O preço normal (0%) não precisa de campo de cupom, apenas do link
                if (percentual === 0) {
                     container.innerHTML += `
                        <div class="border border-neutral-600 p-3 rounded-lg">
                            <p class="font-medium text-sm text-indigo-300 mb-2">${nomeDesconto}</p>
                            <input type="url" name="link_${percentual}" placeholder="Link de Pagamento para Preço Normal (Obrigatório)" value="${linkValue}" required class="w-full p-3 rounded-lg border-2">
                        </div>
                    `;
                } else {
                     container.innerHTML += `
                        <div class="border border-neutral-600 p-3 rounded-lg">
                            <p class="font-medium text-sm text-indigo-300 mb-2">${nomeDesconto}</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="text" name="cupom_${percentual}" placeholder="Cupom para ${percentual}% (Ex: PROMO${percentual})" value="${cupomValue}" class="w-full p-3 rounded-lg border-2 uppercase">
                                <input type="url" name="link_${percentual}" placeholder="Link de Pagamento para R$ ${percentual}%" value="${linkValue}" class="w-full p-3 rounded-lg border-2">
                            </div>
                        </div>
                    `;
                }
            });
        }


        window.abrirModalCurso = async function(cursoId = null) {
            window.showLoader();
            try {
                const form = document.getElementById('formCurso');
                form.reset();
                document.getElementById('previewImagemCurso').classList.add('hidden');
                document.getElementById('aulasContainer').innerHTML = '';
                
                let linksDePagamento = {};
                let curso = null;

                if(cursoId) {
                    document.getElementById('tituloModalCurso').innerText = 'Editar Curso';
                    const { data: cursoData, error } = await supabaseClient.from('cursos').select('*').eq('id', cursoId).single();
                    curso = cursoData;
                    if(curso) {
                        Object.keys(curso).forEach(key => { 
                            if(form[key] && key !== 'aulas' && key !== 'assinaturaAdmin' && key !== 'linksDePagamento') {
                                form[key].value = curso[key];
                            }
                        });
                        curso.aulas.forEach(async aula => await window.adicionarAulaBlock(aula));
                        linksDePagamento = curso.linksDePagamento || {};
                    }
                } else { 
                    document.getElementById('tituloModalCurso').innerText = 'Cadastrar Novo Curso'; 
                    await window.adicionarAulaBlock();
                }

                renderizarCamposCupons(linksDePagamento); // Renderiza os campos de cupom

                // Lógica da assinatura (SignaturePad)
                window.mostrarModal('', 'modalCurso');

                if (estado.signaturePad) { estado.signaturePad.off(); }
                const canvas = document.getElementById('assinaturaCanvas');

                function resizeCanvas() {
                    const ratio =  Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    if(estado.signaturePad) {
                        estado.signaturePad.clear();
                    }
                }
                
                estado.signaturePad = new SignaturePad(canvas, {
                    penColor: 'white'
                });
                resizeCanvas();
                window.addEventListener("resize", resizeCanvas);

                document.getElementById('limparAssinaturaBtn').onclick = () => { estado.signaturePad.clear(); };
                
                // CORREÇÃO DO ERRO: Verifica se o curso foi carregado e se a assinatura existe
                if(curso && curso.assinaturaAdmin && estado.signaturePad && curso.assinaturaAdmin.startsWith('data:image')) {
                    estado.signaturePad.fromDataURL(curso.assinaturaAdmin);
                }

            } finally {
                window.hideLoader();
            }
        }
        
        window.salvarCurso = async function(event) {
            event.preventDefault();
            window.showLoader();
            try {
                const form = event.target;
                const formData = new FormData(form);

                const file = formData.get('imagemUpload');
                const cursoId = formData.get('id');

                let cursoOriginal = {};
                if(cursoId) {
                    const { data } = await supabaseClient.from('cursos').select('*').eq('id', cursoId).single();
                    cursoOriginal = data || {};
                }

                let imagemFinal = cursoOriginal.imagem || null;
                if (file && file.size > 0) {
                    const filePath = `public/curso-${Date.now()}-${sanitizeFileName(file.name)}`;
                    const { error: uploadError } = await supabaseClient.storage.from('imagens-cursos').upload(filePath, file);
                    if (uploadError) {
                        handleStorageError(uploadError, 'imagens-cursos');
                        return;
                    }
                    const { data: { publicUrl } } = supabaseClient.storage.from('imagens-cursos').getPublicUrl(filePath);
                    imagemFinal = publicUrl;
                }
                
                if (!imagemFinal) {
                    window.mostrarModal("A imagem do curso é obrigatória.");
                    return;
                }

                let assinatura = cursoOriginal.assinaturaAdmin || '';
                if (estado.signaturePad && !estado.signaturePad.isEmpty()) {
                    assinatura = estado.signaturePad.toDataURL();
                } else if (!assinatura) {
                    window.mostrarModal("A assinatura do administrador é obrigatória.");
                    return;
                }
                
                // Coleta os dados de cupons/links
                const linksDePagamento = {};
                let precoNormalLinkConfigurado = false;

                DESCONTOS_CONFIG.forEach(config => {
                    const percentual = config.percentual;
                    const cupom = formData.get(`cupom_${percentual}`)?.trim();
                    const link = formData.get(`link_${percentual}`)?.trim();
                    
                    if (percentual === 0) {
                         if (link) {
                             linksDePagamento[config.key] = {
                                 cupom: '', // O preço normal não tem cupom, mas a chave é mantida
                                 link: link
                             };
                             precoNormalLinkConfigurado = true;
                         }
                    } else if (cupom && link) {
                        linksDePagamento[config.key] = {
                            cupom: cupom.toUpperCase(),
                            link: link
                        };
                    }
                });

                if (!precoNormalLinkConfigurado) {
                    window.mostrarModal("O link de pagamento de Preço Normal (0% de desconto) é obrigatório.");
                    return;
                }

                const novosDados = {
                    id: cursoId ? Number(cursoId) : undefined, // Supabase gera ID se for undefined
                    nomeDoCurso: formData.get('nomeDoCurso'),
                    preco: formData.get('preco'),
                    cotaMinima: formData.get('cotaMinima'),
                    linksDePagamento: linksDePagamento, // NOVO CAMPO SALVO
                    cargaHorariaAluno: formData.get('cargaHorariaAluno'),
                    cargaHorariaMinistrante: formData.get('cargaHorariaMinistrante'),
                    imagem: imagemFinal,
                    assinaturaAdmin: assinatura,
                    status: cursoOriginal.status || 'ativo',
                    statusInscricao: cursoOriginal.statusInscricao || 'recebendo',
                    aulas: []
                };
                
                // Remove propriedades não utilizadas do formulário antigo
                delete novosDados.linkPagamentoCartao; 
                
                const aulaBlocks = document.querySelectorAll('.aula-block');
                aulaBlocks.forEach((block, index) => {
                    const titulo = formData.get(`aula_titulo_${index}`);
                    if(titulo) {
                        novosDados.aulas.push({
                            data: converterDataParaISO(formData.get(`aula_data_${index}`)),
                            horarioInicio: formData.get(`aula_horarioInicio_${index}`),
                            horarioFim: formData.get(`aula_horarioFim_${index}`),
                            titulo,
                            topicos: formData.get(`aula_topicos_${index}`),
                            ministrantes: formData.getAll(`aula_ministrantes_${index}`),
                            linkDaAula: formData.get(`aula_link_aluno_${index}`),
                            linkMinistrante: formData.get(`aula_link_ministrante_${index}`),
                            codigosFrequencia: { 
                                codigo1: formData.get(`aula_codigo1_${index}`), 
                                codigo2: formData.get(`aula_codigo2_${index}`), 
                                codigo3: formData.get(`aula_codigo3_${index}`)
                            }
                        });
                    }
                });
                
                const { error } = await supabaseClient.from('cursos').upsert(novosDados, { onConflict: 'id' });

                if(error) {
                    window.mostrarModal("Erro ao salvar curso.");
                    console.error(error);
                    return;
                }
                
                window.fecharModal('modalCurso'); 
                await window.renderizarPainelAdminCursos(); 
                if (estado.usuarioLogado && estado.usuarioLogado.tipo === 'ministrante') {
                    await window.renderizarPainelMinistrante();
                }
                await window.renderizarCursos('listaCursosInicial');
                window.mostrarModal('Curso salvo!');
            } finally {
                window.hideLoader();
            }
        }
        window.confirmarExclusaoCurso = function(id) { window.mostrarConfirmacao('Deseja excluir este curso? Esta ação é irreversível.', () => excluirCurso(id)); }
        
        window.confirmarCancelamentoCurso = function(id) { 
            window.mostrarConfirmacao('Deseja cancelar este curso? Os alunos com pagamento aprovado ou pendente serão movidos para a fila de reembolso.', () => cancelarCurso(id)); 
        }

        async function cancelarCurso(id) {
            window.showLoader();
            try {
                // 1. Update course status
                const { error: cursoError } = await supabaseClient.from('cursos').update({ status: 'cancelado', statusInscricao: 'fechado' }).eq('id', id);
                if(cursoError) {
                    window.mostrarModal("Erro ao cancelar o curso.");
                    console.error(cursoError);
                    return;
                }
                
                // 2. Find all students and update their enrollment status
                // NOTA: A lógica de reembolso foi removida. Apenas o status é atualizado para 'reembolsado' para remover da lista.
                const { data: todosAlunos, error: alunosError } = await supabaseClient.from('alunos').select('*');
                if (alunosError) {
                    window.mostrarModal("Erro ao buscar alunos para reembolso.");
                    console.error(alunosError);
                    return;
                }
                
                const alunosAfetados = todosAlunos.filter(aluno =>
                    Array.isArray(aluno.cursosInscritos) &&
                    aluno.cursosInscritos.some(i => i.cursoId == id && (i.status === 'aprovado' || i.status === 'pendente'))
                );

                for (const aluno of alunosAfetados) {
                    const inscricaoIndex = aluno.cursosInscritos.findIndex(i => i.cursoId == id);
                    if (inscricaoIndex > -1) {
                        // Altera status para reembolsado (o usuário pediu para remover a gestão de reembolso)
                        aluno.cursosInscritos[inscricaoIndex].status = 'reembolsado'; 
                        await supabaseClient.from('alunos').update({ cursosInscritos: aluno.cursosInscritos }).eq('id', aluno.id);
                    }
                }

                window.mostrarModal('Curso cancelado com sucesso. Status de inscrições ativas alterado para "reembolsado".');
                await window.renderizarPainelAdminCursos();
            } finally {
                window.hideLoader();
            }
        }

        async function excluirCurso(id) { 
            window.showLoader();
            try {
                const { error } = await supabaseClient.from('cursos').update({ status: 'cancelado', statusInscricao: 'fechado' }).eq('id', id);
                if (error) {
                    window.mostrarModal("Erro ao excluir o curso.");
                    console.error(error);
                    return;
                }
                await window.renderizarPainelAdminCursos();
                window.mostrarModal('Curso excluído com sucesso.');
            } finally {
                window.hideLoader();
            }
        }
        window.mudarStatusInscricaoCurso = async function(id) { 
            const { data: curso } = await supabaseClient.from('cursos').select('statusInscricao').eq('id', id).single();
            const novoStatus = curso.statusInscricao === 'recebendo' ? 'fechado' : 'recebendo';
            await supabaseClient.from('cursos').update({ statusInscricao: novoStatus }).eq('id', id);
            await window.renderizarPainelAdminCursos(); 
        }
        window.aprovarPagamento = async function(email, cursoId) {
            const { data: aluno } = await supabaseClient.from('alunos').select('*').eq('email', email).single();
            const inscricoes = aluno.cursosInscritos;
            const inscricao = inscricoes.find(i => i.cursoId == cursoId);
            inscricao.status = 'aprovado';
            inscricao.aprovadoEm = new Date().toISOString();
            
            await supabaseClient.from('alunos').update({ cursosInscritos: inscricoes }).eq('id', aluno.id);
            await window.renderizarPainelAdminAprovacoes(); 
        }
        window.reprovarPagamento = async function(email, cursoId) { 
            const { data: aluno } = await supabaseClient.from('alunos').select('*').eq('email', email).single();
            const inscricoes = aluno.cursosInscritos;
            inscricoes.find(i => i.cursoId == cursoId).status = 'reprovado';
            await supabaseClient.from('alunos').update({ cursosInscritos: inscricoes }).eq('id', aluno.id);
            await window.renderizarPainelAdminAprovacoes();
        }
        
        window.verDetalhes = async function(tipo, email) {
            window.showLoader();
            try {
                const { data: usuario, error } = await supabaseClient.from(tipo + 's').select('*').eq('email', email).single();
                if (error || !usuario) return;

                const container = document.getElementById('conteudoModalDetalhes');
                
                let fotoHtml = `<img src="${usuario.fotoPerfil || 'https://placehold.co/128x128/171717/FFFFFF?text=?'}" class="w-24 h-24 rounded-full mx-auto mb-4 border-2 border-indigo-500 object-cover">`;

                if (tipo === 'ministrante' && usuario.fotoPerfil) {
                    fotoHtml = `
                        <div class="relative w-24 h-24 mx-auto mb-4 group">
                            <a href="${usuario.fotoPerfil}" download="foto_${usuario.nomeCompleto.replace(/\s/g, '_')}.jpg" title="Clique para baixar a imagem original">
                                <img src="${usuario.fotoPerfil}" class="w-24 h-24 rounded-full border-2 border-indigo-500 object-cover">
                                <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                                    <i class="fas fa-download text-white text-2xl"></i>
                                </div>
                            </a>
                        </div>`;
                }

                let html = `<div class="w-full max-w-lg mx-auto"><div class="text-center p-6">${fotoHtml}<h2 class="text-xl font-bold">${usuario.nomeCompleto}</h2><p class="text-sm text-neutral-400">${usuario.email}</p></div><div class="border-t border-neutral-700 px-6 py-4 space-y-2">`;
                for (const [key, value] of Object.entries(usuario)) {
                    // REMOVIDO: CAMPOS EXCLUÍDOS DO ALUNO (cep, dataNascimento, tipoPix, chavePix)
                    if (!['senha', 'fotoPerfil', 'formacao', 'cursosInscritos', 'cursosVinculados', 'contrato', 'id', 'email', 'nomeCompleto', 'cep', 'dataNascimento', 'tipoPix', 'chavePix'].includes(key) && typeof value !== 'object') {
                        html += `<p><strong class="font-semibold text-neutral-300 capitalize">${key.replace(/([A-Z])/g, ' $1')}:</strong> ${value || 'Não informado'}</p>`;
                    }
                }
                
                // Adiciona campos de PIX apenas para Ministrante
                if (tipo === 'ministrante' && usuario.tipoPix) {
                     html += `<p><strong class="font-semibold text-neutral-300">Chave PIX (${usuario.tipoPix}):</strong> ${usuario.chavePix || 'Não informado'}</p>`;
                }

                if (tipo === 'ministrante' && usuario.formacao) {
                    const titulos = {
                        graduadoEm: 'Graduado em',
                        especialistaEm: 'Especialista em',
                        mestreEm: 'Mestre em',
                        doutorEm: 'Doutor em',
                        posDoutorEm: 'Pós-Doutor em'
                    };
                    let hasFormation = false;
                    let formacaoHtml = '';
                    for (const [key, value] of Object.entries(usuario.formacao)) {
                        if (value) {
                            let tituloDisplay = titulos[key] || key;
                            // CORREÇÃO DE GÊNERO:
                            if (key === 'mestreEm') {
                                const isFeminino = isNomeFeminino(usuario.nomeCompleto);
                                tituloDisplay = isFeminino ? 'Mestra em' : 'Mestre em';
                            } else if (key === 'doutorEm') {
                                const isFeminino = isNomeFeminino(usuario.nomeCompleto);
                                tituloDisplay = isFeminino ? 'Doutora em' : 'Doutor em';
                            }
                            // FIM CORREÇÃO GÊNERO

                            formacaoHtml += `<p><strong class="font-semibold text-neutral-300 w-32 inline-block">${tituloDisplay}:</strong> <span>${value}</span></p>`;
                            hasFormation = true;
                        }
                    }

                    if (hasFormation) {
                        html += `<div class="border-t border-neutral-600 mt-4 pt-4">
                                    <h4 class="font-bold text-neutral-100 mb-2">Titulação Acadêmica</h4>
                                    <div class="space-y-1">${formacaoHtml}</div>
                                 </div>`;
                    }
                }

                if (tipo === 'ministrante') {
                    html += '</div><div class="border-t border-neutral-700 px-6 py-4"><h3 class="font-bold mb-2">Gestão de Contrato</h3>';
                    const c = usuario.contrato || {};

                    if (c.assinadoPeloMinistrante) {
                        html += `<div class="space-y-2">
                                    <p class="text-sm text-green-400 font-semibold"><i class="fas fa-check-circle mr-2"></i>Contrato Assinado</p>
                                    <a href="${c.assinadoPeloMinistrante}" target="_blank" rel="noopener noreferrer" download="contrato-assinado-${usuario.id}.pdf" class="btn-primary py-2 px-4 rounded-lg text-sm">Baixar Contrato Assinado</a>
                                </div>`;
                    } else if (c.enviadoPeloAdmin) {
                        html += `<div class="space-y-2">
                                    <p class="text-sm text-yellow-400 font-semibold"><i class="fas fa-clock mr-2"></i>Aguardando assinatura do ministrante.</p>
                                    <a href="${c.enviadoPeloAdmin}" target="_blank" rel="noopener noreferrer" download="contrato-enviado-${usuario.id}.pdf" class="btn-secondary py-2 px-4 rounded-lg text-sm">Baixar Contrato Enviado</a>
                                </div>`;
                    } else {
                        html += `<p class="text-sm text-neutral-400">Nenhum contrato foi enviado para este ministrante.</p>`;
                    }

                    html += `<div class="mt-4 pt-4 border-t border-neutral-600 flex items-center gap-2">
                                <label class="btn-primary py-2 px-4 rounded-lg cursor-pointer text-sm">
                                    ${c.enviadoPeloAdmin ? 'Substituir Contrato' : 'Enviar Contrato'}
                                    <input type="file" class="hidden" accept=".pdf" onchange="window.enviarContratoAdmin(event, '${email}')">
                                </label>
                                ${(c.enviadoPeloAdmin || c.assinadoPeloMinistrante) ? `<button onclick="window.confirmarExclusaoContrato('${email}')" class="btn-danger text-white py-2 px-4 rounded-lg text-sm">Excluir Contrato</button>` : ''}
                            </div>`;
                }

                html += `</div></div><div class="flex justify-end mt-6"><button onclick="window.fecharModal('modalDetalhes')" class="btn-secondary px-4 py-2 rounded-lg">Fechar</button></div>`;
                container.innerHTML = html;
                document.querySelector('#modalDetalhes .modal-content').style.maxWidth = '600px';
                window.mostrarModal('', 'modalDetalhes');
            } finally {
                window.hideLoader();
            }
        }
        
        window.verInscritos = async function(cursoId) {
            window.showLoader();
            try {
                const [{ data: curso, error: cursoError }, { data: todosAlunos, error: alunosError }] = await Promise.all([
                    supabaseClient.from('cursos').select('id, nomeDoCurso').eq('id', cursoId).single(),
                    supabaseClient.from('alunos').select('*')
                ]);

                if (cursoError || alunosError) {
                    window.mostrarModal("Erro ao carregar inscritos.");
                    return;
                }

                const alunosInscritos = todosAlunos.filter(aluno => Array.isArray(aluno.cursosInscritos) && aluno.cursosInscritos.some(i => i.cursoId == cursoId));
                
                const container = document.getElementById('conteudoModalDetalhes');
                let html = `<h2 class="text-xl font-bold mb-4 nexus-gradient-text">Inscritos em: ${curso.nomeDoCurso}</h2>`;

                if (alunosInscritos.length === 0) {
                    html += '<p>Nenhum aluno inscrito neste curso.</p>';
                } else {
                    html += '<div class="space-y-2">';
                    for (const aluno of alunosInscritos) {
                        const inscricao = aluno.cursosInscritos.find(i => i.cursoId == cursoId);
                        if(!inscricao) continue;

                        const statusClass = inscricao.status === 'aprovado' ? 'text-green-400' : (inscricao.status === 'pendente' ? 'text-yellow-400' : 'text-red-400');
                        
                        const { status: statusFrequencia, cor } = await calcularStatusFrequencia(aluno, curso.id);
                        const frequenciaHtml = `
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold ${cor}">${statusFrequencia}</span>
                                <button onclick="window.verFrequenciaDetalhada('${aluno.email}', ${curso.id})" class="btn-secondary text-xs px-2 py-1 rounded-md">Detalhes</button>
                            </div>`;
                        
                        let certButton = '';
                        if(inscricao.status === 'aprovado') {
                            certButton = inscricao.certificadoCodigo
                                ? `<button onclick="window.visualizarCertificado('aluno', '${inscricao.certificadoCodigo}')" class="btn-success text-white text-xs px-2 py-1 rounded-lg">Ver</button>`
                                : `<button onclick="window.adminEmitirCertificado('aluno', '${aluno.email}', ${curso.id}, true)" class="btn-primary text-xs px-2 py-1 rounded-lg">Liberar Certificado</button>`;
                        }

                        // Adiciona detalhes do cupom
                        let cupomInfo = '';
                        if (inscricao.cupomAplicado) {
                             cupomInfo = `<span class="text-xs text-neutral-400 ml-2">Cupom: ${inscricao.cupomAplicado}</span>`;
                        }


                        html += `
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center hover:bg-neutral-700 p-2 rounded-lg gap-2">
                                <div class="flex-grow">
                                    <span onclick="window.verDetalhes('aluno', '${aluno.email}')" class="cursor-pointer font-semibold">${aluno.nomeCompleto}</span>
                                    <div class="text-xs text-neutral-400 mt-1">Frequência Geral: ${frequenciaHtml}${cupomInfo}</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-semibold ${statusClass} w-24 text-center">${inscricao.status}</span>
                                    ${certButton}
                                    <!-- Botão de Remover Matrícula -->
                                    <button onclick="window.confirmarRemocaoMatricula('${aluno.email}', ${curso.id}, '${curso.nomeDoCurso}')" class="text-red-400 hover:text-red-300 text-sm px-2 py-1 rounded-lg" title="Remover Matrícula"><i class="fas fa-user-times"></i></button>
                                </div>
                            </div>`;
                    };
                    html += '</div>';
                }
                html += `<div class="flex justify-end mt-6"><button onclick="window.fecharModal('modalDetalhes')" class="btn-primary px-4 py-2 rounded-lg">Fechar</button></div>`;
                container.innerHTML = html;
                document.querySelector('#modalDetalhes .modal-content').style.maxWidth = '800px';
                window.mostrarModal('', 'modalDetalhes');
            } finally {
                window.hideLoader();
            }
        }

        window.verFrequenciaDetalhada = async function(alunoEmail, cursoId) {
            window.showLoader();
            try {
                const { data: aluno } = await supabaseClient.from('alunos').select('*').eq('email', alunoEmail).single();
                const { data: curso } = await supabaseClient.from('cursos').select('aulas').eq('id', cursoId).single();
                const inscricao = Array.isArray(aluno.cursosInscritos) ? aluno.cursosInscritos.find(i => i.cursoId == cursoId) : null;
                if(!inscricao) return;

                const container = document.getElementById('conteudoModalDetalhes');

                let html = `
                    <h2 class="text-xl font-bold mb-1 nexus-gradient-text">Controle de Frequência</h2>
                    <p class="text-neutral-300 mb-4">Aluno: <span class="font-semibold text-white">${aluno.nomeCompleto}</span></p>
                `;

                if (!curso.aulas || curso.aulas.length === 0) {
                    html += '<p>Este curso não possui aulas cadastradas.</p>';
                } else {
                    html += '<div class="space-y-3">';
                    curso.aulas.forEach((aula, index) => {
                        const registroAula = inscricao.frequencia[index] || {};
                        const codigosRegistrados = Object.keys(registroAula).length;
                        
                        let statusAula;
                        let corStatus;

                        if (codigosRegistrados >= 2) {
                            statusAula = 'Presente';
                            corStatus = 'text-green-400';
                        } else if (codigosRegistrados === 1) {
                            statusAula = 'Parcial';
                            corStatus = 'text-yellow-400';
                        } else {
                            statusAula = 'Faltou';
                            corStatus = 'text-red-400';
                        }
                        
                        const codigosDetalhes = `
                            <span class="${registroAula.codigo1 ? 'text-green-400' : 'text-neutral-500'}">C1</span> | 
                            <span class="${registroAula.codigo2 ? 'text-green-400' : 'text-neutral-500'}">C2</span> | 
                            <span class="${registroAula.codigo3 ? 'text-green-400' : 'text-neutral-500'}">C3</span>
                        `;

                        html += `
                            <div class="bg-neutral-800 p-3 rounded-lg flex justify-between items-center">
                                <div>
                                    <p class="font-semibold text-white">Aula ${index + 1}: ${aula.titulo}</p>
                                    <p class="text-xs text-neutral-400">${new Date(aula.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold ${corStatus}">${statusAula}</p>
                                    <p class="text-xs font-mono">${codigosDetalhes}</p>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                html += `
                    <div class="flex justify-end mt-6">
                        <button onclick="window.verInscritos(${cursoId})" class="btn-secondary px-4 py-2 rounded-lg">Voltar</button>
                    </div>`;

                container.innerHTML = html;
            } finally {
                window.hideLoader();
            }
        }

        window.enviarContratoAdmin = async function(event, email) {
            const file = event.target.files[0]; if(!file) return;
            window.showLoader();
            try {
                const filePath = `public/contrato-admin-${Date.now()}-${sanitizeFileName(file.name)}`;
                const { error: uploadError } = await supabaseClient.storage.from('contratos').upload(filePath, file);
                if(uploadError) {
                    handleStorageError(uploadError, 'contratos');
                    return;
                }
                const { data: { publicUrl } } = supabaseClient.storage.from('contratos').getPublicUrl(filePath);
                
                const { data: ministrante } = await supabaseClient.from('ministrantes').select('contrato').eq('email', email).single();
                const novoContrato = { ...(ministrante.contrato || {}), enviadoPeloAdmin: publicUrl, assinadoPeloMinistrante: null }; // Reset signed status on new upload

                await supabaseClient.from('ministrantes').update({ contrato: novoContrato }).eq('email', email);
                await window.verDetalhes('ministrante', email);
                window.mostrarModal("Contrato enviado com sucesso!");
            } finally {
                window.hideLoader();
            }
        }

        window.confirmarExclusaoUsuario = function(tipo, email) {
            window.mostrarConfirmacao(`Tem a certeza que deseja excluir este ${tipo}? Esta ação não pode ser revertida.`, () => excluirUsuario(tipo, email));
        }

        async function excluirUsuario(tipo, email) {
            window.showLoader();
            try {
                const { error } = await supabaseClient.from(tipo + 's').delete().eq('email', email);
                if (error) {
                    window.mostrarModal(`Erro ao excluir ${tipo}.`);
                    console.error(error);
                    return;
                }
                window.mostrarModal(`${tipo.charAt(0).toUpperCase() + tipo.slice(1)} excluído com sucesso.`);
                if (tipo === 'aluno') {
                    await window.renderizarPainelAdminAlunos();
                } else {
                    await window.renderizarPainelAdminMinistrantes();
                }
            } finally {
                window.hideLoader();
            }
        }

        window.confirmarExclusaoContrato = function(email) {
            window.mostrarConfirmacao('Tem a certeza que deseja excluir o contrato deste ministrante? Os arquivos enviados serão removidos permanentemente.', () => excluirContratoMinistrante(email));
        }

        async function excluirContratoMinistrante(email) {
            window.showLoader();
            try {
                const { data: ministrante, error: fetchError } = await supabaseClient.from('ministrantes').select('contrato').eq('email', email).single();
                if (fetchError || !ministrante || !ministrante.contrato) {
                    window.mostrarModal("Erro ao encontrar o contrato para excluir.");
                    return;
                }

                const { enviadoPeloAdmin, assinadoPeloMinistrante } = ministrante.contrato;
                const filesToDelete = [];

                if (enviadoPeloAdmin) {
                    const urlParts = enviadoPeloAdmin.split('/contratos/');
                    if (urlParts.length > 1) filesToDelete.push(urlParts[1]);
                }
                if (assinadoPeloMinistrante) {
                    const urlParts = assinadoPeloMinistrante.split('/contratos/');
                    if (urlParts.length > 1) filesToDelete.push(urlParts[1]);
                }

                if (filesToDelete.length > 0) {
                    const { error: storageError } = await supabaseClient.storage.from('contratos').remove(filesToDelete);
                    if (storageError && storageError.statusCode !== '404') {
                        // Log error but continue to update DB record
                        console.error("Erro ao excluir arquivos do Storage:", storageError);
                    }
                }

                const novoContrato = { status: 'pendente', enviadoPeloAdmin: null, assinadoPeloMinistrante: null };
                const { error: updateError } = await supabaseClient.from('ministrantes').update({ contrato: novoContrato }).eq('email', email);

                if (updateError) {
                    window.mostrarModal("Erro ao remover o registro do contrato do ministrante.");
                    console.error(updateError);
                    return;
                }

                window.mostrarModal("Contrato excluído com sucesso.");
                await window.verDetalhes('ministrante', email); // Refresh the modal view

            } finally {
                window.hideLoader();
            }
        }

        async function renderizarAreaFrequencia(cursoId) {
            const area = document.getElementById('areaFrequencia');
            if (!area) return;

            const { data: aluno } = await supabaseClient.from('alunos').select('*').eq('email', estado.usuarioLogado.email).single();
            const { data: curso } = await supabaseClient.from('cursos').select('aulas').eq('id', cursoId).single();
            
            const aulaIndex = estado.aulaSelecionadaIndex;
            const aula = curso.aulas[aulaIndex];
            if (!aula) {
                area.innerHTML = '<p>Aula não selecionada.</p>';
                return;
            }

            const agora = new Date();
            const inicioAula = new Date(`${aula.data}T${aula.horarioInicio}`);
            const fimAula = new Date(`${aula.data}T${aula.horarioFim}`);
            const isAulaAtiva = agora >= inicioAula && agora <= fimAula;
            const isDisabled = !isAulaAtiva;
            
            let mensagemFrequencia = '';
            let corMensagem = 'text-neutral-400';
            if (isDisabled) {
                if (agora < inicioAula) {
                    mensagemFrequencia = `A frequência para esta aula abrirá em ${inicioAula.toLocaleDateString('pt-BR')} às ${inicioAula.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}.`;
                    corMensagem = 'text-yellow-400';
                } else {
                    mensagemFrequencia = 'O período para registrar a frequência nesta aula já encerrou.';
                    corMensagem = 'text-red-400';
                }
            } else {
                mensagemFrequencia = 'O registro de frequência está aberto. Insira os códigos fornecidos pelo ministrante.';
                corMensagem = 'text-green-400';
            }
            
            const inscricao = aluno.cursosInscritos.find(i => i.cursoId == cursoId);
            const registroAula = (inscricao.frequencia && inscricao.frequencia[aulaIndex]) ? inscricao.frequencia[aulaIndex] : {};

            area.innerHTML = `
                <h3 class="text-xl font-bold mb-4">Registro de Frequência - Aula ${aulaIndex + 1}</h3>
                <p class="text-sm mb-6 ${corMensagem}">${mensagemFrequencia}</p>
                <div class="space-y-4 max-w-sm mx-auto">
                    <form onsubmit="window.registrarFrequencia(event, ${cursoId}, ${aulaIndex}, 'codigo1', '${aula.codigosFrequencia.codigo1}')" class="flex gap-2 items-center">
                        <input type="text" id="input-codigo1" placeholder="Código 1" class="w-full p-2 rounded-lg border-2 font-mono text-center" ${registroAula.codigo1 || isDisabled ? 'disabled' : ''} value="${registroAula.codigo1 ? 'REGISTRADO' : ''}">
                        <button type="submit" class="btn-primary px-4 py-2 rounded-lg" ${registroAula.codigo1 || isDisabled ? 'disabled' : ''}>${registroAula.codigo1 ? '<i class="fas fa-check"></i>' : 'Enviar'}</button>
                    </form>
                    <form onsubmit="window.registrarFrequencia(event, ${cursoId}, ${aulaIndex}, 'codigo2', '${aula.codigosFrequencia.codigo2}')" class="flex gap-2 items-center">
                        <input type="text" id="input-codigo2" placeholder="Código 2" class="w-full p-2 rounded-lg border-2 font-mono text-center" ${registroAula.codigo2 || isDisabled ? 'disabled' : ''} value="${registroAula.codigo2 ? 'REGISTRADO' : ''}">
                        <button type="submit" class="btn-primary px-4 py-2 rounded-lg" ${registroAula.codigo2 || isDisabled ? 'disabled' : ''}>${registroAula.codigo2 ? '<i class="fas fa-check"></i>' : 'Enviar'}</button>
                    </form>
                    <form onsubmit="window.registrarFrequencia(event, ${cursoId}, ${aulaIndex}, 'codigo3', '${aula.codigosFrequencia.codigo3}')" class="flex gap-2 items-center">
                        <input type="text" id="input-codigo3" placeholder="Código 3" class="w-full p-2 rounded-lg border-2 font-mono text-center" ${registroAula.codigo3 || isDisabled ? 'disabled' : ''} value="${registroAula.codigo3 ? 'REGISTRADO' : ''}">
                        <button type="submit" class="btn-primary px-4 py-2 rounded-lg" ${registroAula.codigo3 || isDisabled ? 'disabled' : ''}>${registroAula.codigo3 ? '<i class="fas fa-check"></i>' : 'Enviar'}</button>
                    </form>
                </div>
            `;
        }


        window.registrarFrequencia = async function(event, cursoId, aulaIndex, codigoKey, codigoCorreto) {
            event.preventDefault();
            const input = document.getElementById(`input-${codigoKey}`);
            const codigoDigitado = input.value.trim();

            if (codigoDigitado.toLowerCase() === codigoCorreto.toLowerCase()) {
                const { data: aluno } = await supabaseClient.from('alunos').select('*').eq('email', estado.usuarioLogado.email).single();
                const inscricoes = aluno.cursosInscritos;
                const inscricao = inscricoes.find(i => i.cursoId == cursoId);
                
                if (!inscricao.frequencia) inscricao.frequencia = {};
                if (!inscricao.frequencia[aulaIndex]) inscricao.frequencia[aulaIndex] = {};
                
                inscricao.frequencia[aulaIndex][codigoKey] = new Date().toISOString();

                const { error } = await supabaseClient.from('alunos').update({ cursosInscritos: inscricoes }).eq('id', aluno.id);

                if (error) {
                    window.mostrarModal("Erro ao registrar frequência.");
                    console.error(error);
                } else {
                    window.mostrarModal("Código registrado com sucesso!");
                    await renderizarAreaFrequencia(cursoId);
                }
            } else {
                window.mostrarModal("Código de frequência incorreto.");
            }
        }

        async function calcularStatusFrequencia(aluno, cursoId) {
            const { data: curso } = await supabaseClient.from('cursos').select('aulas').eq('id', cursoId).single();
            if (!curso || !curso.aulas || curso.aulas.length === 0) {
                return { status: 'N/A', cor: 'text-gray-400' };
            }
            
            const inscricao = Array.isArray(aluno.cursosInscritos) ? aluno.cursosInscritos.find(i => i.cursoId == cursoId) : null;
            if (!inscricao || !inscricao.frequencia) {
                return { status: 'Ausente', cor: 'text-red-400' };
            }

            let aulasPresente = 0;
            curso.aulas.forEach((aula, index) => {
                const registroAula = inscricao.frequencia[index] || {};
                if (Object.keys(registroAula).length >= 2) {
                    aulasPresente++;
                }
            });

            const percentual = (aulasPresente / curso.aulas.length) * 100;

            if (percentual >= 75) {
                return { status: 'Presente', cor: 'text-green-400' };
            } else if (percentual > 0) {
                return { status: 'Parcial', cor: 'text-yellow-400' };
            } else {
                return { status: 'Ausente', cor: 'text-red-400' };
            }
        }
        
        window.adminEmitirCertificado = async function(tipo, email, cursoId, comFrequencia) {
            const tabela = tipo + 's';
            const { data: usuario, error: userError } = await supabaseClient.from(tabela).select('*').eq('email', email).single();
            if (userError) {
                window.mostrarModal("Usuário não encontrado.");
                return;
            }

            if (tipo === 'aluno' && comFrequencia) {
                const { status } = await calcularStatusFrequencia(usuario, cursoId);
                if (status !== 'Presente') {
                    window.mostrarModal("A frequência do aluno não é suficiente para emitir o certificado.");
                    return;
                }
            }

            const codigo = `NEXUS-${tipo.substring(0,2).toUpperCase()}-${cursoId}-${usuario.id}`;

            if (tipo === 'aluno') {
                const inscricaoIndex = usuario.cursosInscritos.findIndex(i => i.cursoId == cursoId);
                if (inscricaoIndex > -1) {
                    usuario.cursosInscritos[inscricaoIndex].certificadoCodigo = codigo;
                    usuario.cursosInscritos[inscricaoIndex].certificadoEmitidoEm = new Date().toISOString();
                    
                    const { error } = await supabaseClient.from('alunos').update({ cursosInscritos: usuario.cursosInscritos }).eq('id', usuario.id);
                    if (error) { window.mostrarModal("Erro ao emitir certificado."); console.error(error); return; }
                }
            } else if (tipo === 'ministrante') {
                 let vinculos = Array.isArray(usuario.cursosVinculados) ? usuario.cursosVinculados : [];
                 let vinculo = vinculos.find(v => v.cursoId == cursoId);
                 if (vinculo) {
                     vinculo.certificadoCodigo = codigo;
                     vinculo.certificadoEmitidoEm = new Date().toISOString();
                 } else {
                     vinculos.push({
                         cursoId: cursoId,
                         certificadoCodigo: codigo,
                         certificadoEmitidoEm: new Date().toISOString()
                     });
                 }
                 const { error } = await supabaseClient.from('ministrantes').update({ cursosVinculados: vinculos }).eq('id', usuario.id);
                 if (error) { window.mostrarModal("Erro ao emitir certificado para ministrante."); console.error(error); return; }
            }

            window.mostrarModal("Certificado liberado com sucesso!");

            // Refresh the current view
            if (estado.telaAtual === 'painelAdmin' && document.getElementById('aba-gerenciarCertificados').classList.contains('border-indigo-500')) {
                await window.renderizarPainelAdminCertificados();
            } else if (estado.telaAtual === 'painelAdmin' && document.getElementById('conteudoModalDetalhes').innerHTML.includes('Alunos da Empresa')) {
                const cnpj = document.getElementById('conteudoModalDetalhes').dataset.cnpj;
                await window.verAlunosEmpresa(cnpj);
            }
             else {
                await window.verInscritos(cursoId);
            }
        }

        window.verAlunosEmpresa = async function(cnpj) {
            window.showLoader();
            try {
                const [{ data: alunos, error: alunosError }, { data: cursos, error: cursosError }] = await Promise.all([
                    supabaseClient.from('alunos').select('*').eq('cnpjEmpresa', cnpj),
                    supabaseClient.from('cursos').select('id, nomeDoCurso')
                ]);

                if (alunosError || cursosError) {
                    window.mostrarModal("Erro ao carregar dados da empresa.");
                    return;
                }

                const container = document.getElementById('conteudoModalDetalhes');
                container.dataset.cnpj = cnpj; // Store cnpj for refresh
                let html = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold nexus-gradient-text">Alunos da Empresa (CNPJ: ${cnpj})</h2>
                        <button id="btnImprimirTodos" onclick="window.imprimirCertificadosEmpresa('${cnpj}')" class="btn-success text-white px-4 py-2 rounded-lg">Imprimir Todos (PDF)</button>
                    </div>`;

                if (alunos.length === 0) {
                    html += '<p>Nenhum aluno encontrado para esta empresa.</p>';
                } else {
                    html += '<div class="space-y-4">';
                    for (const aluno of alunos) {
                        html += `<div class="bg-neutral-800 p-3 rounded-lg">
                                    <p class="font-bold text-white">${aluno.nomeCompleto}</p>`;
                        
                        if (Array.isArray(aluno.cursosInscritos) && aluno.cursosInscritos.length > 0) {
                            for (const inscricao of aluno.cursosInscritos) {
                                const cursoInfo = cursos.find(c => c.id === inscricao.cursoId);
                                if (cursoInfo) {
                                    const { status: statusFrequencia, cor } = await calcularStatusFrequencia(aluno, inscricao.cursoId);
                                    
                                    let certButton = '';
                                    // Certificate can only be issued if payment is approved and frequency is sufficient
                                    if (inscricao.status === 'aprovado' && statusFrequencia === 'Presente') {
                                        certButton = inscricao.certificadoCodigo
                                            ? `<button onclick="window.visualizarCertificado('aluno', '${inscricao.certificadoCodigo}')" class="btn-success text-white text-xs px-2 py-1 rounded-lg">Ver</button>`
                                            : `<button onclick="window.adminEmitirCertificado('aluno', '${aluno.email}', ${inscricao.cursoId}, true)" class="btn-primary text-xs px-2 py-1 rounded-lg">Emitir</button>`;
                                    }

                                    html += `
                                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mt-2 pl-4 text-sm border-l-2 border-neutral-700 ml-2 gap-2">
                                            <div class="flex-grow">
                                                <p class="text-neutral-300">${cursoInfo.nomeDoCurso}</p>
                                                <p class="text-xs">Frequência: <span class="font-semibold ${cor}">${statusFrequencia}</span></p>
                                            </div>
                                            <div class="w-24 text-right">${certButton}</div>
                                        </div>
                                    `;
                                }
                            }
                        } else {
                            html += '<p class="pl-4 text-sm text-neutral-500 mt-1">Nenhum curso matriculado.</p>';
                        }
                        html += `</div>`;
                    }
                    html += '</div>';
                }

                html += `<div class="flex justify-end mt-6"><button onclick="window.fecharModal('modalDetalhes')" class="btn-secondary px-4 py-2 rounded-lg">Fechar</button></div>`;
                container.innerHTML = html;
                document.querySelector('#modalDetalhes .modal-content').style.maxWidth = '800px';
                window.mostrarModal('', 'modalDetalhes');
            } finally {
                window.hideLoader();
            }
        }

        window.imprimirCertificadosEmpresa = async function(cnpj) {
            const btn = document.getElementById('btnImprimirTodos');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>A gerar...';
            window.showLoader();

            try {
                const { data: alunos } = await supabaseClient.from('alunos').select('*').eq('cnpjEmpresa', cnpj);
                
                const containerParaPdf = document.createElement('div');
                let algumCertificadoGerado = false;

                for (const aluno of alunos) {
                    if (Array.isArray(aluno.cursosInscritos)) {
                        for (const inscricao of aluno.cursosInscritos) {
                            if (inscricao.status === 'aprovado') {
                                const { status } = await calcularStatusFrequencia(aluno, inscricao.cursoId);
                                if (status === 'Presente') {
                                    let codigoCertificado = inscricao.certificadoCodigo;
                                    // Se não tiver código, emite silenciosamente
                                    if (!codigoCertificado) {
                                        const codigo = `NEXUS-AL-${inscricao.cursoId}-${aluno.id}`;
                                        const inscricaoIndex = aluno.cursosInscritos.findIndex(i => i.cursoId == inscricao.cursoId);
                                        aluno.cursosInscritos[inscricaoIndex].certificadoCodigo = codigo;
                                        aluno.cursosInscritos[inscricaoIndex].certificadoEmitidoEm = new Date().toISOString();
                                        await supabaseClient.from('alunos').update({ cursosInscritos: aluno.cursosInscritos }).eq('id', aluno.id);
                                        codigoCertificado = codigo;
                                    }
                                    // Gera o HTML do certificado e adiciona ao container
                                    const htmlCertificado = await gerarHtmlCertificado('aluno', codigoCertificado);
                                    const wrapper = document.createElement('div');
                                    wrapper.className = 'page-break';
                                    wrapper.innerHTML = htmlCertificado;
                                    containerParaPdf.appendChild(wrapper);
                                    algumCertificadoGerado = true;
                                }
                            }
                        }
                    }
                }

                if (!algumCertificadoGerado) {
                    window.mostrarModal("Nenhum aluno desta empresa está elegível para receber certificados no momento.");
                    return;
                }

                const opt = {
                    margin: 0,
                    filename: `certificados_empresa_${cnpj}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, backgroundColor: null },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'landscape' }
                };
                await html2pdf().set(opt).from(containerParaPdf).save();
                
                // Atualiza a vista para mostrar os botões "Ver"
                window.verAlunosEmpresa(cnpj);
            } finally {
                btn.disabled = false;
                btn.innerText = 'Imprimir Todos (PDF)';
                window.hideLoader();
            }
        }
        
        // ===================================================
        // NOVA FUNÇÃO: REMOVER MATRÍCULA
        // ===================================================
        window.confirmarRemocaoMatricula = function(alunoEmail, cursoId, cursoNome) {
            window.mostrarConfirmacao(`Tem certeza que deseja remover a matrícula de **${alunoEmail}** do curso **${cursoNome}**? O aluno perderá acesso, e esta ação é irreversível.`, () => removerMatricula(alunoEmail, cursoId));
        }

        async function removerMatricula(alunoEmail, cursoId) {
            window.showLoader();
            try {
                // 1. Busca o aluno e as inscrições
                const { data: aluno, error: fetchError } = await supabaseClient
                    .from('alunos')
                    .select('id, cursosInscritos')
                    .eq('email', alunoEmail)
                    .single();

                if (fetchError || !aluno) {
                    window.mostrarModal(`Erro ao encontrar o aluno.`);
                    return;
                }
                
                const inscricoes = aluno.cursosInscritos || [];
                
                // 2. Remove o curso da lista
                const novasInscricoes = inscricoes.filter(i => i.cursoId != cursoId);

                if (novasInscricoes.length === inscricoes.length) {
                    window.mostrarModal("O aluno não estava matriculado neste curso ou a matrícula não foi encontrada.");
                    return;
                }

                // 3. Atualiza o registro do aluno
                const { error: updateError } = await supabaseClient
                    .from('alunos')
                    .update({ cursosInscritos: novasInscricoes })
                    .eq('id', aluno.id);

                if (updateError) {
                    window.mostrarModal("Erro ao remover a matrícula do aluno.");
                    console.error("Erro Supabase ao remover matrícula:", updateError);
                    return;
                }
                
                window.mostrarModal(`Matrícula removida com sucesso para o aluno ${alunoEmail}.`);
                
                // 4. Atualiza a lista de inscritos no modal
                await window.verInscritos(cursoId);

            } catch (e) {
                window.mostrarModal("Ocorreu um erro inesperado ao tentar remover a matrícula.");
                console.error("Erro na função removerMatricula:", e);
            } finally {
                window.hideLoader();
            }
        }
        // ===================================================
        // FIM: NOVA FUNÇÃO: REMOVER MATRÍCULA
        // ===================================================


        // ===================================================
        // INICIALIZAÇÃO E EVENT LISTENERS
        // ===================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Verifica as variáveis de ambiente Canvas
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (!SUPABASE_URL || !SUPABASE_KEY) {
                // Mantém a lógica de Supabase se não estiver usando Firebase
                window.mostrarModal("CONFIGURAÇÃO NECESSÁRIA: As credenciais do Supabase não foram encontradas. Por favor, adicione as variáveis SUPABASE_URL e SUPABASE_KEY no seu ficheiro HTML.");
                return;
            }
            // Inicialização Supabase
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // Login com a tecla Enter
            document.getElementById('loginSenhaAluno').addEventListener('keydown', e => { if (e.key === 'Enter') window.loginAluno(); });
            document.getElementById('loginSenhaMinistrante').addEventListener('keydown', e => { if (e.key === 'Enter') window.loginMinistrante(); });
            document.getElementById('loginSenhaAdmin').addEventListener('keydown', e => { if (e.key === 'Enter') window.loginAdmin(); });


            verificarSessao();
            if (!estado.usuarioLogado) { 
                window.renderizarCursos('listaCursosInicial'); 
                window.renderizarParceiros();
            }
            const previews = { 
                'fotoPerfilAluno': 'previewFotoAluno', 
                'fotoPerfilMinistrante': 'previewFotoMinistrante', 
                'comprovantePagamento': 'previewComprovante', 
                // Removido 'comprovanteCupom'
                'imagemUploadCurso': 'previewImagemCurso' 
            };
            Object.entries(previews).forEach(([inputId, previewId]) => {
                const inputElement = document.getElementById(inputId);
                if (inputElement) {
                    inputElement.addEventListener('change', function(event){
                        window.previewImagem(event, previewId);
                    });
                }
            });
            window.addEventListener('resize', () => {
                if(estado.telaAtual === 'telaCurso' && estado.signaturePad) {
                    // Logic to resize canvas if needed
                }
            });
        });

    </script>

</body>
</html>
